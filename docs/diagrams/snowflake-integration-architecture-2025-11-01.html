<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowflake Integration Architecture - Olorin Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .metadata {
            background: #f8fafc;
            padding: 20px 40px;
            border-bottom: 2px solid #e2e8f0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metadata-label {
            font-weight: 600;
            color: #1e3a8a;
        }

        .metadata-value {
            color: #64748b;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 2em;
            color: #1e3a8a;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3b82f6;
        }

        .section-description {
            font-size: 1.1em;
            color: #475569;
            margin-bottom: 25px;
            padding: 15px;
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }

        .diagram-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .diagram-title {
            font-size: 1.3em;
            color: #1e40af;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .feature-item {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .feature-title {
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .feature-desc {
            color: #64748b;
            font-size: 0.95em;
        }

        .warning-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }

        .warning-title {
            color: #92400e;
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .warning-content {
            color: #78350f;
        }

        .success-box {
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }

        .success-title {
            color: #065f46;
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .success-content {
            color: #047857;
        }

        .footer {
            background: #1e293b;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 50px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .section-title {
                font-size: 1.5em;
            }
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèîÔ∏è Snowflake Integration Architecture</h1>
            <p>Comprehensive Analysis of Olorin Fraud Detection Platform</p>
        </div>

        <!-- Metadata -->
        <div class="metadata">
            <div class="metadata-item">
                <span class="metadata-label">üìÖ Date:</span>
                <span class="metadata-value">November 1, 2025</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">üë§ Author:</span>
                <span class="metadata-value">Gil Klainert</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">üìä Schema Columns:</span>
                <span class="metadata-value">333 Columns</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">üîí Mode:</span>
                <span class="metadata-value">Schema-Locked (SELECT-only)</span>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Key Statistics -->
            <div class="section">
                <h2 class="section-title">üìä Key Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">333</div>
                        <div class="stat-label">Schema Columns</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">5,000+</div>
                        <div class="stat-label">Sample Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">11</div>
                        <div class="stat-label">Evidence Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">7</div>
                        <div class="stat-label">Default Lookback Days</div>
                    </div>
                </div>
            </div>

            <!-- System Architecture -->
            <div class="section">
                <h2 class="section-title">üèóÔ∏è System Architecture Overview</h2>
                <div class="section-description">
                    The Snowflake integration follows a layered architecture with AI investigation agents, query builders, async client layer, and cloud data warehouse. All components are configuration-driven with comprehensive validation.
                </div>
                <div class="diagram-container">
                    <div class="diagram-title">Complete Integration Architecture</div>
                    <div class="mermaid">
graph TB
    subgraph "Investigation Layer"
        A[Olorin Investigation System]
        B[LangChain AI Agents]
    end

    subgraph "Tool Layer"
        C[Snowflake Query Tool]
        D[Query Validation]
        E[Auto-Correction]
        F[Evidence Selection]
    end

    subgraph "Query Builder Layer"
        G[Query Builder]
        H[Schema Constants<br/>333 Columns]
        I[Entity Detection]
        J[Field Optimization]
    end

    subgraph "Client Layer"
        K[Async Client<br/>ThreadPoolExecutor]
        L[Connection Pool]
        M[Timeout Management]
        N[Security Validation]
    end

    subgraph "Snowflake Cloud"
        O[(FRAUD_ANALYTICS DB)]
        P[TRANSACTIONS_ENRICHED<br/>333 Columns]
        Q[COMPUTE_WH<br/>X-SMALL]
        R[FRAUD_ANALYST_ROLE<br/>SELECT-only]
    end

    A --> B
    B --> C
    C --> D
    C --> E
    C --> F
    F --> G
    G --> H
    G --> I
    G --> J
    G --> K
    K --> L
    K --> M
    K --> N
    N --> O
    O --> P
    O --> Q
    O --> R

    style A fill:#3b82f6,stroke:#1e40af,color:#fff
    style B fill:#3b82f6,stroke:#1e40af,color:#fff
    style C fill:#10b981,stroke:#059669,color:#fff
    style O fill:#f59e0b,stroke:#d97706,color:#fff
    style P fill:#f59e0b,stroke:#d97706,color:#fff
                    </div>
                </div>
            </div>

            <!-- Evidence Categories -->
            <div class="section">
                <h2 class="section-title">üîç Evidence Categories (333 Columns)</h2>
                <div class="section-description">
                    The schema is organized into 11 evidence categories providing comprehensive fraud detection coverage across all investigation domains.
                </div>
                <div class="diagram-container">
                    <div class="diagram-title">Schema Organization by Evidence Domain</div>
                    <div class="mermaid">
pie title "333 Column Distribution by Evidence Category"
    "Identity Fields" : 44
    "Payment Fields" : 38
    "Network Fields" : 33
    "Metadata Fields" : 26
    "Fraud Fields" : 23
    "Cart & Product" : 19
    "KYC Fields" : 18
    "Risk Fields" : 15
    "Device Fields" : 13
    "Transaction" : 11
    "Dispute Fields" : 10
    "Business Fields" : 9
    "Other Fields" : 44
                    </div>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <div class="feature-title">üÜî Identity Fields (44)</div>
                        <div class="feature-desc">Email, personal info, user IDs, email validation, recipient information</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üí≥ Payment Fields (38)</div>
                        <div class="feature-desc">Card details, payment methods, 3D Secure, PayPal, transaction amounts</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üåê Network Fields (33)</div>
                        <div class="feature-desc">IP data, ISP, ASN, risk scores, dispute data, PIPL information</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">‚ö†Ô∏è Fraud Fields (23)</div>
                        <div class="feature-desc">Fraud status, decisions, triggered rules, review flags, segmentation</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üìä Risk Fields (15)</div>
                        <div class="feature-desc">Model scores, MaxMind scores, fraud probability, feature flags</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üì± Device Fields (13)</div>
                        <div class="feature-desc">Device ID, user agent, OS, model, authentication status</div>
                    </div>
                </div>
            </div>

            <!-- Investigation Workflow -->
            <div class="section">
                <h2 class="section-title">üîÑ Investigation Workflow</h2>
                <div class="section-description">
                    Snowflake analysis is a MANDATORY phase in every investigation. The handler orchestrates the complete workflow from query generation to evidence extraction.
                </div>
                <div class="diagram-container">
                    <div class="diagram-title">Investigation Phase Flow</div>
                    <div class="mermaid">
sequenceDiagram
    participant Inv as Investigation
    participant Orch as Orchestrator
    participant SF as Snowflake Handler
    participant Tool as Query Tool
    participant Client as Async Client
    participant DB as Snowflake DB

    Inv->>Orch: Start Investigation
    Orch->>SF: Check Snowflake Phase
    SF->>SF: Check Completion Status

    alt Not Completed
        SF->>SF: Check Existing Results
        alt No Results
            SF->>Tool: Generate Tool Call
            Tool->>Tool: Validate Query
            Tool->>Tool: Auto-Correct Columns
            Tool->>Client: Execute Query
            Client->>DB: SELECT with Evidence Fields
            DB-->>Client: Return Results (max 10k rows)
            Client-->>Tool: Query Response
            Tool-->>SF: Parsed Evidence
            SF->>SF: Mark snowflake_completed=true
        end
    end

    SF-->>Orch: Snowflake Analysis Complete
    Orch->>Orch: Transition to tool_execution
                    </div>
                </div>
            </div>

            <!-- Data Flow -->
            <div class="section">
                <h2 class="section-title">üìà Query Execution Data Flow</h2>
                <div class="section-description">
                    Queries flow through multiple validation and optimization layers before execution, ensuring security, performance, and evidence quality.
                </div>
                <div class="diagram-container">
                    <div class="diagram-title">Query Processing Pipeline</div>
                    <div class="mermaid">
flowchart LR
    A[Investigation Request] --> B{Entity Type<br/>Detection}
    B -->|EMAIL| C[Email Query Pattern]
    B -->|IP| D[IP Query Pattern]
    B -->|DEVICE_ID| E[Device Query Pattern]
    B -->|MULTI| F[Multi-Entity Pattern]

    C --> G[Query Builder]
    D --> G
    E --> G
    F --> G

    G --> H{Evidence<br/>Focus}
    H -->|Priority| I[Core 30 Fields]
    H -->|Comprehensive| J[All 333 Fields]

    I --> K[Schema Validation]
    J --> K

    K --> L{Query<br/>Validation}
    L -->|Invalid| M[Auto-Correction]
    M --> L
    L -->|Valid| N[Security Check]

    N --> O{Dangerous<br/>Keywords?}
    O -->|Yes| P[REJECT]
    O -->|No| Q[Add LIMIT Clause]

    Q --> R[Async Execution]
    R --> S[(Snowflake<br/>Database)]
    S --> T[Parse Results]
    T --> U[Evidence Extraction]

    style A fill:#3b82f6,stroke:#1e40af,color:#fff
    style S fill:#f59e0b,stroke:#d97706,color:#fff
    style P fill:#ef4444,stroke:#dc2626,color:#fff
    style U fill:#10b981,stroke:#059669,color:#fff
                    </div>
                </div>
            </div>

            <!-- Component Interactions -->
            <div class="section">
                <h2 class="section-title">üîó Component Interactions</h2>
                <div class="section-description">
                    The integration components work together to provide seamless fraud detection analytics with comprehensive validation and security controls.
                </div>
                <div class="diagram-container">
                    <div class="diagram-title">Component Interaction Diagram</div>
                    <div class="mermaid">
graph LR
    subgraph "Configuration Layer"
        CFG[Config Loader]
        ENV[.env File]
        FB[Firebase Secrets]
    end

    subgraph "Tool Registry"
        REG[Tool Registry]
        SF_TOOL[Snowflake Tool]
    end

    subgraph "Query Layer"
        QB[Query Builder]
        SC[Schema Constants]
        VAL[Validator]
    end

    subgraph "Execution Layer"
        RC[Real Client]
        MC[Mock Client]
        POOL[Connection Pool]
    end

    subgraph "Handler Layer"
        SFH[Snowflake Handler]
        MB[Message Builder]
        PG[Prompt Generator]
        DP[Data Parser]
    end

    ENV --> CFG
    FB --> CFG
    CFG --> RC
    CFG --> MC

    REG --> SF_TOOL
    SF_TOOL --> QB
    QB --> SC
    QB --> VAL

    SF_TOOL --> RC
    RC --> POOL

    SFH --> MB
    SFH --> PG
    SFH --> DP
    SFH --> SF_TOOL

    style CFG fill:#3b82f6,stroke:#1e40af,color:#fff
    style SF_TOOL fill:#10b981,stroke:#059669,color:#fff
    style SFH fill:#f59e0b,stroke:#d97706,color:#fff
                    </div>
                </div>
            </div>

            <!-- Key Features -->
            <div class="section">
                <h2 class="section-title">‚ú® Key Integration Features</h2>
                <div class="success-box">
                    <div class="success-title">‚úÖ Strengths</div>
                    <div class="success-content">
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Comprehensive Schema</strong>: 333 columns covering all fraud detection domains</li>
                            <li><strong>Schema-Locked Mode</strong>: Strong data integrity and security (SELECT-only)</li>
                            <li><strong>LangChain Integration</strong>: Seamless AI agent investigation workflows</li>
                            <li><strong>Query Validation</strong>: Multi-layer validation prevents errors and security issues</li>
                            <li><strong>Async Architecture</strong>: Scalable async execution with connection pooling</li>
                            <li><strong>Evidence-Driven</strong>: Organized field sets for optimal investigation performance</li>
                            <li><strong>Auto-Correction</strong>: Intelligent query correction for common column name mistakes</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Critical Issues -->
            <div class="section">
                <h2 class="section-title">‚ö†Ô∏è Critical Issues & Recommendations</h2>
                <div class="warning-box">
                    <div class="warning-title">üö® High Priority Issues</div>
                    <div class="warning-content">
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Data Completeness</strong>: 38 columns with 0% data across 5,000 records - Execute population script</li>
                            <li><strong>SSL Security</strong>: insecure_mode=True in production - Fix SSL handshake issues immediately</li>
                            <li><strong>Documentation</strong>: Missing .env.example entries and setup guides</li>
                            <li><strong>Testing</strong>: No integration tests for Snowflake client - Add comprehensive test coverage</li>
                        </ul>
                    </div>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <div class="feature-title">üìù Documentation Gaps</div>
                        <div class="feature-desc">Add Snowflake section to .env.example, create setup guide, document all environment variables</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üîí Security Concerns</div>
                        <div class="feature-desc">Remove insecure_mode, configure proper SSL certificates, add SSL verification tests</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üìä Data Population</div>
                        <div class="feature-desc">Execute snowflake_data_population.sql to fill 38 missing columns with realistic data</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üß™ Testing Coverage</div>
                        <div class="feature-desc">Add integration tests, mock server for unit tests, schema validation tests, failure recovery tests</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üîÑ Schema Evolution</div>
                        <div class="feature-desc">Implement automated schema discovery, version tracking, migration validation, drift alerts</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üìà Performance Monitoring</div>
                        <div class="feature-desc">Add query metrics collection, slow query identification, optimization recommendations, dashboards</div>
                    </div>
                </div>
            </div>

            <!-- Configuration -->
            <div class="section">
                <h2 class="section-title">‚öôÔ∏è Configuration Requirements</h2>
                <div class="diagram-container">
                    <div class="diagram-title">Configuration Loading Flow</div>
                    <div class="mermaid">
flowchart TD
    A[Application Startup] --> B{Check .env File}
    B -->|Exists| C[Load from .env]
    B -->|Missing| D{Check Firebase Secrets}

    D -->|Available| E[Load from Firebase]
    D -->|Not Available| F[Fail Fast]

    C --> G[Validate with Zod Schema]
    E --> G

    G -->|Valid| H[Initialize Snowflake Client]
    G -->|Invalid| I[Log Errors & Exit]

    H --> J[Test Connection]
    J -->|Success| K[Ready for Queries]
    J -->|Failure| L[Retry with Backoff]

    L -->|Max Retries| M[Alert & Fallback]

    style A fill:#3b82f6,stroke:#1e40af,color:#fff
    style K fill:#10b981,stroke:#059669,color:#fff
    style F fill:#ef4444,stroke:#dc2626,color:#fff
    style I fill:#ef4444,stroke:#dc2626,color:#fff
    style M fill:#f59e0b,stroke:#d97706,color:#fff
                    </div>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <div class="feature-title">üîë Required Variables</div>
                        <div class="feature-desc">SNOWFLAKE_ACCOUNT, USER, PASSWORD, DATABASE, SCHEMA, WAREHOUSE, TRANSACTIONS_TABLE</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üéõÔ∏è Optional Settings</div>
                        <div class="feature-desc">ROLE, AUTHENTICATOR, POOL_SIZE, POOL_MAX_OVERFLOW, POOL_TIMEOUT, QUERY_TIMEOUT</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">üîê Secret Management</div>
                        <div class="feature-desc">Firebase Secret Manager fallback for PASSWORD and sensitive credentials</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-title">‚úÖ Validation</div>
                        <div class="feature-desc">Fail-fast on missing critical config, comprehensive schema validation with Zod</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>Olorin Fraud Detection Platform</strong></p>
            <p>Snowflake Integration Analysis ‚Ä¢ November 1, 2025 ‚Ä¢ Author: Gil Klainert</p>
            <p style="margin-top: 10px; opacity: 0.8;">
                üìÑ Full Report: <code>/docs/analysis/snowflake-integration-analysis-2025-11-01.md</code>
            </p>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#fff',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b'
            },
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });
    </script>
</body>
</html>
