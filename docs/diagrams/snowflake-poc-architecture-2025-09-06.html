<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowflake POC Architecture - Olorin Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            margin: 20px 0;
        }
        
        h1 {
            color: #2d3748;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #4a5568;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 4px solid #764ba2;
            padding-left: 15px;
        }
        
        .diagram-container {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
            border: 2px solid #e2e8f0;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .info-card h3 {
            margin-top: 0;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .info-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .phase-timeline {
            display: flex;
            justify-content: space-between;
            margin: 40px 0;
            position: relative;
        }
        
        .phase-timeline::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 2px;
            background: #cbd5e0;
            z-index: 0;
        }
        
        .phase-item {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .phase-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
        }
        
        .phase-item.completed .phase-circle {
            background: #667eea;
            color: white;
        }
        
        .feature-list {
            background: #edf2f7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .feature-list h3 {
            color: #2d3748;
            margin-top: 0;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .config-example {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .config-example pre {
            margin: 0;
        }
        
        .mermaid {
            text-align: center;
        }
    </style>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#764ba2',
                lineColor: '#764ba2',
                secondaryColor: '#f7fafc',
                tertiaryColor: '#edf2f7'
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>üèîÔ∏è Snowflake POC Implementation Architecture</h1>
        <p><strong>Project:</strong> Olorin Fraud Detection Platform | <strong>Author:</strong> Gil Klainert | <strong>Date:</strong> 2025-09-06</p>
        
        <div class="info-grid">
            <div class="info-card">
                <h3>üìä Core Objectives</h3>
                <ul>
                    <li>200+ column Snowflake table</li>
                    <li>Real database connectivity</li>
                    <li>.env configuration migration</li>
                    <li>Configurable risk analytics</li>
                    <li>Production-ready implementation</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>üîß Technical Stack</h3>
                <ul>
                    <li>Snowflake Data Warehouse</li>
                    <li>Python snowflake-connector</li>
                    <li>AsyncIO for performance</li>
                    <li>Environment-based config</li>
                    <li>Connection pooling</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>‚ö° Key Features</h3>
                <ul>
                    <li>Configurable time windows</li>
                    <li>Dynamic grouping (email, device)</li>
                    <li>Risk-weighted calculations</li>
                    <li>Top percentage filtering</li>
                    <li>Auto-load on startup</li>
                </ul>
            </div>
        </div>

        <h2>System Architecture Overview</h2>
        <div class="diagram-container">
            <div class="mermaid">
graph TB
    subgraph "Olorin Application"
        A[Application Startup] --> B[ConfigLoader]
        B --> C[.env File]
        C --> D[Snowflake Config]
        D --> E[SnowflakeClient]
        E --> F[Connection Pool]
    end
    
    subgraph "Snowflake Cloud"
        G[(FRAUD_ANALYTICS DB)]
        H[TRANSACTIONS_ENRICHED Table]
        I[200+ Columns Schema]
        G --> H
        H --> I
    end
    
    subgraph "Analytics Engine"
        J[RiskAnalyzer]
        K[Query Builder]
        L[Result Cache]
        J --> K
        K --> L
    end
    
    F --> G
    E --> J
    A --> M[Load Top Risk Entities]
    M --> N[Application State]
    
    style A fill:#667eea,color:#fff
    style G fill:#764ba2,color:#fff
    style J fill:#48bb78,color:#fff
            </div>
        </div>

        <h2>Dual Configuration Flow (.env Priority)</h2>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant App as Application
    participant Env as .env File
    participant Firebase as Firebase Secrets
    participant Config as ConfigLoader
    participant SF as Snowflake
    participant Analytics as RiskAnalyzer
    
    App->>Config: Initialize
    Config->>Env: Check .env file
    alt .env exists
        Env-->>Config: Return env config (Priority 1)
    else .env missing
        Config->>Firebase: Load from secrets
        Firebase-->>Config: Return firebase config (Priority 2)
    end
    Note over Config: .env overrides Firebase<br/>when both exist
    Config->>SF: Create connection
    SF-->>Config: Connection established
    App->>Analytics: Run startup analysis
    Analytics->>SF: Execute risk query
    Note over SF: GROUP BY email<br/>Past 24 hours<br/>Top 10%
    SF-->>Analytics: Return results
    Analytics-->>App: Store in state
    Note over App: Ready to serve<br/>high-risk entities
            </div>
        </div>

        <div class="phase-timeline">
            <div class="phase-item">
                <div class="phase-circle">1</div>
                <strong>Phase 1</strong><br>
                Schema & Config<br>
                <small>Days 1-2</small>
            </div>
            <div class="phase-item">
                <div class="phase-circle">2</div>
                <strong>Phase 2</strong><br>
                Migration & Integration<br>
                <small>Days 3-4</small>
            </div>
            <div class="phase-item">
                <div class="phase-circle">3</div>
                <strong>Phase 3</strong><br>
                Analytics Engine<br>
                <small>Days 5-6</small>
            </div>
        </div>

        <h2>Database Schema Structure</h2>
        <div class="diagram-container">
            <div class="mermaid">
graph LR
    subgraph "TRANSACTIONS_ENRICHED Table"
        subgraph "Core Fields"
            A1[TX_ID_KEY<br/>Primary Key]
            A2[TX_DATETIME]
            A3[EMAIL]
            A4[DEVICE_ID]
        end
        
        subgraph "Risk Metrics"
            B1[MODEL_SCORE]
            B2[MAXMIND_RISK_SCORE]
            B3[IS_FRAUD_TX]
            B4[RISK_FACTORS]
        end
        
        subgraph "Transaction Data"
            C1[PAID_AMOUNT_VALUE]
            C2[MERCHANT_NAME]
            C3[PAYMENT_METHOD]
            C4[GMV]
        end
        
        subgraph "User Profile"
            D1[FIRST_NAME]
            D2[LAST_NAME]
            D3[DATE_OF_BIRTH]
            D4[KYC_STATUS]
        end
        
        subgraph "Device Info"
            E1[IP]
            E2[USER_AGENT]
            E3[DEVICE_TYPE]
            E4[DEVICE_MODEL]
        end
    end
    
    style A1 fill:#667eea,color:#fff
    style B1 fill:#764ba2,color:#fff
    style C1 fill:#48bb78,color:#fff
            </div>
        </div>

        <div class="config-example">
            <h3 style="color: #e2e8f0; margin-top: 0;">üìù .env Configuration Example</h3>
            <pre># Snowflake Connection Configuration
SNOWFLAKE_ACCOUNT=fraud-analytics.us-east-1.snowflakecomputing.com
SNOWFLAKE_HOST=fraud-analytics.us-east-1.snowflakecomputing.com
SNOWFLAKE_USER=fraud_analytics_user
SNOWFLAKE_PASSWORD=secure_password_here
SNOWFLAKE_DATABASE=FRAUD_ANALYTICS
SNOWFLAKE_SCHEMA=PUBLIC
SNOWFLAKE_WAREHOUSE=COMPUTE_WH
SNOWFLAKE_ROLE=FRAUD_ANALYST_ROLE

# Analytics Configuration
ANALYTICS_DEFAULT_TIME_WINDOW=24h
ANALYTICS_DEFAULT_GROUP_BY=email
ANALYTICS_DEFAULT_TOP_PERCENTAGE=10</pre>
        </div>

        <h2>Analytics Query Engine</h2>
        <div class="diagram-container">
            <div class="mermaid">
flowchart TD
    A[User Request] --> B{Configuration}
    B --> C[Time Window<br/>1h, 6h, 12h, 24h, 7d, 30d]
    B --> D[Group By<br/>email, device_id, user_id]
    B --> E[Top Percentage<br/>5%, 10%, 20%, 50%]
    
    C --> F[Build SQL Query]
    D --> F
    E --> F
    
    F --> G[Execute on Snowflake]
    G --> H[Calculate Risk Score]
    H --> I[risk_score √ó amount]
    I --> J[Rank Entities]
    J --> K[Filter Top N%]
    K --> L[Return Sorted Results]
    
    style A fill:#667eea,color:#fff
    style L fill:#48bb78,color:#fff
            </div>
        </div>

        <div class="feature-list">
            <h3>üöÄ Implementation Features</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <strong>Zero Mock Data</strong><br>
                    Real Snowflake connectivity with production-ready client
                </div>
                <div class="feature-item">
                    <strong>Secure Configuration</strong><br>
                    Environment-based secrets with .env file management
                </div>
                <div class="feature-item">
                    <strong>Performance Optimized</strong><br>
                    Connection pooling and async execution for speed
                </div>
                <div class="feature-item">
                    <strong>Configurable Analytics</strong><br>
                    Dynamic time windows and grouping options
                </div>
                <div class="feature-item">
                    <strong>Auto-Load on Startup</strong><br>
                    Pre-loads high-risk entities for instant access
                </div>
                <div class="feature-item">
                    <strong>Modular Architecture</strong><br>
                    All files under 200 lines following best practices
                </div>
            </div>
        </div>

        <h2>Risk Calculation Flow</h2>
        <div class="diagram-container">
            <div class="mermaid">
graph TD
    A[Application Startup] --> B[Load Configuration]
    B --> C[Connect to Snowflake]
    C --> D[Execute Risk Query]
    
    D --> E[Filter: Past 24 Hours]
    E --> F[Group By: Email]
    F --> G[Calculate: risk_score √ó amount]
    G --> H[Rank All Entities]
    H --> I[Select Top 10%]
    I --> J[Sort by Risk Value]
    J --> K[Store in App State]
    
    K --> L[Ready for API Access]
    
    style A fill:#667eea,color:#fff
    style G fill:#764ba2,color:#fff
    style L fill:#48bb78,color:#fff
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>‚úÖ Success Metrics</h3>
                <ul>
                    <li>Query response < 2 seconds</li>
                    <li>Support 100+ concurrent users</li>
                    <li>99.9% uptime reliability</li>
                    <li>Zero credential exposures</li>
                    <li>100% test coverage</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>üîí Security Features</h3>
                <ul>
                    <li>Encrypted credentials in .env</li>
                    <li>Parameterized SQL queries</li>
                    <li>Read-only database role</li>
                    <li>Audit logging enabled</li>
                    <li>Connection encryption</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>üìà Performance Optimizations</h3>
                <ul>
                    <li>Connection pooling (5-10 connections)</li>
                    <li>Query result caching (5 min TTL)</li>
                    <li>Async query execution</li>
                    <li>Table clustering by date/email</li>
                    <li>Intelligent indexing strategy</li>
                </ul>
            </div>
        </div>

        <h2>SQL Query Example</h2>
        <div class="config-example">
            <pre>WITH risk_calculations AS (
    SELECT 
        email as entity,
        COUNT(*) as transaction_count,
        SUM(PAID_AMOUNT_VALUE_IN_CURRENCY) as total_amount,
        AVG(MODEL_SCORE) as avg_risk_score,
        SUM(MODEL_SCORE * PAID_AMOUNT_VALUE_IN_CURRENCY) as risk_weighted_value
    FROM FRAUD_ANALYTICS.PUBLIC.TRANSACTIONS_ENRICHED
    WHERE TX_DATETIME >= DATEADD(hour, -24, CURRENT_TIMESTAMP())
    GROUP BY email
)
SELECT * FROM risk_calculations
WHERE rank <= CEIL(total_entities * 0.10)
ORDER BY risk_weighted_value DESC</pre>
        </div>

        <p style="text-align: center; margin-top: 40px; color: #718096;">
            <strong>Snowflake POC Implementation</strong> | Olorin Fraud Detection Platform | 2025
        </p>
    </div>
</body>
</html>