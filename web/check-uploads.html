<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Queue Checker - Bayit+</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      overflow: hidden;
      margin: 16px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: bold;
    }

    .job-list {
      margin-top: 16px;
    }

    .job-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .job-name {
      flex: 1;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 12px;
    }

    .job-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-queued { background: rgba(59, 130, 246, 0.3); }
    .status-processing { background: rgba(139, 92, 246, 0.3); }
    .status-uploading { background: rgba(139, 92, 246, 0.3); }
    .status-completed { background: rgba(16, 185, 129, 0.3); }
    .status-failed { background: rgba(239, 68, 68, 0.3); }
    .status-cancelled { background: rgba(156, 163, 175, 0.3); }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: block;
      margin: 20px auto;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.5);
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
    }

    .empty {
      text-align: center;
      padding: 40px;
      opacity: 0.8;
      font-size: 1.1rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-active { background: rgba(16, 185, 129, 0.3); }
    .badge-paused { background: rgba(245, 158, 11, 0.3); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Upload Queue Status</h1>
      <p>Bayit+ Content Upload Monitor</p>
    </div>

    <button class="refresh-btn" onclick="checkQueue()">üîÑ Refresh Status</button>

    <div id="app"></div>
  </div>

  <script>
    let autoRefreshInterval = null;

    async function checkQueue() {
      const app = document.getElementById('app');
      app.innerHTML = '<div class="loading">üîÑ Loading upload queue status...</div>';

      try {
        // Try to get auth from parent window's localStorage (if opened from the app)
        let token = null;
        try {
          if (window.opener && window.opener.localStorage) {
            const authData = JSON.parse(window.opener.localStorage.getItem('bayit-auth') || '{}');
            token = authData?.state?.token;
          }
        } catch (e) {
          // Can't access parent storage, will prompt for API URL
        }

        // Determine API URL
        const apiUrl = prompt(
          'Enter API URL (or press OK for default):',
          'http://localhost:8000/api/v1'
        );

        if (!apiUrl) {
          app.innerHTML = '<div class="error">‚ùå API URL is required</div>';
          return;
        }

        if (!token) {
          token = prompt('Enter authentication token (from localStorage bayit-auth):');
          if (!token) {
            app.innerHTML = '<div class="error">‚ùå Authentication token is required</div>';
            return;
          }
        }

        const response = await fetch(`${apiUrl}/admin/uploads/queue`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        renderQueue(data);

      } catch (error) {
        app.innerHTML = `
          <div class="error">
            <h3>‚ùå Error loading queue</h3>
            <p>${error.message}</p>
            <ul style="margin-top: 12px; padding-left: 20px;">
              <li>Make sure the API server is running</li>
              <li>Verify your authentication token is valid</li>
              <li>Check the API URL is correct</li>
            </ul>
          </div>
        `;
      }
    }

    function renderQueue(data) {
      const totalSizeMB = (data.stats.total_size_bytes / (1024 * 1024)).toFixed(2);
      const uploadedMB = (data.stats.uploaded_bytes / (1024 * 1024)).toFixed(2);
      const percentComplete = data.stats.total_size_bytes > 0
        ? ((data.stats.uploaded_bytes / data.stats.total_size_bytes) * 100).toFixed(1)
        : 0;

      const hasActiveUploads = data.active_job || (data.queue && data.queue.length > 0);

      let html = '';

      // Queue Status Badge
      if (data.queue_paused) {
        html += `<div class="card"><h2>‚è∏Ô∏è Queue Paused <span class="badge badge-paused">PAUSED</span></h2>`;
        if (data.pause_reason) {
          html += `<p>Reason: ${data.pause_reason}</p>`;
        }
        html += `</div>`;
      } else if (hasActiveUploads) {
        html += `<div class="card"><h2>‚ñ∂Ô∏è Queue Active <span class="badge badge-active">RUNNING</span></h2></div>`;
      } else {
        html += `<div class="card"><h2>üí§ Queue Idle</h2><p class="empty">No uploads in progress</p></div>`;
      }

      // Statistics
      html += `
        <div class="card">
          <h2>üìà Statistics</h2>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value">${data.stats.total_jobs}</div>
              <div class="stat-label">Total Jobs</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.queued}</div>
              <div class="stat-label">üìã Queued</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.processing}</div>
              <div class="stat-label">üîÑ Processing</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.completed}</div>
              <div class="stat-label">‚úÖ Completed</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.failed}</div>
              <div class="stat-label">‚ùå Failed</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${data.stats.cancelled}</div>
              <div class="stat-label">‚õî Cancelled</div>
            </div>
          </div>
          <div style="margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>üíæ Total: ${totalSizeMB} MB</span>
              <span>üì§ Uploaded: ${uploadedMB} MB (${percentComplete}%)</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percentComplete}%">
                ${percentComplete > 5 ? percentComplete + '%' : ''}
              </div>
            </div>
          </div>
        </div>
      `;

      // Active Job
      if (data.active_job) {
        const job = data.active_job;
        const fileSizeMB = job.file_size ? (job.file_size / (1024 * 1024)).toFixed(2) : '?';
        const uploadedMB = (job.bytes_uploaded / (1024 * 1024)).toFixed(2);
        const speedMBps = job.upload_speed ? (job.upload_speed / (1024 * 1024)).toFixed(2) : '?';
        const eta = job.eta_seconds ? formatETA(job.eta_seconds) : '?';

        html += `
          <div class="card">
            <h2>üîÑ Currently Processing</h2>
            <div style="margin-top: 16px;">
              <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">${job.filename}</div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; font-size: 0.9rem;">
                <div>üì¶ Type: ${job.type}</div>
                <div>üìä Status: ${job.status}</div>
                <div>üíæ Size: ${fileSizeMB} MB</div>
                <div>üì§ Uploaded: ${uploadedMB} MB</div>
                <div>‚ö° Speed: ${speedMBps} MB/s</div>
                <div>‚è±Ô∏è ETA: ${eta}</div>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${job.progress}%">
                  ${job.progress.toFixed(1)}%
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Queued Jobs
      if (data.queue && data.queue.length > 0) {
        html += `
          <div class="card">
            <h2>üìã Queued Jobs (${data.queue.length})</h2>
            <div class="job-list">
        `;

        data.queue.slice(0, 10).forEach((job, index) => {
          const sizeMB = job.file_size ? (job.file_size / (1024 * 1024)).toFixed(2) : '?';
          html += `
            <div class="job-item">
              <span style="min-width: 30px;">#${index + 1}</span>
              <span class="job-name" title="${job.filename}">${job.filename}</span>
              <span style="margin: 0 12px;">${sizeMB} MB</span>
              <span class="job-status status-${job.status}">${job.status}</span>
            </div>
          `;
        });

        if (data.queue.length > 10) {
          html += `<div style="text-align: center; margin-top: 12px; opacity: 0.8;">... and ${data.queue.length - 10} more</div>`;
        }

        html += `</div></div>`;
      }

      // Recent Completed
      if (data.recent_completed && data.recent_completed.length > 0) {
        html += `
          <div class="card">
            <h2>‚úÖ Recently Completed (${data.recent_completed.length})</h2>
            <div class="job-list">
        `;

        data.recent_completed.slice(0, 5).forEach((job, index) => {
          html += `
            <div class="job-item">
              <span style="min-width: 30px;">#${index + 1}</span>
              <span class="job-name" title="${job.filename}">${job.filename}</span>
              <span class="job-status status-${job.status}">${job.status}</span>
            </div>
          `;
        });

        html += `</div></div>`;
      }

      document.getElementById('app').innerHTML = html;

      // Update page title
      document.title = hasActiveUploads
        ? `üîÑ ${data.stats.processing + data.stats.queued} Active - Upload Queue`
        : '‚úÖ Idle - Upload Queue';
    }

    function formatETA(seconds) {
      if (seconds < 60) return `${Math.round(seconds)}s`;
      if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
      const hours = Math.floor(seconds / 3600);
      const mins = Math.round((seconds % 3600) / 60);
      return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
    }

    // Auto-refresh every 5 seconds
    function startAutoRefresh() {
      if (!autoRefreshInterval) {
        autoRefreshInterval = setInterval(checkQueue, 5000);
      }
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    // Start checking on load
    window.onload = () => {
      checkQueue();
      startAutoRefresh();
    };

    // Stop auto-refresh when page is hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopAutoRefresh();
      } else {
        startAutoRefresh();
      }
    });
  </script>
</body>
</html>
