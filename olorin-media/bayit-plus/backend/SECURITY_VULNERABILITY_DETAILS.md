# Audiobooks Feature - Detailed Vulnerability Analysis

---

## Vulnerability #1: Server-Side Request Forgery (SSRF) - stream_url

**CVE Category**: CWE-918 (Server-Side Request Forgery)
**Severity**: CRITICAL
**CVSS Score**: 8.1 (High)
**Status**: UNPATCHED

### Attack Surface

#### Vector 1: Create Endpoint
```
POST /api/v1/admin/audiobooks
Authorization: Bearer {admin_token}

{
  "title": "Malicious Audiobook",
  "author": "Attacker",
  "stream_url": "https://localhost:8080/admin/panel",
  "stream_type": "hls"
}
```

**Result**: Attacker uploads stream_url pointing to internal services

#### Vector 2: Update Endpoint
```
PATCH /api/v1/admin/audiobooks/{audiobook_id}
Authorization: Bearer {admin_token}

{
  "stream_url": "https://192.168.1.1/internal/api"
}
```

**Result**: Attacker modifies existing audiobook to point to internal IP

#### Vector 3: Passive Reconnaissance
```
# Attacker learns from error messages or timing
GET /api/v1/admin/audiobooks/123

{
  "stream_url": "https://internal.service:3000/stream.m3u8"
  // â†‘ Exposes internal URLs!
}
```

### Impact Analysis

**Exposure Level**: HIGH
- Admin stream URLs stored in MongoDB (searchable)
- URLs appear in audit logs
- URLs visible in admin UI responses

**Attack Chain**:
1. Attacker gains admin credentials (phishing, credential reuse, etc.)
2. Creates audiobook with stream_url pointing to internal service
3. Internal service accessed when admin plays audiobook
4. Potential data exfiltration, code execution, lateral movement

**Business Impact**:
- Internal API exposure
- Potential data breach
- Service availability impact
- Compliance violation (GDPR, HIPAA if PII in internal services)

### Exploitation Requirements

**Must-Have**:
- Admin credentials âœ… (Easy to find in attacks)
- Access to admin endpoints âœ… (Already behind auth)

**Nice-to-Have**:
- Knowledge of internal network topology
- Internal service documentation

### Real-World Examples

**Similar CVEs**:
- CVE-2021-42848: Nextcloud - SSRF via URL upload
- CVE-2021-43798: Grafana - SSRF in plugin admin panel
- CVE-2021-26295: Opsgenie - SSRF in webhook configuration

---

## Vulnerability #2: NoSQL/Command Injection - drm_key_id

**CVE Category**: CWE-94 (Improper Control of Generation of Code)
**Severity**: CRITICAL
**CVSS Score**: 8.6 (High)
**Status**: UNPATCHED

### Attack Vectors

#### Vector 1: Direct NoSQL Injection
```json
POST /api/v1/admin/audiobooks
{
  "drm_key_id": "{ $ne: null }"
}
```

**Why This Matters**:
- Stored as-is in MongoDB: `drm_key_id: { $ne: null }`
- If used in future queries without validation, enables NoSQL injection
- Even though current code uses Beanie (safe), downstream systems might process this field

#### Vector 2: Shell Command Injection
```json
{
  "drm_key_id": "'; rm -rf /; echo '"
}
```

**Scenario**: If DRM key is passed to system command via shell:
```python
# Hypothetical vulnerable code in future version:
os.system(f"drm-tool --key-id {content.drm_key_id}")
# â†“ becomes:
os.system("drm-tool --key-id '; rm -rf /; echo ''")
```

#### Vector 3: Path Traversal
```json
{
  "drm_key_id": "../../../../etc/passwd"
}
```

**Scenario**: If DRM key used to locate key files:
```python
# Vulnerable code:
key_file = f"/keys/{content.drm_key_id}.pem"
# â†“ becomes:
key_file = "/keys/../../../../etc/passwd.pem"
```

#### Vector 4: Encoding-Based Bypass
```json
{
  "drm_key_id": "$(echo HACKED > /tmp/hacked.txt)"
}
```

**Scenario**: If DRM key evaluated in shell context

### Attack Flow

```
1. Attacker sends malicious drm_key_id
2. Stored in MongoDB unvalidated
3. Admin later uses DRM feature
4. Key is retrieved from database
5. Key passed to external DRM system
6. External system evaluates/executes key
7. Command injection occurs
```

### Storage Location
- **Primary**: MongoDB `audiobooks` collection field `drm_key_id`
- **Audit Logs**: Stored in audit_logs collection in `details` field
- **Backup**: May be in database backups

### Blast Radius

**High Risk If**:
- DRM keys are passed to shell commands
- Keys are used in subsequent API calls to DRM vendors
- Keys are processed by webhook services
- Keys are used in scheduled jobs

**Medium Risk If**:
- Keys are only stored but never used
- Keys are only displayed to admins (no execution)

---

## Vulnerability #3: Missing SSRF Validation on PATCH Update

**CVE Category**: CWE-918 (SSRF)
**Severity**: HIGH
**CVSS Score**: 7.5
**Status**: UNPATCHED

### Attack Scenario

```
# Step 1: Create legitimate audiobook
POST /api/v1/admin/audiobooks
{
  "stream_url": "https://cdn.example.com/book1.m3u8"
}
â†’ Returns: { "id": "abc123", ... }

# Step 2: Later, update to malicious URL
PATCH /api/v1/admin/audiobooks/abc123
{
  "stream_url": "https://internal-admin.local:8080/panel"
}
â†’ Success! No validation!

# Step 3: Attacker plays the audiobook
POST /api/v1/audiobooks/abc123/stream
â†’ Internal URL accessed from backend
```

### Why This Is Dangerous

**Post-Creation Bypass**:
- First validation at creation time might be bypassed
- But no validation at update time
- Allows "dormant" malicious content to be activated

**Evolution of Attack**:
- Attacker creates many legitimate audiobooks
- Months later, updates all of them to point to compromised internal service
- Enables time-delayed attacks

### Code Path

```python
# Line 318-320
update_data = request_data.model_dump(exclude_unset=True)
for field, value in update_data.items():
    setattr(audiobook, field, value)  # â† NO VALIDATION
# Line 323
await audiobook.save()
```

**Issue**: When `"stream_url"` is in `update_data`, it's set directly without validation

---

## Vulnerability #4: No Rate Limiting on Sensitive Endpoints

**CVE Category**: CWE-770 (Allocation of Resources Without Limits)
**Severity**: HIGH
**CVSS Score**: 7.3
**Status**: UNPATCHED

### Attack Scenarios

#### Scenario 1: Resource Exhaustion
```bash
# Attacker with admin token spam stream endpoint
for i in {1..100000}; do
  curl -H "Authorization: Bearer $TOKEN" \
    -X POST https://api.bayit.tv/audiobooks/audio1/stream
done
```

**Impact**:
- MongoDB gets 100K view_count increment operations
- Storage bloated with audit logs
- Potential database connection exhaustion
- Backend CPU/memory exhaustion

#### Scenario 2: DoS Attack
```bash
# Attacker creates 10000 audiobooks/hour
for i in {1..10000}; do
  curl -H "Authorization: Bearer $TOKEN" \
    -X POST https://api.bayit.tv/admin/audiobooks \
    -d '{"title": "Spam'$i'", ...}'
done
```

**Impact**:
- MongoDB storage exhaustion
- Index bloat
- Slow queries for legitimate admins
- Backup size explosion

#### Scenario 3: Audit Log Flooding
```python
# 100K operations/hour = 100K audit log entries
# 1GB per 10K entries (estimates)
# = 10GB per hour
# = 240GB per day
```

**Impact**:
- Storage costs explosion
- Audit log search becomes slow
- Forensics become harder (signal-to-noise ratio)

### Current Rate Limiting Status

```python
# /app/core/rate_limiter.py
RATE_LIMITS = {
    "login": "5/minute",  âœ…
    "register": "3/hour",  âœ…
    "password_reset": "3/hour",  âœ…
    # ... 30+ other endpoints with limits ...
    # âŒ NO AUDIOBOOK LIMITS!
}
```

**Missing Protections**:
- `POST /admin/audiobooks` - CREATE (unlimited)
- `GET /admin/audiobooks` - LIST (unlimited)
- `PATCH /admin/audiobooks/{id}` - UPDATE (unlimited)
- `DELETE /admin/audiobooks/{id}` - DELETE (unlimited)
- `POST /audiobooks/{id}/stream` - STREAM (unlimited) â† MOST CRITICAL

### Recommended Limits

```python
RATE_LIMITS = {
    "audiobook_create": "50/hour",     # ~1 per minute
    "audiobook_list": "100/minute",    # Admin dashboard
    "audiobook_update": "100/hour",    # ~2 per minute
    "audiobook_delete": "10/hour",     # Careful operation
    "audiobook_stream": "1000/hour",   # Heavy operation (1K/hr = ~17/sec)
}
```

---

## Vulnerability #5: Insufficient Input Validation

**CVE Category**: CWE-20 (Improper Input Validation)
**Severity**: MEDIUM
**CVSS Score**: 6.5
**Status**: UNPATCHED

### Missing Validations

#### Field 1: audio_quality
```python
# Current: No validation
audio_quality: Optional[str] = None

# Attacker sends:
{ "audio_quality": "'; echo HACKED; #" }
{ "audio_quality": "\n\nADVERTISEMENT\n\n" }
{ "audio_quality": "<script>alert('XSS')</script>" }

# Stored in MongoDB as-is, displayed in admin UI
```

**Fix**: Enum validation
```python
class AudioQuality(str, Enum):
    LOW = "low"
    STANDARD = "standard"
    HIGH = "high"
    HIGH_FIDELITY = "high-fidelity"

audio_quality: Optional[AudioQuality] = None
```

#### Field 2: isbn
```python
# Current: No validation
isbn: Optional[str] = None

# Attacker sends:
{ "isbn": "'; DROP COLLECTION audiobooks; --" }
{ "isbn": "978-9999999999-99" }  # Invalid format
{ "isbn": "978\"; system('rm -rf /'); \"" }  # Shell injection

# Valid ISBN-10: 10 digits with hyphens (e.g., 978-1-234567-89-0)
# Valid ISBN-13: 13 digits with hyphens (e.g., 978-3-16-148410-0)
```

**Fix**: Format validation
```python
isbn: Optional[str] = Field(
    None,
    regex=r"^(?:ISBN(?:-1[03])?:? )?(?=[0-9X]{10}$|(?:(?=(?:[0-9]+[- ]){3})[0-9X]{13}$|97[89][0-9]{10}$|(?=(?:[0-9]+[- ]){4})[0-9]{13}$))[0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9X]$"
)
```

#### Field 3: stream_url
```python
# Current: min_length=1 only
stream_url: str = Field(..., min_length=1)

# Attacker sends:
{ "stream_url": "x" }  # âœ… Passes current validation!
{ "stream_url": "not-a-url" }  # âœ… Passes!
{ "stream_url": "javascript:alert('XSS')" }  # âœ… Passes!
```

**Fix**: URL pattern validation
```python
stream_url: str = Field(
    ...,
    min_length=1,
    pattern=r"^https?://[a-zA-Z0-9\-._~:/?#\[\]@!$&'()*+,;=]+"
)
```

#### Field 4: drm_key_id
```python
# Already discussed - needs pattern validation
drm_key_id: Optional[str] = None

# Fix:
drm_key_id: Optional[str] = Field(
    None,
    max_length=128,
    pattern=r"^[a-zA-Z0-9\-_]{0,128}$"
)
```

---

## OWASP Top 10 Mapping

| OWASP | Category | Status | Finding |
|-------|----------|--------|---------|
| A01 | Broken Access Control | âš ï¸ PARTIAL | Stream correctly restricted; URL validation missing |
| A02 | Cryptographic Failures | âœ… OK | JWT properly signed; no sensitive data mishandled |
| **A03** | **Injection** | ğŸ”´ **VULNERABLE** | **SSRF injection via stream_url and drm_key_id** |
| A04 | Insecure Design | âš ï¸ NEEDS REVIEW | Missing rate limiting on sensitive ops |
| A05 | Security Misconfiguration | âœ… OK | Config externalized via env |
| A06 | Vulnerable Components | â³ UNKNOWN | Requires dependency scan |
| A07 | Authentication Failures | âœ… OK | JWT validation comprehensive |
| A08 | Data Integrity Failures | âš ï¸ CONCERN | Update ops lack validation |
| A09 | Logging & Monitoring | âœ… OK | Comprehensive audit logging |
| **A10** | **SSRF** | ğŸ”´ **VULNERABLE** | **Stream URL has no domain whitelist** |

---

## Detection and Monitoring

### How to Detect Exploitation

**Log Indicators**:
```
- Admin creating audiobooks with "localhost" in stream_url
- Rapid stream endpoint access (> 100/hour)
- Audiobooks with "127.0.0.1" or "192.168" URLs
- Audit logs with repeated STREAM_STARTED actions
- Update operations on same audiobook multiple times/day
```

**Database Queries to Find Exploited Data**:
```javascript
// Find SSRF attempts
db.audiobooks.find({
  stream_url: {
    $regex: "(localhost|127\\.0\\.0\\.1|192\\.168|10\\.0|172\\.16)"
  }
})

// Find suspicious drm_key_id
db.audiobooks.find({
  drm_key_id: {
    $regex: "[;$`()|&><]"  // Shell metacharacters
  }
})

// Find rapid streaming activity
db.audit_logs.aggregate([
  { $match: { action: "audiobook_stream_started" } },
  { $group: { _id: "$user_id", count: { $sum: 1 } } },
  { $match: { count: { $gt: 100 } } }
])
```

### Monitoring Setup

**Real-Time Alerts**:
```yaml
- Alert: "SSRF attempt detected"
  Condition: stream_url contains private IPs
  Action: Block admin, notify security

- Alert: "High rate limiting on stream endpoint"
  Condition: > 1000 requests/hour from single user
  Action: Throttle user, log for investigation

- Alert: "Invalid drm_key_id format"
  Condition: drm_key_id matches shell metacharacters
  Action: Block operation, alert admin
```

---

## Incident Response

### If Exploited (SSRF via stream_url)

**Steps**:
1. Revoke compromised admin credentials immediately
2. Audit all audiobooks created by compromised admin in last 90 days
3. Search for suspicious stream_url patterns (localhost, private IPs)
4. Review internal service logs for unauthorized access
5. Check if any internal data was exfiltrated
6. Notify affected users if data breach confirmed
7. File incident report

**Duration**: 4-8 hours for initial response

### If Exploited (Injection via drm_key_id)

**Steps**:
1. Check if drm_key_id fields contain injection payloads
2. Review all DRM vendor API calls for the past 90 days
3. Check external system logs for unusual commands
4. Verify no code execution on external DRM systems
5. Audit shell command execution logs on backend
6. Update all affected audiobook drm_key_id values

**Duration**: 2-4 hours for initial response

### Forensics Checklist

```
- [ ] Export all audiobooks with suspicious stream_url
- [ ] Export all audiobooks with suspicious drm_key_id
- [ ] Export audit logs for affected time period
- [ ] Check backend server logs for SSRF callbacks
- [ ] Review network logs for outbound connections to private IPs
- [ ] Check internal service logs for unauthorized access
- [ ] Interview affected admin (if available)
- [ ] Document timeline of exploitation
- [ ] Prepare incident report
```

---

## Remediation Priority Matrix

```
        Impact (Severity)
         High    Medium    Low
        â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
P1 (Do  â”‚ #1  â”‚  #4    â”‚   â€”    â”‚
Now)    â”‚SSRF â”‚  Rate  â”‚        â”‚
        â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
P2      â”‚ #3  â”‚  #5    â”‚   â€”    â”‚
(ASAP)  â”‚Patchâ”‚  Val   â”‚        â”‚
        â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
P3      â”‚  â€”  â”‚   â€”    â”‚   â€”    â”‚
(Next)  â”‚     â”‚        â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Where:
#1 = SSRF on create (CRITICAL)
#2 = drm_key_id injection (CRITICAL)
#3 = SSRF on patch update (HIGH)
#4 = Rate limiting (HIGH)
#5 = Input validation (MEDIUM)
```

---

## References

- [OWASP SSRF](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery)
- [CWE-918: SSRF](https://cwe.mitre.org/data/definitions/918.html)
- [CWE-94: Improper Code Generation](https://cwe.mitre.org/data/definitions/94.html)
- [CWE-770: Resource Exhaustion](https://cwe.mitre.org/data/definitions/770.html)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [Beanie Security](https://roman-right.github.io/beanie/)

