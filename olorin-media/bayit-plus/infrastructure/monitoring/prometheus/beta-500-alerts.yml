# Prometheus Alert Rules for Beta 500 Program
# Alerting thresholds and notification rules

groups:
  # ========================================
  # Critical Alerts (P0 - Immediate Action)
  # ========================================
  - name: beta_critical_alerts
    interval: 30s
    rules:
      - alert: BetaAPIHighErrorRate
        expr: |
          (
            sum(rate(beta_api_errors_total[5m]))
            /
            sum(rate(beta_api_requests_total[5m]))
          ) > 0.05
        for: 2m
        labels:
          severity: critical
          team: backend
          feature: beta-500
        annotations:
          summary: "Beta API error rate > 5%"
          description: "Beta API error rate is {{ $value | humanizePercentage }} (threshold: 5%). Immediate investigation required."
          dashboard: "https://grafana.bayit.plus/d/beta-500/overview"
          runbook: "https://docs.bayit.plus/runbooks/beta-api-errors"

      - alert: BetaCreditSystemDown
        expr: |
          up{job="beta-backend-api", path=~"/api/v1/beta/credits/.*"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
          feature: beta-500
        annotations:
          summary: "Beta credit system is down"
          description: "Credit balance endpoint unreachable for {{ $labels.instance }}"
          action: "Check backend service health and database connectivity"

      - alert: BetaDatabaseConnectionsExhausted
        expr: |
          mongodb_connections{state="current"} > 900
        for: 2m
        labels:
          severity: critical
          team: database
          feature: beta-500
        annotations:
          summary: "MongoDB connection pool near exhaustion"
          description: "Current connections: {{ $value }}/1000. Risk of connection errors."
          action: "Scale database connections or investigate connection leaks"

  # ========================================
  # High Priority Alerts (P1 - < 1 hour)
  # ========================================
  - name: beta_high_priority_alerts
    interval: 1m
    rules:
      - alert: BetaAPIHighLatency
        expr: |
          histogram_quantile(0.95,
            rate(beta_ai_search_duration_seconds_bucket[5m])
          ) > 1.0
        for: 5m
        labels:
          severity: high
          team: backend
          feature: beta-500
        annotations:
          summary: "Beta AI Search p95 latency > 1s"
          description: "AI Search p95 latency is {{ $value }}s (threshold: 1s)"
          dashboard: "https://grafana.bayit.plus/d/beta-500/api-performance"

      - alert: BetaMassiveCreditDepletion
        expr: |
          rate(beta_credits_deducted_total[5m]) > 1000
        for: 3m
        labels:
          severity: high
          team: backend
          feature: beta-500
        annotations:
          summary: "Unusually high credit consumption"
          description: "Credit deduction rate: {{ $value }} credits/sec. Possible abuse or bug."
          action: "Check for anomalous user activity or credit system bugs"

      - alert: BetaLowCreditUsersIncreasing
        expr: |
          rate(beta_users_low_credits:count[10m]) > 10
        for: 5m
        labels:
          severity: high
          team: product
          feature: beta-500
        annotations:
          summary: "Rapid increase in low-credit users"
          description: "{{ $value }} users per minute dropping below 500 credits"
          action: "Consider credit top-up or feature usage notification"

  # ========================================
  # Medium Priority Alerts (P2 - < 4 hours)
  # ========================================
  - name: beta_medium_priority_alerts
    interval: 2m
    rules:
      - alert: BetaUserEnrollmentStalled
        expr: |
          rate(beta_users_verified[1h]) == 0
        for: 30m
        labels:
          severity: medium
          team: growth
          feature: beta-500
        annotations:
          summary: "No new beta user enrollments in 30 minutes"
          description: "User enrollment pipeline may be stalled"
          action: "Check email verification service and signup flow"

      - alert: BetaEmailVerificationLowSuccess
        expr: |
          (
            rate(beta_email_verification_succeeded_total[15m])
            /
            rate(beta_email_verification_sent_total[15m])
          ) < 0.50
        for: 15m
        labels:
          severity: medium
          team: backend
          feature: beta-500
        annotations:
          summary: "Email verification success rate < 50%"
          description: "Verification success rate: {{ $value | humanizePercentage }}"
          action: "Check email delivery and verification flow"

      - alert: BetaFraudDetectionHighRisk
        expr: |
          (
            rate(beta_signup_fraud_detected_total[10m])
            /
            rate(beta_signup_fraud_checks_total[10m])
          ) > 0.20
        for: 10m
        labels:
          severity: medium
          team: security
          feature: beta-500
        annotations:
          summary: "High fraud detection rate (> 20%)"
          description: "Fraud detection rate: {{ $value | humanizePercentage }}"
          action: "Review fraud patterns and adjust detection thresholds"

  # ========================================
  # Low Priority Alerts (P3 - Informational)
  # ========================================
  - name: beta_low_priority_alerts
    interval: 5m
    rules:
      - alert: BetaProgramNearCapacity
        expr: |
          (beta_users_total / 500) > 0.90
        for: 10m
        labels:
          severity: low
          team: product
          feature: beta-500
        annotations:
          summary: "Beta program > 90% capacity"
          description: "Current enrollment: {{ $value | humanize }} / 500 users"
          action: "Prepare for program closure or expansion"

      - alert: BetaAverageCreditsLow
        expr: |
          beta:credits_remaining:avg < 1000
        for: 30m
        labels:
          severity: low
          team: product
          feature: beta-500
        annotations:
          summary: "Average user credits < 1000"
          description: "Average remaining credits: {{ $value | humanize }}"
          action: "Monitor user engagement and credit consumption patterns"

      - alert: BetaUnusualFeatureUsage
        expr: |
          (
            rate(beta_podcast_translation_requests_total[1h])
            /
            rate(beta_ai_search_requests_total[1h])
          ) > 0.50
        for: 30m
        labels:
          severity: low
          team: product
          feature: beta-500
        annotations:
          summary: "Podcast translation usage unusually high"
          description: "Podcast translations / AI searches ratio: {{ $value }}"
          action: "Review feature adoption patterns"

  # ========================================
  # SLO Alerts (Service Level Objectives)
  # ========================================
  - name: beta_slo_alerts
    interval: 5m
    rules:
      - alert: BetaAPIAvailabilitySLO
        expr: |
          (
            sum(rate(beta_api_requests_total[30m]))
            -
            sum(rate(beta_api_errors_total[30m]))
          )
          /
          sum(rate(beta_api_requests_total[30m]))
          < 0.999
        for: 5m
        labels:
          severity: high
          team: sre
          feature: beta-500
          slo: availability
        annotations:
          summary: "Beta API availability SLO breach (< 99.9%)"
          description: "Current availability: {{ $value | humanizePercentage }} (target: 99.9%)"
          burn_rate: "{{ $value }}"

      - alert: BetaAPILatencySLO
        expr: |
          histogram_quantile(0.95,
            rate(beta_ai_search_duration_seconds_bucket[10m])
          ) > 0.500
        for: 10m
        labels:
          severity: high
          team: sre
          feature: beta-500
          slo: latency
        annotations:
          summary: "Beta API latency SLO breach (p95 > 500ms)"
          description: "Current p95 latency: {{ $value }}s (target: 500ms)"

      - alert: BetaCreditOperationLatencySLO
        expr: |
          histogram_quantile(0.95,
            rate(beta_credit_deduction_duration_seconds_bucket[5m])
          ) > 0.100
        for: 5m
        labels:
          severity: high
          team: backend
          feature: beta-500
          slo: latency
        annotations:
          summary: "Credit deduction latency SLO breach (p95 > 100ms)"
          description: "Current p95 latency: {{ $value }}s (target: 100ms)"
          action: "Check database query performance and connection pool"

  # ========================================
  # Resource Alerts (Infrastructure)
  # ========================================
  - name: beta_resource_alerts
    interval: 2m
    rules:
      - alert: BetaBackendHighCPU
        expr: |
          rate(process_cpu_seconds_total{job="beta-backend-api"}[5m]) > 0.80
        for: 5m
        labels:
          severity: medium
          team: sre
          feature: beta-500
        annotations:
          summary: "Backend CPU usage > 80%"
          description: "CPU usage: {{ $value | humanizePercentage }}"
          action: "Scale horizontally or optimize hot code paths"

      - alert: BetaBackendHighMemory
        expr: |
          (
            process_resident_memory_bytes{job="beta-backend-api"}
            /
            node_memory_MemTotal_bytes
          ) > 0.85
        for: 5m
        labels:
          severity: medium
          team: sre
          feature: beta-500
        annotations:
          summary: "Backend memory usage > 85%"
          description: "Memory usage: {{ $value | humanizePercentage }}"
          action: "Check for memory leaks or scale vertically"

      - alert: BetaDatabaseStorageHigh
        expr: |
          (
            mongodb_storage_used_bytes
            /
            mongodb_storage_total_bytes
          ) > 0.80
        for: 10m
        labels:
          severity: medium
          team: database
          feature: beta-500
        annotations:
          summary: "MongoDB storage > 80% capacity"
          description: "Storage usage: {{ $value | humanizePercentage }}"
          action: "Plan for storage expansion or data archival"

# ========================================
# Alert Routing Rules
# ========================================
# Configure in Alertmanager (alertmanager.yml):
#
# route:
#   group_by: ['alertname', 'feature']
#   group_wait: 30s
#   group_interval: 5m
#   repeat_interval: 4h
#   receiver: 'beta-team'
#   routes:
#     - match:
#         severity: critical
#       receiver: 'pagerduty'
#       continue: true
#     - match:
#         severity: high
#       receiver: 'slack-high'
#     - match:
#         severity: medium
#       receiver: 'slack-medium'
#     - match:
#         severity: low
#       receiver: 'email'
