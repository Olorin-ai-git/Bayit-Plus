# Bayit+ Bug Fixes - January 28, 2026

## Issues Fixed

### 1. Duplicate React Keys for Culture Cities ✅ FIXED

**Problem:**
- React console showed warnings about duplicate keys for `jerusalem` and `tel-aviv`
- MongoDB `culture_cities` collection had duplicate documents with the same `city_id`
- Caused by lack of unique constraint on the `city_id` field

**Root Cause:**
The `CultureCity` model in `/backend/app/models/culture.py` had indexes but no unique constraint to prevent duplicate city entries within the same culture.

**Fix Applied:**
1. Added unique compound index on `(culture_id, city_id)` to prevent future duplicates
2. Updated `/backend/app/models/culture.py` (lines 143-154)

**Files Modified:**
- `backend/app/models/culture.py` - Added unique index

**Manual Cleanup Required:**
To remove existing duplicates from the database, run:
```bash
cd backend
poetry run python fix_duplicate_culture_cities.py
```

This script will:
- Find all duplicate `city_id` entries
- Keep the oldest entry for each duplicate
- Remove newer duplicates
- Verify no duplicates remain

---

### 2. Reverse Geocoding 404 Error ✅ FIXED

**Problem:**
- Frontend calls to `/api/v1/location/reverse-geocode` returned 404 Not Found
- Error logged: `useUserGeolocation.ts:117 GET http://localhost:3200/api/v1/location/reverse-geocode?latitude=...&longitude=... 404 (Not Found)`

**Root Cause:**
The `useUserGeolocation.ts` hook was using `fetch()` with relative URLs (`/api/v1/...`), which sent requests to the frontend server (port 3200) instead of the backend API server (port 8000).

**Fix Applied:**
1. Import the configured API client
2. Replace `fetch()` calls with `api.get()` and `api.patch()`
3. Ensure requests use the correct backend base URL

**Files Modified:**
- `web/src/hooks/useUserGeolocation.ts`:
  - Added import: `import { api } from '@/services/api/client';`
  - Replaced `fetch('/api/v1/location/reverse-geocode?...')` with `api.get('/location/reverse-geocode', { params: {...} })`
  - Replaced `fetch('/api/v1/users/me/preferences', ...)` with `api.patch('/users/me/preferences', {...})`

**How It Works Now:**
- `api` client from `/shared/services/api/client.ts` automatically uses correct base URL
- Development: `http://localhost:8000/api/v1`
- Production web: `/api/v1` (proxied through Firebase Hosting)
- Native apps: `https://api.bayit.tv/api/v1`

---

## Testing Instructions

### Test Fix #1 (Duplicate Cities)

1. **After running the cleanup script:**
   ```bash
   cd backend
   poetry run python fix_duplicate_culture_cities.py
   # Type "yes" when prompted to remove duplicates
   ```

2. **Verify in browser console:**
   - Reload the Bayit+ web app
   - Check browser console - no more duplicate key warnings
   - Should see clean render of Jerusalem and Tel Aviv city rows

### Test Fix #2 (Reverse Geocoding)

1. **Clear browser cache and reload**
2. **Open browser developer tools → Console**
3. **Clear localStorage:**
   ```javascript
   localStorage.removeItem('bayit_user_location');
   ```
4. **Reload the page**
5. **When prompted, allow location access**
6. **Verify:**
   - No 404 errors in console for `/api/v1/location/reverse-geocode`
   - Should see successful geolocation detection
   - Check logs for: `INFO [useUserGeolocation] Location detected`

---

## Files Changed Summary

```
Modified:
  backend/app/models/culture.py           (Added unique index)
  web/src/hooks/useUserGeolocation.ts     (Use API client instead of fetch)

Created:
  backend/fix_duplicate_culture_cities.py (Database cleanup script)
```

---

## Next Steps

1. **Run the database cleanup script** to remove existing duplicates:
   ```bash
   cd backend
   poetry run python fix_duplicate_culture_cities.py
   ```

2. **Rebuild backend indexes** (if using index management):
   ```bash
   cd backend
   poetry run python scripts/rebuild_all_indexes.py  # if this script exists
   ```

3. **Test both fixes** following the testing instructions above

4. **Monitor for any new issues** in browser console and backend logs

---

## Prevention

The unique compound index on `(culture_id, city_id)` will prevent duplicate cities from being inserted in the future. Any attempt to insert a duplicate will result in a MongoDB duplicate key error.

Future database seeds or migrations should check for existing cities before inserting new ones.
