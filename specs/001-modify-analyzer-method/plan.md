# Implementation Plan: Analyzer Time Window and Investigation Range Modifications

**Branch**: `001-modify-analyzer-method` | **Date**: 2025-11-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-modify-analyzer-method/spec.md`

**Note**: This plan was generated by the `/plan` command following the execution workflow.

## Summary

This feature modifies the analyzer to process transactions from a 24-hour window ending at 6 months ago (instead of ending today), excludes transactions with any fraud-related columns populated, and maintains the existing top 10% riskiest entities calculation. Investigation queries will span 2 years (2.5 years ago to 6 months ago) and must exclude all columns matching the `*FRAUD*` pattern. The confusion table will continue to validate predictions against actual fraud labels post-investigation.

**Key Changes**:
- Analyzer window: `[Today - 6mo - 24h] to [Today - 6mo]` (configurable via .env)
- Investigation range: `[Today - 2.5y] to [Today - 6mo]` (2-year span)
- Fraud column exclusion: Pattern-based (`*FRAUD*`) for investigation queries
- Approved filter: Strict `NSURE_LAST_DECISION = 'APPROVED' AND IS NOT NULL`
- **PII Hashing**: All PII fields hashed (SHA-256) before logging or LLM calls
- Confusion matrix: Unchanged, uses fraud columns only for validation

## Technical Context

**Language/Version**: Python 3.11+  
**Primary Dependencies**: FastAPI, Snowflake Connector, SQLAlchemy, asyncio  
**Storage**: Snowflake (primary data warehouse), PostgreSQL (metadata/state)  
**Testing**: pytest, pytest-asyncio, unittest.mock  
**Target Platform**: Linux server (containerized backend service)  
**Project Type**: Web application backend (part of olorin-server)  
**Performance Goals**: 
- Query execution: <30s for analyzer window queries
- Investigation queries: <60s for 2-year historical range
- Top 10% calculation: <5s for entity ranking  
**Constraints**: 
- Must maintain backward compatibility with existing confusion matrix logic
- Fraud column exclusion must be comprehensive (pattern-based)
- Time calculations must use database server timezone (no app-level conversion)
- All configuration via .env (no hard-coded values)
- **PII Security**: All personally identifiable information must be hashed (SHA-256) before logging or sending to LLM
- **Privacy Compliance**: Must maintain GDPR/CCPA compliance by protecting user data in logs and external API calls  
**Scale/Scope**: 
- Analyzer: Process 24-hour windows (~100K-1M transactions depending on volume)
- Investigation: Query 2-year spans (~10M-50M transactions)
- Top 10%: Typically 5-50 entities depending on grouping (email, device_id, IP)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **Backward Compatibility** | ✅ PASS | Preserves existing top 10% calculation logic, confusion matrix unchanged |
| **Configuration Over Code** | ✅ PASS | All time windows and offsets configurable via .env parameters |
| **Data Integrity** | ✅ PASS | Strict fraud column exclusion prevents data contamination in investigations |
| **Testability** | ✅ PASS | Changes isolated to specific query builders and analyzers, unit testable |
| **Security** | ✅ PASS | No new data access patterns, maintains existing authorization |
| **Privacy & Compliance** | ✅ PASS | PII hashing before logging/LLM calls ensures GDPR/CCPA compliance |
| **Performance** | ⚠️ REVIEW | Time window changes + PII hashing may affect performance - needs monitoring |
| **Documentation** | ✅ PASS | .env parameters documented, SQL patterns provided in spec |

**Overall**: **PASS** with performance monitoring recommended

**Action Items**:
- Add query performance logging for analyzer and investigation queries
- Monitor query execution times in production after deployment
- Consider adding query plan analysis for Snowflake queries if performance degrades
- **Add PII hashing performance benchmarks** (hashing overhead for large result sets)
- **Implement PII hash caching** if performance degrades (same values hashed repeatedly)
- **Audit all logging statements** to ensure PII is hashed before output

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
olorin-server/
├── app/
│   ├── service/
│   │   ├── analytics/
│   │   │   └── risk_analyzer.py              # MODIFY: Update date calculation logic
│   │   ├── agent/
│   │   │   └── tools/
│   │   │       └── snowflake_tool/
│   │   │           ├── real_client.py        # MODIFY: Change analyzer time window
│   │   │           ├── query_builder.py      # MODIFY: Expand fraud column exclusion
│   │   │           └── schema_constants.py   # REFERENCE: Fraud column definitions
│   │   ├── investigation/
│   │   │   └── metrics_calculation.py        # NO CHANGE: Confusion matrix already correct
│   │   └── security/
│   │       └── pii_hasher.py                 # ADD: PII hashing utility
│   ├── config/
│   │   └── eval.py                          # MODIFY: Add new .env parameter handling
│   ├── utils/
│   │   └── logging_config.py                 # MODIFY: Add PII-aware logging formatter
│   └── api/
│       └── routes/
│           └── analytics.py                  # NO CHANGE: Uses risk_analyzer
├── tests/
│   ├── unit/
│   │   └── service/
│   │       ├── test_risk_analyzer.py         # ADD: Unit tests for time window logic
│   │       ├── test_query_builder.py         # ADD: Tests for fraud column exclusion
│   │       └── test_pii_hasher.py            # ADD: Unit tests for PII hashing
│   └── integration/
│       ├── test_analyzer_investigation.py    # ADD: E2E test for time range validation
│       └── test_pii_in_logs.py               # ADD: Test PII is hashed in logs
├── scripts/
│   └── investigate_top_risk_entities.py      # MODIFY: Update for new time windows
└── .env.example                               # MODIFY: Document new parameters
```

**Structure Decision**: Backend-only changes (olorin-server). This is a web application backend with Python services, focusing on analytics and investigation modules. No frontend changes required. All modifications are in existing service layers with new .env configuration parameters.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No constitutional violations requiring justification. All changes follow existing patterns and maintain backward compatibility.

## Progress Tracking

| Phase | Status | Artifacts | Notes |
|-------|--------|-----------|-------|
| **Phase 0: Research** | ✅ COMPLETE | research.md | Codebase analysis complete, existing implementations documented |
| **Phase 1: Design** | ✅ COMPLETE | data-model.md, contracts/, quickstart.md | Data models, contracts, and quickstart guide generated |
| **Phase 2: Tasks** | ✅ COMPLETE | tasks.md | Task breakdown generated with 29 tasks across 6 phases |

### Phase 0 Completion Summary

**Artifacts Generated**:
- ✅ `research.md` - Comprehensive codebase analysis
  - Identified 5 key files for modification
  - Documented current implementations
  - Risk assessment complete
  - Testing strategy defined

**Key Findings**:
- Analyzer time window calculation in `real_client.py` line 480
- Investigation query builder already excludes IS_FRAUD_TX and MODEL_SCORE
- Confusion matrix logic requires no changes
- 2 fraud-related columns identified in schema

### Phase 1 Completion Summary

**Artifacts Generated**:
- ✅ `data-model.md` - Data model and configuration schemas
  - AnalyzerTimeWindow configuration model
  - InvestigationTimeRange configuration model
  - Query filtering patterns documented
  - Data flow diagrams included

- ✅ `contracts/` directory - API contracts
  - `analyzer-time-window.md` - Analyzer configuration contract
  - `investigation-time-range.md` - Investigation range contract
  - `fraud-column-exclusion.md` - Column exclusion contract

- ✅ `quickstart.md` - Implementation guide
  - 9-step implementation process
  - Code examples for all modifications
  - Testing procedures
  - Troubleshooting guide

### Phase 2 Completion Summary

**Artifacts Generated**:
- ✅ `tasks.md` - Complete task breakdown with 29 tasks

**Task Organization**:
- **Phase 1 (Setup)**: 3 tasks - Configuration and dependencies
- **Phase 2 (Foundational)**: 4 tasks - PII hashing infrastructure (BLOCKING)
- **Phase 3 (User Story 1)**: 6 tasks - Analyzer time window modifications
- **Phase 4 (User Story 2)**: 7 tasks - Investigation range modifications
- **Phase 5 (User Story 3)**: 3 tasks - Confusion table validation
- **Phase 6 (Polish)**: 6 tasks - Documentation, performance, security

**Key Features**:
- TDD approach with tests written first
- User story independence (each story testable separately)
- Parallel execution opportunities (18 tasks marked [P])
- Clear dependencies and critical path documented
- Estimated time: 6 hours sequential, 4 hours with parallelization

**Implementation Strategy**:
- MVP First: Complete Foundational + User Story 1 (3 hours)
- Incremental: Add User Story 2 (1.5 hours), then User Story 3 (30 min)
- Parallel Team: 2-3 developers can work simultaneously after Foundational phase

### Next Steps

Implementation can now begin following tasks.md. Start with Phase 1 (Setup), then Phase 2 (Foundational PII hashing - critical blocking phase), then proceed to user stories.
