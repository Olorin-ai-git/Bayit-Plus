# Pre-commit Configuration for Mock Data Detection and Quality Enforcement
# Author: Gil Klainert
# Created: 2025-01-08
# Version: 1.0.0
#
# This configuration enforces zero-tolerance mock data policies and maintains
# code quality standards across the Olorin project.

# Pre-commit framework version
default_stages: [commit]
default_language_version:
  python: python3.11
  node: system

repos:
  # ============================================================================
  # CRITICAL: Mock Data Detection (Zero Tolerance)
  # ============================================================================
  - repo: local
    hooks:
      - id: detect-mock-data
        name: üö® Mock Data Detection (ZERO TOLERANCE)
        entry: scripts/git-hooks/detect-mock-data.py
        language: python
        language_version: python3.11
        args: [
          '--staged',
          '--fail-on', 'CRITICAL',
          '--config', 'scripts/git-hooks/mock-detection-config.yml',
          '--output-json', '.mock-detection-report.json'
        ]
        files: '.*'
        exclude: |
          (?x)^(
            .*/(test|tests|spec|__tests__|cypress|e2e)/.*|
            .*\.test\.(py|js|ts|jsx|tsx)$|
            .*\.spec\.(py|js|ts|jsx|tsx)$|
            .*/node_modules/.*|
            .*/\.git/.*|
            .*\.min\.(js|css)$|
            .*\.bundle\.(js|css)$|
            .*/build/.*|
            .*/dist/.*|
            .*/__pycache__/.*|
            .*\.mockignore$|
            .*\.pre-commit-.*\.yaml$|
            .*/docs/examples/.*|
            .*/scripts/git-hooks/test-.*\.py$
          )
        pass_filenames: false
        always_run: false
        verbose: true
        stages: [commit, push, manual]
        require_serial: true

  # ============================================================================
  # Security and Compliance Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: validate-no-secrets
        name: üîí Secret Detection
        entry: bash
        args: ['-c', 'scripts/security/scan-secrets.sh']
        language: system
        files: '.*'
        exclude: |
          (?x)^(
            .*/\.git/.*|
            .*\.enc$|
            .*\.gpg$|
            .*/\.secrets/.*
          )
        pass_filenames: true
        stages: [commit, push]

  # ============================================================================
  # Python Code Quality (Backend - olorin-server)
  # ============================================================================
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        name: üêç Python Code Formatting (Black)
        files: 'olorin-server/.*\.py$'
        args: ['--line-length=88', '--target-version=py311']

  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: üì¶ Python Import Sorting (isort)
        files: 'olorin-server/.*\.py$'
        args: ['--profile=black', '--line-length=88', '--multi-line=3']

  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: üîç Python Linting (Flake8)
        files: 'olorin-server/.*\.py$'
        args: [
          '--max-line-length=88',
          '--extend-ignore=E203,W503,E501',
          '--per-file-ignores=__init__.py:F401'
        ]

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: üéØ Python Type Checking (MyPy)
        files: 'olorin-server/.*\.py$'
        args: [
          '--ignore-missing-imports',
          '--python-version=3.11',
          '--strict-optional',
          '--warn-redundant-casts'
        ]
        additional_dependencies: [types-all]

  # ============================================================================
  # TypeScript/JavaScript Code Quality (Frontend - olorin-front)
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v8.56.0
    hooks:
      - id: eslint
        name: üîç TypeScript/JavaScript Linting (ESLint)
        files: 'olorin-front/.*\.(ts|tsx|js|jsx)$'
        args: [
          '--fix',
          '--ext', '.ts,.tsx,.js,.jsx',
          '--max-warnings=0'
        ]
        additional_dependencies:
          - '@typescript-eslint/eslint-plugin@^6.0.0'
          - '@typescript-eslint/parser@^6.0.0'
          - 'eslint-plugin-react@^7.33.0'
          - 'eslint-plugin-react-hooks@^4.6.0'

  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: üé® Code Formatting (Prettier)
        files: 'olorin-front/.*\.(ts|tsx|js|jsx|json|css|scss|md)$'
        args: [
          '--write',
          '--tab-width=2',
          '--single-quote=true',
          '--trailing-comma=es5'
        ]

  # ============================================================================
  # General Code Quality and Structure
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: üßπ Remove Trailing Whitespace
        args: ['--markdown-linebreak-ext=md']

      - id: end-of-file-fixer
        name: üìÑ Fix End of Files
        
      - id: check-yaml
        name: ‚úÖ YAML Syntax Validation
        args: ['--allow-multiple-documents']
        exclude: |
          (?x)^(
            .*\.template\.ya?ml$|
            .*\.example\.ya?ml$
          )

      - id: check-json
        name: ‚úÖ JSON Syntax Validation
        exclude: |
          (?x)^(
            .*\.template\.json$|
            .*\.example\.json$|
            .*/tsconfig\.json$
          )

      - id: check-xml
        name: ‚úÖ XML Syntax Validation

      - id: check-toml
        name: ‚úÖ TOML Syntax Validation

      - id: check-merge-conflict
        name: üîÄ Check for Merge Conflicts

      - id: check-case-conflict
        name: üî§ Check Case Conflicts

      - id: check-added-large-files
        name: üì¶ Check Large Files
        args: ['--maxkb=1000']

      - id: check-executables-have-shebangs
        name: #!/ Check Script Shebangs

      - id: mixed-line-ending
        name: üìù Check Line Endings
        args: ['--fix=lf']

  # ============================================================================
  # File Size and Structure Compliance
  # ============================================================================
  - repo: local
    hooks:
      - id: check-file-size-limit
        name: üìè Check File Size Limit (200 lines)
        entry: python
        args: ['-c', '
import sys, os;
violations = [];
for file_path in sys.argv[1:]:
    if not os.path.exists(file_path) or not os.path.isfile(file_path):
        continue;
    if any(exclude in file_path for exclude in ["node_modules", ".git", "build", "dist", "__pycache__", ".tox", ".venv", "vendor"]):
        continue;
    try:
        with open(file_path, "r", encoding="utf-8", errors="ignore") as f:
            lines = len(f.readlines());
        if lines > 200:
            violations.append(f"{file_path}: {lines} lines (max 200)");
    except Exception:
        pass;
if violations:
    print("‚ùå FILE SIZE VIOLATIONS (200 line limit):");
    for v in violations:
        print(f"  {v}");
    sys.exit(1);
else:
    print("‚úÖ All files comply with 200-line limit");
        ']
        language: system
        files: '.*\.(py|ts|tsx|js|jsx|java|rb|php|go|rs|cpp|c|cs)$'
        exclude: |
          (?x)^(
            .*/(test|tests|spec|__tests__|cypress|e2e)/.*|
            .*\.test\.(py|js|ts|jsx|tsx)$|
            .*\.spec\.(py|js|ts|jsx|tsx)$|
            .*\.min\.(js|css)$|
            .*\.bundle\.(js|css)$|
            .*\.generated\.(py|js|ts)$|
            .*/node_modules/.*|
            .*/build/.*|
            .*/dist/.*
          )
        pass_filenames: true
        stages: [commit]

  # ============================================================================
  # Documentation and Comments
  # ============================================================================
  - repo: https://github.com/executablebooks/mdformat
    rev: 0.7.17
    hooks:
      - id: mdformat
        name: üìù Markdown Formatting
        args: ['--wrap=80']
        additional_dependencies:
          - mdformat-gfm
          - mdformat-black

  - repo: local
    hooks:
      - id: check-commit-message
        name: üí¨ Commit Message Format
        entry: python
        args: ['-c', '
import sys, re;
with open(".git/COMMIT_EDITMSG", "r") as f:
    msg = f.read().strip();
patterns = [
    r"^(feat|fix|refactor|test|docs|style|chore|perf|security)(\(.+\))?: .+",
    r"^(feat|fix|refactor|test|docs|style|chore|perf|security): .+"
];
if not any(re.match(p, msg) for p in patterns):
    print("‚ùå Commit message must follow conventional commits format:");
    print("   feat: add new feature");
    print("   fix: resolve bug");
    print("   refactor: improve code structure");
    print("   test: add tests");
    print("   docs: update documentation");
    print("   style: formatting changes");
    print("   chore: maintenance tasks");
    print("   perf: performance improvements");
    print("   security: security enhancements");
    print(f"Current: {msg}");
    sys.exit(1);
        ']
        language: system
        stages: [commit-msg]
        pass_filenames: false
        always_run: true

  # ============================================================================
  # Dependency and License Compliance
  # ============================================================================
  - repo: local
    hooks:
      - id: check-python-dependencies
        name: üêç Python Dependency Check
        entry: bash
        args: ['-c', '
        cd olorin-server && 
        if [ -f pyproject.toml ]; then
          poetry check --verbose;
          poetry run safety check --json || echo "‚ö†Ô∏è  Security vulnerabilities found in dependencies";
        fi
        ']
        language: system
        files: 'olorin-server/(pyproject\.toml|poetry\.lock|requirements.*\.txt)$'
        pass_filenames: false

      - id: check-node-dependencies
        name: üì¶ Node.js Dependency Check
        entry: bash
        args: ['-c', '
        if [ -d olorin-front ] && [ -f olorin-front/package.json ]; then
          cd olorin-front &&
          npm audit --audit-level=high --only=prod || echo "‚ö†Ô∏è  Security vulnerabilities found in npm dependencies";
        fi
        ']
        language: system
        files: 'olorin-front/(package\.json|package-lock\.json|yarn\.lock)$'
        pass_filenames: false

# ============================================================================
# Global Configuration
# ============================================================================

# Performance and reliability settings
fail_fast: false  # Continue checking all hooks even if one fails
minimum_pre_commit_version: '3.0.0'

# CI Integration settings
ci:
    autofix_commit_msg: |
        ü§ñ pre-commit auto-fixes
        
        Auto-generated by pre-commit hooks to maintain code quality standards.
        
        Changes include:
        - Code formatting (Black, Prettier)
        - Import sorting (isort)
        - Trailing whitespace removal
        - End-of-file fixes
        - Markdown formatting
    autofix_prs: true
    autoupdate_branch: 'main'
    autoupdate_commit_msg: 'üîÑ [pre-commit.ci] pre-commit autoupdate'
    autoupdate_schedule: weekly
    skip: []
    submodules: false