stages:
  - contract-tests
  - breaking-changes

variables:
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.11"
  BACKEND_URL: "http://localhost:8090"
  API_VERSION: "v1"
  TEST_ENTITY_ID: "test@example.com"
  TEST_ENTITY_TYPE: "email"

.backend-setup:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq curl python3 python3-pip
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="$HOME/.local/bin:$PATH"
    - cd olorin-server
    - poetry install --no-interaction --no-ansi
    - poetry run python -m app.local_server &
    - sleep 10
    - curl --retry 5 --retry-delay 2 --retry-connrefused --fail http://localhost:8090/health

contract-tests:
  stage: contract-tests
  image: node:${NODE_VERSION}
  services:
    - redis:7-alpine
  before_script:
    - !reference [.backend-setup, before_script]
  script:
    - cd ../olorin-front
    - npm ci
    - npm run generate-api-types
    - npm run contract:test
    - npm run test:backward-compatibility
  after_script:
    - pkill -f "python -m app.local_server" || true
  artifacts:
    when: always
    paths:
      - olorin-front/test/contract/reports/*.html
      - olorin-front/test/contract/reports/*.md
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

breaking-change-detection:
  stage: breaking-changes
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq curl python3 python3-pip git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="$HOME/.local/bin:$PATH"
  script:
    # Clone base branch for comparison
    - git fetch origin ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-main}
    - git checkout -b base origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-main}

    # Start base backend and download schema
    - cd olorin-server
    - poetry install --no-interaction --no-ansi
    - poetry run python -m app.local_server --port 8090 &
    - BASE_PID=$!
    - sleep 10
    - curl --retry 5 --retry-delay 2 --retry-connrefused --fail http://localhost:8090/openapi.json -o /tmp/base-schema.json
    - kill $BASE_PID || true
    - sleep 2

    # Switch to PR branch
    - cd ..
    - git checkout ${CI_COMMIT_REF_NAME}

    # Start PR backend and download schema
    - cd olorin-server
    - poetry install --no-interaction --no-ansi
    - poetry run python -m app.local_server --port 8091 &
    - PR_PID=$!
    - sleep 10
    - curl --retry 5 --retry-delay 2 --retry-connrefused --fail http://localhost:8091/openapi.json -o /tmp/pr-schema.json
    - kill $PR_PID || true
    - sleep 2

    # Run breaking change detection
    - cd ../olorin-front
    - npm ci
    - npm run api:detect-breaking-changes /tmp/base-schema.json /tmp/pr-schema.json

    # Generate comparison report
    - npm run api:compare-schemas /tmp/base-schema.json /tmp/pr-schema.json > schema-comparison.md
  after_script:
    - pkill -f "python -m app.local_server" || true
  artifacts:
    when: always
    paths:
      - olorin-front/schema-comparison.md
    expire_in: 30 days
  only:
    - merge_requests
  allow_failure: false
