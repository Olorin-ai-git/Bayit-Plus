name: Validate No Build Artifacts

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  check-build-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for build artifacts in repository
        run: |
          echo "üîç Checking for build artifacts in git repository..."

          # Check if any build artifacts are tracked in git
          if git ls-files | grep -E '(build/|dist/|\.tsbuildinfo$)'; then
            echo ""
            echo "‚ùå ERROR: Build artifacts found in repository"
            echo ""
            echo "The following build artifacts should not be committed:"
            git ls-files | grep -E '(build/|dist/|\.tsbuildinfo$)'
            echo ""
            echo "Build artifacts should be:"
            echo "  1. Generated during build time (not stored in git)"
            echo "  2. Listed in .gitignore"
            echo "  3. Removed from git tracking if accidentally committed"
            echo ""
            echo "To fix this:"
            echo "  git rm -r --cached <file-or-directory>"
            echo "  git commit -m 'chore: remove build artifacts from git tracking'"
            echo ""
            exit 1
          fi

          echo "‚úÖ No build artifacts found in repository"
          echo "Repository is clean!"

      - name: Verify .gitignore contains build patterns
        run: |
          echo "üîç Verifying .gitignore includes build artifact patterns..."

          # Check for essential patterns
          REQUIRED_PATTERNS=(
            "build/"
            "dist/"
            "*.tsbuildinfo"
          )

          MISSING_PATTERNS=()
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              MISSING_PATTERNS+=("$pattern")
            fi
          done

          if [ ${#MISSING_PATTERNS[@]} -ne 0 ]; then
            echo "‚ö†Ô∏è  Warning: .gitignore missing recommended patterns:"
            printf '%s\n' "${MISSING_PATTERNS[@]}"
            echo ""
            echo "Consider adding these patterns to prevent build artifacts from being committed."
          else
            echo "‚úÖ .gitignore contains all essential build artifact patterns"
          fi
