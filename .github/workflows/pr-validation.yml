name: PR Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop]

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  POETRY_VERSION: "1.8.0"

jobs:
  detect-changes:
    name: Detect changed files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      web: ${{ steps.changes.outputs.web }}
      partner-portal: ${{ steps.changes.outputs.partner-portal }}
      mobile-app: ${{ steps.changes.outputs.mobile-app }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'packages/**'
            web:
              - 'web/**'
              - 'shared/**'
            partner-portal:
              - 'partner-portal/**'
              - 'shared/**'
            mobile-app:
              - 'mobile-app/**'
              - 'shared/**'

  backend-checks:
    name: Backend checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand(\"ping\").ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-

      - name: Install dependencies
        working-directory: backend
        run: poetry install --no-interaction

      - name: Run Black formatting check
        working-directory: backend
        run: poetry run black --check app tests
        continue-on-error: true

      - name: Run isort import sorting check
        working-directory: backend
        run: poetry run isort --check-only app tests
        continue-on-error: true

      - name: Run mypy type checking
        working-directory: backend
        run: poetry run mypy app --ignore-missing-imports

      - name: Run pytest with coverage
        working-directory: backend
        env:
          MONGODB_URL: mongodb://localhost:27017
          MONGODB_DB_NAME: bayit_test
          SECRET_KEY: ${{ github.run_id }}-${{ github.sha }}
          DEBUG: "true"
        run: |
          poetry run pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            -v \
            --tb=short

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  web-checks:
    name: Web app checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run linting
        working-directory: web
        run: npm run lint
        continue-on-error: true

      - name: Build production bundle
        working-directory: web
        run: npm run build

  partner-portal-checks:
    name: Partner Portal checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.partner-portal == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: partner-portal/package-lock.json

      - name: Install dependencies
        working-directory: partner-portal
        run: npm ci

      - name: Run linting
        working-directory: partner-portal
        run: npm run lint
        continue-on-error: true

      - name: Build production bundle
        working-directory: partner-portal
        run: npm run build

  mobile-app-checks:
    name: Mobile app checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.mobile-app == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: mobile-app/package-lock.json

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Run linting
        working-directory: mobile-app
        run: npm run lint
        continue-on-error: true

      - name: Type check
        working-directory: mobile-app
        run: npm run type-check || true

  pr-summary:
    name: PR validation summary
    runs-on: ubuntu-latest
    needs:
      [backend-checks, web-checks, partner-portal-checks, mobile-app-checks]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.web-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Partner Portal | ${{ needs.partner-portal-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile App | ${{ needs.mobile-app-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check critical failures
        if: |
          needs.backend-checks.result == 'failure' ||
          needs.web-checks.result == 'failure' ||
          needs.partner-portal-checks.result == 'failure' ||
          needs.mobile-app-checks.result == 'failure'
        run: |
          echo "Critical validation failed!"
          echo "Backend: ${{ needs.backend-checks.result }}"
          echo "Web: ${{ needs.web-checks.result }}"
          echo "Partner Portal: ${{ needs.partner-portal-checks.result }}"
          echo "Mobile App: ${{ needs.mobile-app-checks.result }}"
          exit 1
