# =============================================================================
# PR Validation Workflow
# =============================================================================
#
# Validates all pull requests and pushes to develop branch.
#
# Jobs:
#   - detect-changes: Identifies which components changed (backend/web/mobile/etc)
#   - backend-checks: Python quality gates (black, isort, mypy, pytest)
#   - web-checks: TypeScript/React validation for web app
#   - partner-portal-checks: Partner portal build validation
#   - mobile-app-checks: React Native mobile app checks
#   - container-security-scan: Trivy vulnerability scanning
#   - pr-summary: Aggregates results and reports status
#
# Required secrets:
#   - TURBO_TOKEN: Turborepo remote cache token (optional)
#
# Required variables:
#   - TURBO_TEAM: Turborepo team name (optional)
#
# =============================================================================

name: PR Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop]

# Explicit permissions for security (principle of least privilege)
permissions:
  contents: read
  pull-requests: read
  security-events: write

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  POETRY_VERSION: "1.8.0"
  # Turborepo remote cache configuration (requires TURBO_TOKEN secret)
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  detect-changes:
    name: Detect changed files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      web: ${{ steps.changes.outputs.web }}
      partner-portal: ${{ steps.changes.outputs.partner-portal }}
      mobile-app: ${{ steps.changes.outputs.mobile-app }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'packages/**'
            web:
              - 'web/**'
              - 'shared/**'
            partner-portal:
              - 'partner-portal/**'
              - 'shared/**'
            mobile-app:
              - 'mobile-app/**'
              - 'shared/**'

  backend-checks:
    name: Backend checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand(\"ping\").ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-

      - name: Install dependencies
        working-directory: backend
        run: poetry install --no-interaction

      - name: Run Black formatting check
        working-directory: backend
        run: poetry run black --check app tests

      - name: Run isort import sorting check
        working-directory: backend
        run: poetry run isort --check-only app tests

      - name: Run mypy type checking
        working-directory: backend
        run: poetry run mypy app --ignore-missing-imports

      - name: Run pytest with coverage
        working-directory: backend
        env:
          MONGODB_URL: mongodb://localhost:27017
          MONGODB_DB_NAME: bayit_test
          SECRET_KEY: ${{ github.run_id }}-${{ github.sha }}
          DEBUG: "true"
        run: |
          poetry run pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=87 \
            -v \
            --tb=short

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  web-checks:
    name: Web app checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run linting
        working-directory: web
        run: npm run lint

      - name: Build production bundle
        working-directory: web
        run: npm run build

  partner-portal-checks:
    name: Partner Portal checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.partner-portal == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: partner-portal/package-lock.json

      - name: Install dependencies
        working-directory: partner-portal
        run: npm ci

      - name: Run linting
        working-directory: partner-portal
        run: npm run lint

      - name: Build production bundle
        working-directory: partner-portal
        run: npm run build

  mobile-app-checks:
    name: Mobile app checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.mobile-app == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: mobile-app/package-lock.json

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Run linting
        working-directory: mobile-app
        run: npm run lint

      - name: Type check
        working-directory: mobile-app
        run: npm run type-check

  container-security-scan:
    name: Container security scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        working-directory: backend
        run: docker build -t bayit-backend:scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: "bayit-backend:scan"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "1"
          ignore-unfixed: true

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Trivy in table format (for PR comment)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: "bayit-backend:scan"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"
          ignore-unfixed: true

  pr-summary:
    name: PR validation summary
    runs-on: ubuntu-latest
    needs:
      [backend-checks, web-checks, partner-portal-checks, mobile-app-checks, container-security-scan]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.web-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Partner Portal | ${{ needs.partner-portal-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile App | ${{ needs.mobile-app-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Security | ${{ needs.container-security-scan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check critical failures
        if: |
          needs.backend-checks.result == 'failure' ||
          needs.web-checks.result == 'failure' ||
          needs.partner-portal-checks.result == 'failure' ||
          needs.mobile-app-checks.result == 'failure' ||
          needs.container-security-scan.result == 'failure'
        run: |
          echo "Critical validation failed!"
          echo "Backend: ${{ needs.backend-checks.result }}"
          echo "Web: ${{ needs.web-checks.result }}"
          echo "Partner Portal: ${{ needs.partner-portal-checks.result }}"
          echo "Mobile App: ${{ needs.mobile-app-checks.result }}"
          echo "Container Security: ${{ needs.container-security-scan.result }}"
          exit 1
