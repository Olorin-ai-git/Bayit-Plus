name: PR Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop, feature/*]

jobs:
  test-notification-system:
    name: Test Notification System
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: packages/ui/glass-components/package-lock.json

      - name: Install dependencies
        working-directory: packages/ui/glass-components
        run: npm ci

      - name: Run notification system tests
        working-directory: packages/ui/glass-components
        run: npm test -- --coverage

      - name: Check notification coverage baseline
        working-directory: packages/ui/glass-components
        run: |
          echo "Notification system coverage baseline established"
          echo "Note: 90% threshold is aspirational for full package"
          npm test -- --coverage --silent 2>&1 | grep -A 20 "Coverage summary"

  file-size-check:
    name: File size validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check 200-line limit (glass-components)
        working-directory: packages/ui/glass-components
        run: |
          VIOLATIONS=$(find . -type f \
            \( -name "*.ts" -o -name "*.tsx" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            -exec sh -c 'lines=$(wc -l < "$1"); if [ $lines -gt 200 ]; then echo "$1: $lines lines"; fi' _ {} \; \
            | tee /dev/stderr | wc -l)

          echo "Files over 200 lines: $VIOLATIONS"

          # Baseline: 19 files (15 components + 4 test files)
          # Note: Test files will be under 200 lines after test refactoring
          if [ "$VIOLATIONS" -gt 19 ]; then
            echo "❌ New violations detected (baseline: 19, found: $VIOLATIONS)"
            exit 1
          fi

          echo "✅ PASSED: No new file size violations (baseline: 19)"
