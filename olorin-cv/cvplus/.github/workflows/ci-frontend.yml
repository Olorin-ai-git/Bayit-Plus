name: Frontend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/ci-frontend.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/ci-frontend.yml'

env:
  NODE_VERSION: '20'
  CACHE_DEPENDENCY_PATH: 'frontend/package-lock.json'
  WORKING_DIR: frontend

jobs:
  install-and-cache:
    name: Install Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

    - name: Install Dependencies
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Installing dependencies..."
        npm ci
        echo "✅ Dependencies installed"

    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    needs: install-and-cache

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

    - name: Restore node_modules Cache
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

    - name: Install Dependencies (if cache miss)
      working-directory: ${{ env.WORKING_DIR }}
      run: npm ci

    - name: Run TypeScript Type Check
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running TypeScript type check..."
        npm run type-check
        echo "✅ Type check passed"

  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    needs: install-and-cache

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

    - name: Restore node_modules Cache
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

    - name: Install Dependencies (if cache miss)
      working-directory: ${{ env.WORKING_DIR }}
      run: npm ci

    - name: Run ESLint
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running ESLint..."
        npm run lint
        echo "✅ ESLint check passed"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: install-and-cache

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

    - name: Restore node_modules Cache
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

    - name: Install Dependencies (if cache miss)
      working-directory: ${{ env.WORKING_DIR }}
      run: npm ci

    - name: Run Tests with Coverage
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running tests with coverage..."
        npm run test:coverage
        echo "✅ Tests completed"

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ${{ env.WORKING_DIR }}/coverage/coverage-final.json
        flags: frontend
        name: frontend-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage-reports
        path: ${{ env.WORKING_DIR }}/coverage/
        retention-days: 30

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [type-check, lint, test]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

    - name: Restore node_modules Cache
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

    - name: Install Dependencies (if cache miss)
      working-directory: ${{ env.WORKING_DIR }}
      run: npm ci

    - name: Build Application
      working-directory: ${{ env.WORKING_DIR }}
      env:
        NODE_ENV: production
      run: |
        echo "Building application..."
        npm run build
        echo "✅ Build completed"

    - name: Verify Build Output
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Verifying build output..."

        if [ ! -d "dist" ]; then
          echo "❌ dist directory not found"
          exit 1
        fi

        if [ ! -f "dist/index.html" ]; then
          echo "❌ index.html not found in dist"
          exit 1
        fi

        echo "✅ Build output verified"

    - name: Bundle Size Analysis
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Analyzing bundle size..."

        BUNDLE_SIZE=$(du -sb dist/ | cut -f1)
        BUNDLE_SIZE_MB=$(echo "scale=2; $BUNDLE_SIZE / 1048576" | bc)

        echo "Total bundle size: ${BUNDLE_SIZE} bytes (${BUNDLE_SIZE_MB} MB)"

        # Bundle size threshold (5MB = 5242880 bytes)
        THRESHOLD=5242880

        if [ "$BUNDLE_SIZE" -gt "$THRESHOLD" ]; then
          echo "⚠️ Bundle size (${BUNDLE_SIZE_MB} MB) exceeds 5MB threshold"
          echo "::warning::Frontend bundle size exceeds 5MB"
        else
          echo "✅ Bundle size within acceptable limits"
        fi

        # List largest files
        echo ""
        echo "Largest bundle files:"
        find dist -type f -exec du -h {} + | sort -rh | head -10

        # Save bundle size for later use
        echo "BUNDLE_SIZE=${BUNDLE_SIZE}" >> $GITHUB_ENV
        echo "BUNDLE_SIZE_MB=${BUNDLE_SIZE_MB}" >> $GITHUB_ENV

    - name: Security Scan Build Output
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Scanning build output for security issues..."

        # Check for console statements in production
        if find dist -name "*.js" -exec grep -l "console\." {} \; | head -1; then
          echo "⚠️ Console statements found in production build"
          echo "::warning::Console statements detected in production bundle"
        else
          echo "✅ No console statements in production build"
        fi

        # Check for source maps (should not be in production)
        if find dist -name "*.map" | head -1; then
          echo "⚠️ Source maps found in production build"
          echo "::warning::Source maps should not be included in production"
        else
          echo "✅ No source maps in production build"
        fi

        # Check for hardcoded secrets patterns
        SECRET_PATTERNS="sk-ant|apiKey.*['\"][A-Za-z0-9]{20,}|api_key.*['\"][A-Za-z0-9]{20,}"

        if find dist -name "*.js" -exec grep -E "$SECRET_PATTERNS" {} \; | head -1; then
          echo "❌ Potential secrets found in build output"
          exit 1
        else
          echo "✅ No hardcoded secrets detected"
        fi

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build-artifacts
        path: ${{ env.WORKING_DIR }}/dist/
        retention-days: 7

    - name: Generate Build Report
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "# Frontend Build Report" > build-report.md
        echo "" >> build-report.md
        echo "**Date**: $(date -u)" >> build-report.md
        echo "**Node Version**: ${{ env.NODE_VERSION }}" >> build-report.md
        echo "**Bundle Size**: ${BUNDLE_SIZE_MB} MB" >> build-report.md
        echo "**File Count**: $(find dist -type f | wc -l)" >> build-report.md
        echo "" >> build-report.md
        echo "## Build Summary" >> build-report.md
        echo "- ✅ TypeScript compilation successful" >> build-report.md
        echo "- ✅ ESLint validation passed" >> build-report.md
        echo "- ✅ Tests passed with coverage" >> build-report.md
        echo "- ✅ Production build completed" >> build-report.md
        echo "- ✅ Security scan passed" >> build-report.md
        echo "" >> build-report.md
        echo "## Bundle Analysis" >> build-report.md
        echo "\`\`\`" >> build-report.md
        find dist -name "*.js" -o -name "*.css" | head -10 | while read file; do
          SIZE=$(du -h "$file" | cut -f1)
          echo "$file: $SIZE" >> build-report.md
        done
        echo "\`\`\`" >> build-report.md

    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build-report
        path: ${{ env.WORKING_DIR }}/build-report.md

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [type-check, lint, test, build]
    if: always()

    steps:
    - name: Generate CI Summary
      run: |
        echo "# ⚛️ Frontend CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "**Node Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Type Check | ${{ needs.type-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        if [ "${{ needs.type-check.result }}" = "success" ] && \
           [ "${{ needs.lint.result }}" = "success" ] && \
           [ "${{ needs.test.result }}" = "success" ] && \
           [ "${{ needs.build.result }}" = "success" ]; then
          echo "## ✅ All Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "Frontend is ready for deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ❌ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
        fi
