name: Audio Services CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/functions/src/services/audio/**'
      - 'backend/functions/src/config/**'
      - '.github/workflows/ci-audio-services.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/functions/src/services/audio/**'
      - 'backend/functions/src/config/**'
      - '.github/workflows/ci-audio-services.yml'

env:
  NODE_VERSION: '20'
  COVERAGE_THRESHOLD: 87
  WORKING_DIR: 'backend/functions'

jobs:
  lint-and-format:
    name: TypeScript Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: ESLint Check
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Running ESLint..."
          npm run lint -- src/services/audio src/config/i18n.config.ts src/services/olorin-integration.service.ts
          echo "âœ… ESLint passed"

      - name: Prettier Format Check
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Running Prettier..."
          npm run format:check -- src/services/audio src/config/i18n.config.ts src/services/olorin-integration.service.ts
          echo "âœ… Prettier check passed"

  type-check:
    name: TypeScript Type Checking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: TypeScript Compilation
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Running TypeScript compiler..."
          npm run build
          echo "âœ… TypeScript compilation passed"

      - name: Type Checking
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Running type-check..."
          npm run type-check
          echo "âœ… Type checking passed"

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Run Tests with Coverage
        working-directory: ${{ env.WORKING_DIR }}
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://testuser:testpass@localhost:27017/cvplus_test?authSource=admin
          REDIS_URL: redis://localhost:6379
          GCP_PROJECT_ID: cvplus-test
        run: |
          echo "Running test suite with coverage..."
          npm test -- --coverage --testPathPattern="services/audio|services/olorin-integration|config/i18n" --collectCoverageFrom="src/services/audio/**/*.ts,src/services/olorin-integration.service.ts,src/config/i18n.config.ts"
          echo "âœ… Tests completed"

      - name: Check Coverage Threshold
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Checking coverage threshold..."
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Current coverage: ${COVERAGE}%"
          echo "Threshold: ${{ env.COVERAGE_THRESHOLD }}%"
          if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "âŒ Coverage (${COVERAGE}%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
            exit 1
          else
            echo "âœ… Coverage threshold met"
          fi

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ${{ env.WORKING_DIR }}/coverage/coverage-final.json
          flags: audio-services
          name: audio-services-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-audio
          path: ${{ env.WORKING_DIR }}/coverage/
          retention-days: 30

  audio-validation:
    name: Audio Service Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Verify Audio Service File Sizes
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Checking audio service file sizes (max 200 lines)..."
          for file in src/services/audio/*.ts src/services/olorin-integration.service.ts; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              if [ "$lines" -gt 200 ]; then
                echo "âŒ $file exceeds 200 lines ($lines lines)"
                exit 1
              else
                echo "âœ… $file: $lines lines"
              fi
            fi
          done

      - name: Verify No Stubs or TODOs
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Checking for stubs and TODOs in audio services..."
          FORBIDDEN_PATTERNS="TODO|FIXME|STUB|MOCK|FAKE|DUMMY|PLACEHOLDER|NotImplemented"
          if grep -r -E "$FORBIDDEN_PATTERNS" src/services/audio/ src/services/olorin-integration.service.ts src/config/i18n.config.ts 2>/dev/null | grep -v "node_modules"; then
            echo "âŒ Found forbidden patterns (TODO, STUB, MOCK, etc)"
            exit 1
          else
            echo "âœ… No forbidden patterns found"
          fi

      - name: Verify Configuration Externalization
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Checking for hardcoded values in audio services..."
          HARDCODED_PATTERNS="'https?://[a-z]|\"https?://[a-z]|= ['\"]?[0-9]{1,4}['\"]?|= ['\"]?(prod|staging|dev)['\"]?"
          if grep -r -E "$HARDCODED_PATTERNS" src/services/audio/ --include="*.ts" 2>/dev/null | grep -v "node_modules" | grep -v ".example"; then
            echo "âš ï¸ Potential hardcoded values detected - verify these are not secrets/IPs"
          else
            echo "âœ… No obvious hardcoded values found"
          fi

  build-and-deploy:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check, test, audio-validation]
    if: success()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'

      - name: Build
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Building application..."
          npm run build
          echo "âœ… Build completed"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Building Docker image..."
          docker build --platform linux/amd64 -t cvplus-backend:audio-v7 .
          echo "âœ… Docker image built"

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check, test, audio-validation, build-and-deploy]
    if: always()

    steps:
      - name: Generate CI Summary
        run: |
          echo "# ðŸŽµ Audio Services CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Node Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage Threshold**: ${{ env.COVERAGE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Format | ${{ needs.lint-and-format.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.type-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Audio Validation | ${{ needs.audio-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Docker | ${{ needs.build-and-deploy.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint-and-format.result }}" = "success" ] && \
             [ "${{ needs.type-check.result }}" = "success" ] && \
             [ "${{ needs.test.result }}" = "success" ] && \
             [ "${{ needs.audio-validation.result }}" = "success" ] && \
             [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "## âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
            echo "Audio services are production-ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
          fi
