name: Backend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'python-backend/**'
      - '.github/workflows/ci-backend.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'python-backend/**'
      - '.github/workflows/ci-backend.yml'

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.7.1'
  COVERAGE_THRESHOLD: 87
  WORKING_DIR: python-backend

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Poetry Installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/poetry
          ~/.local/share/pypoetry
        key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Configure Poetry
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/.venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

    - name: Install Dependencies
      working-directory: ${{ env.WORKING_DIR }}
      run: poetry install --no-interaction --no-ansi

    - name: Black Format Check
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running Black format check..."
        poetry run black --check .
        echo "âœ… Black format check passed"

    - name: isort Import Check
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running isort import check..."
        poetry run isort --check .
        echo "âœ… isort check passed"

    - name: Ruff Linting
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running Ruff linting..."
        poetry run ruff check .
        echo "âœ… Ruff linting passed"

  type-check:
    name: Type Checking
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Poetry Installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/poetry
          ~/.local/share/pypoetry
        key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Configure Poetry
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/.venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

    - name: Install Dependencies
      working-directory: ${{ env.WORKING_DIR }}
      run: poetry install --no-interaction --no-ansi

    - name: mypy Type Checking
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running mypy type checking..."
        poetry run mypy app/ --ignore-missing-imports
        echo "âœ… mypy type checking passed"

  test:
    name: Test Suite
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Poetry Installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/poetry
          ~/.local/share/pypoetry
        key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Configure Poetry
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKING_DIR }}/.venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

    - name: Install Dependencies
      working-directory: ${{ env.WORKING_DIR }}
      run: poetry install --no-interaction --no-ansi

    - name: Run Tests with Coverage
      working-directory: ${{ env.WORKING_DIR }}
      env:
        MONGODB_URI: mongodb://test:test@localhost:27017/cvplus_test?authSource=admin
        APP_ENV: test
        JWT_SECRET_KEY: test-secret-key-for-ci
        JWT_EXPIRY_HOURS: 24
      run: |
        echo "Running test suite with coverage..."
        poetry run pytest --cov=app --cov-report=xml --cov-report=html --cov-report=term-missing -v
        echo "âœ… Tests completed"

    - name: Check Coverage Threshold
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Checking coverage threshold..."
        COVERAGE=$(poetry run coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
        echo "Current coverage: ${COVERAGE}%"
        echo "Threshold: ${{ env.COVERAGE_THRESHOLD }}%"

        if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
          echo "âŒ Coverage (${COVERAGE}%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
          exit 1
        else
          echo "âœ… Coverage threshold met"
        fi

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ${{ env.WORKING_DIR }}/coverage.xml
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          ${{ env.WORKING_DIR }}/coverage.xml
          ${{ env.WORKING_DIR }}/htmlcov/
        retention-days: 30

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Poetry Installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/poetry
          ~/.local/share/pypoetry
        key: poetry-${{ env.POETRY_VERSION }}-${{ runner.os }}

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Security Audit
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Running Poetry security audit..."
        poetry export -f requirements.txt --output requirements.txt --without-hashes
        pip install safety
        safety check --file requirements.txt --json > safety-report.json || true

        # Parse results
        VULNS=$(cat safety-report.json | jq '. | length')
        echo "Vulnerabilities found: $VULNS"

        if [ "$VULNS" -gt "0" ]; then
          echo "âš ï¸ Security vulnerabilities detected"
          cat safety-report.json | jq '.'
        else
          echo "âœ… No security vulnerabilities found"
        fi

    - name: Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: ${{ env.WORKING_DIR }}/safety-report.json
        retention-days: 30

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check, test]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Building Docker image..."
        docker build --platform linux/amd64 -t cvplus-backend:test .
        echo "âœ… Docker image built successfully"

    - name: Test Docker Image
      run: |
        echo "Testing Docker image..."

        # Start container
        docker run -d --name test-backend \
          -e APP_ENV=test \
          -e JWT_SECRET_KEY=test-secret \
          -e MONGODB_URI=mongodb://localhost:27017/test \
          -p 8080:8080 \
          cvplus-backend:test

        # Wait for startup
        sleep 10

        # Health check
        if curl -f http://localhost:8080/health; then
          echo "âœ… Docker container health check passed"
        else
          echo "âŒ Docker container health check failed"
          docker logs test-backend
          exit 1
        fi

        # Cleanup
        docker stop test-backend
        docker rm test-backend

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check, test, security-scan, build-docker]
    if: always()

    steps:
    - name: Generate CI Summary
      run: |
        echo "# ðŸ Backend CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Coverage Threshold**: ${{ env.COVERAGE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lint & Format | ${{ needs.lint-and-format.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Type Check | ${{ needs.type-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | ${{ needs.build-docker.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        if [ "${{ needs.lint-and-format.result }}" = "success" ] && \
           [ "${{ needs.type-check.result }}" = "success" ] && \
           [ "${{ needs.test.result }}" = "success" ] && \
           [ "${{ needs.security-scan.result }}" = "success" ] && \
           [ "${{ needs.build-docker.result }}" = "success" ]; then
          echo "## âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "Backend is ready for deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
        fi
