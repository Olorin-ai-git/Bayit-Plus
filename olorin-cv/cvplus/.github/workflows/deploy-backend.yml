name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'python-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.7.1'
  GCP_REGION: 'us-central1'
  WORKING_DIR: python-backend
  TARGET_ENV: ${{ github.event.inputs.environment || 'production' }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.image-tag.outputs.tag }}
      image_url: ${{ steps.image-tag.outputs.url }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker gcr.io

    - name: Determine Image Tag
      id: image-tag
      run: |
        GIT_SHA=$(git rev-parse --short HEAD)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        IMAGE_TAG="${TIMESTAMP}-${GIT_SHA}"

        case "${{ env.TARGET_ENV }}" in
          "production")
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_PROD }}"
            ;;
          "staging")
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_STAGING }}"
            ;;
          "development")
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_DEV }}"
            ;;
          *)
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_PROD }}"
            ;;
        esac

        IMAGE_URL="gcr.io/${GCP_PROJECT}/cvplus-backend:${IMAGE_TAG}"

        echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "url=${IMAGE_URL}" >> $GITHUB_OUTPUT
        echo "project=${GCP_PROJECT}" >> $GITHUB_OUTPUT

        echo "Image will be tagged as: ${IMAGE_TAG}"
        echo "Full image URL: ${IMAGE_URL}"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and Push Docker Image
      working-directory: ${{ env.WORKING_DIR }}
      env:
        IMAGE_URL: ${{ steps.image-tag.outputs.url }}
      run: |
        echo "Building Docker image..."

        docker build \
          --platform linux/amd64 \
          --tag ${IMAGE_URL} \
          --tag gcr.io/${{ steps.image-tag.outputs.project }}/cvplus-backend:latest \
          --tag gcr.io/${{ steps.image-tag.outputs.project }}/cvplus-backend:${{ env.TARGET_ENV }} \
          --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
          --build-arg GIT_SHA=$(git rev-parse --short HEAD) \
          --build-arg VERSION=${{ steps.image-tag.outputs.tag }} \
          .

        echo "Pushing Docker image to GCR..."
        docker push ${IMAGE_URL}
        docker push gcr.io/${{ steps.image-tag.outputs.project }}/cvplus-backend:latest
        docker push gcr.io/${{ steps.image-tag.outputs.project }}/cvplus-backend:${{ env.TARGET_ENV }}

        echo "âœ… Docker image pushed successfully"

    - name: Generate Build Metadata
      run: |
        echo "# Backend Build Metadata" > build-metadata.json
        echo "{" >> build-metadata.json
        echo '  "image_tag": "${{ steps.image-tag.outputs.tag }}",' >> build-metadata.json
        echo '  "image_url": "${{ steps.image-tag.outputs.url }}",' >> build-metadata.json
        echo '  "git_sha": "'$(git rev-parse HEAD)'",' >> build-metadata.json
        echo '  "build_date": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",' >> build-metadata.json
        echo '  "environment": "${{ env.TARGET_ENV }}",' >> build-metadata.json
        echo '  "python_version": "${{ env.PYTHON_VERSION }}"' >> build-metadata.json
        echo "}" >> build-metadata.json

    - name: Upload Build Metadata
      uses: actions/upload-artifact@v4
      with:
        name: build-metadata-${{ env.TARGET_ENV }}
        path: build-metadata.json
        retention-days: 90

  deploy-cloud-run:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Deployment
      id: config
      run: |
        case "${{ env.TARGET_ENV }}" in
          "production")
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_PROD }}"
            SERVICE_NAME="cvplus-backend"
            MIN_INSTANCES=1
            MAX_INSTANCES=10
            MEMORY="1Gi"
            CPU=1
            ;;
          "staging")
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_STAGING }}"
            SERVICE_NAME="cvplus-backend-staging"
            MIN_INSTANCES=0
            MAX_INSTANCES=5
            MEMORY="512Mi"
            CPU=1
            ;;
          "development")
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_DEV }}"
            SERVICE_NAME="cvplus-backend-dev"
            MIN_INSTANCES=0
            MAX_INSTANCES=2
            MEMORY="512Mi"
            CPU=1
            ;;
          *)
            GCP_PROJECT="${{ secrets.GCP_PROJECT_ID_PROD }}"
            SERVICE_NAME="cvplus-backend"
            MIN_INSTANCES=1
            MAX_INSTANCES=10
            MEMORY="1Gi"
            CPU=1
            ;;
        esac

        echo "project=${GCP_PROJECT}" >> $GITHUB_OUTPUT
        echo "service=${SERVICE_NAME}" >> $GITHUB_OUTPUT
        echo "min_instances=${MIN_INSTANCES}" >> $GITHUB_OUTPUT
        echo "max_instances=${MAX_INSTANCES}" >> $GITHUB_OUTPUT
        echo "memory=${MEMORY}" >> $GITHUB_OUTPUT
        echo "cpu=${CPU}" >> $GITHUB_OUTPUT

        echo "Deployment Configuration:"
        echo "- Project: ${GCP_PROJECT}"
        echo "- Service: ${SERVICE_NAME}"
        echo "- Min Instances: ${MIN_INSTANCES}"
        echo "- Max Instances: ${MAX_INSTANCES}"
        echo "- Memory: ${MEMORY}"
        echo "- CPU: ${CPU}"

    - name: Deploy to Cloud Run
      id: deploy
      env:
        IMAGE_URL: ${{ needs.build-and-push.outputs.image_url }}
      run: |
        echo "Deploying to Cloud Run..."

        gcloud run deploy ${{ steps.config.outputs.service }} \
          --image ${IMAGE_URL} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --project ${{ steps.config.outputs.project }} \
          --allow-unauthenticated \
          --memory ${{ steps.config.outputs.memory }} \
          --cpu ${{ steps.config.outputs.cpu }} \
          --min-instances ${{ steps.config.outputs.min_instances }} \
          --max-instances ${{ steps.config.outputs.max_instances }} \
          --timeout 300 \
          --set-env-vars="APP_ENV=${{ env.TARGET_ENV }},PORT=8080" \
          --set-secrets="JWT_SECRET_KEY=JWT_SECRET_KEY:latest,MONGODB_URI=MONGODB_URI:latest,ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest" \
          --service-account=${{ steps.config.outputs.service }}@${{ steps.config.outputs.project }}.iam.gserviceaccount.com \
          --quiet

        echo "âœ… Deployment successful"

    - name: Get Service URL
      id: service-url
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ steps.config.outputs.service }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --project ${{ steps.config.outputs.project }} \
          --format 'value(status.url)')

        echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
        echo "Service URL: ${SERVICE_URL}"

    - name: Configure Traffic Split (Production Only)
      if: env.TARGET_ENV == 'production'
      run: |
        echo "Configuring gradual traffic rollout..."

        # Get current revision
        CURRENT_REVISION=$(gcloud run services describe ${{ steps.config.outputs.service }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --project ${{ steps.config.outputs.project }} \
          --format 'value(status.latestReadyRevisionName)')

        echo "Current revision: ${CURRENT_REVISION}"

        # Initial 10% traffic to new revision
        gcloud run services update-traffic ${{ steps.config.outputs.service }} \
          --to-revisions=${CURRENT_REVISION}=10 \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --project ${{ steps.config.outputs.project }}

        echo "âœ… Traffic split configured: 10% to new revision"
        echo "Monitor metrics before full rollout"

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-cloud-run]

    steps:
    - name: Wait for Deployment Propagation
      run: |
        echo "Waiting for deployment to propagate..."
        sleep 30

    - name: Perform Health Check
      run: |
        SERVICE_URL="${{ needs.deploy-cloud-run.outputs.service-url }}"

        echo "Performing health check on: ${SERVICE_URL}/health"

        MAX_RETRIES=5
        RETRY_COUNT=0

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f -s "${SERVICE_URL}/health" > /dev/null; then
            echo "âœ… Health check passed"
            exit 0
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check failed (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
            sleep 10
          fi
        done

        echo "âŒ Health check failed after ${MAX_RETRIES} attempts"
        exit 1

    - name: Verify API Endpoints
      run: |
        SERVICE_URL="${{ needs.deploy-cloud-run.outputs.service-url }}"

        echo "Verifying API endpoints..."

        # Check health endpoint
        if curl -f -s "${SERVICE_URL}/health" | grep -q "healthy"; then
          echo "âœ… Health endpoint responding correctly"
        else
          echo "âš ï¸ Health endpoint response unexpected"
        fi

        # Check API docs
        if curl -f -s "${SERVICE_URL}/api/docs" > /dev/null; then
          echo "âœ… API documentation accessible"
        else
          echo "âš ï¸ API documentation not accessible"
        fi

        # Check root endpoint
        if curl -f -s "${SERVICE_URL}/" > /dev/null; then
          echo "âœ… Root endpoint accessible"
        else
          echo "âš ï¸ Root endpoint not accessible"
        fi

  rollback-preparation:
    name: Prepare Rollback
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-cloud-run]
    if: failure()

    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: List Previous Revisions
      run: |
        echo "Listing previous revisions for rollback..."

        gcloud run revisions list \
          --service=cvplus-backend \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --limit 5 \
          --format="table(metadata.name,status.conditions[0].status,metadata.creationTimestamp)"

    - name: Prepare Rollback Instructions
      run: |
        echo "# ðŸ”„ Backend Rollback Instructions" > rollback-instructions.md
        echo "" >> rollback-instructions.md
        echo "## Automatic Rollback Command" >> rollback-instructions.md
        echo "" >> rollback-instructions.md
        echo '```bash' >> rollback-instructions.md
        echo "# List revisions" >> rollback-instructions.md
        echo "gcloud run revisions list --service=cvplus-backend --region=${{ env.GCP_REGION }}" >> rollback-instructions.md
        echo "" >> rollback-instructions.md
        echo "# Rollback to previous revision" >> rollback-instructions.md
        echo "gcloud run services update-traffic cvplus-backend \\" >> rollback-instructions.md
        echo "  --to-revisions=PREVIOUS_REVISION=100 \\" >> rollback-instructions.md
        echo "  --platform managed \\" >> rollback-instructions.md
        echo "  --region ${{ env.GCP_REGION }}" >> rollback-instructions.md
        echo '```' >> rollback-instructions.md
        echo "" >> rollback-instructions.md
        echo "## Steps" >> rollback-instructions.md
        echo "1. Identify the last stable revision from the list above" >> rollback-instructions.md
        echo "2. Run the rollback command with the revision name" >> rollback-instructions.md
        echo "3. Verify health checks pass after rollback" >> rollback-instructions.md
        echo "4. Monitor application logs and metrics" >> rollback-instructions.md

    - name: Upload Rollback Instructions
      uses: actions/upload-artifact@v4
      with:
        name: rollback-instructions-${{ env.TARGET_ENV }}
        path: rollback-instructions.md

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-cloud-run, health-check]
    if: always()

    steps:
    - name: Generate Deployment Summary
      run: |
        echo "# ðŸš€ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ env.TARGET_ENV }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: ${{ needs.build-and-push.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Service URL**: ${{ needs.deploy-cloud-run.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Push | ${{ needs.build-and-push.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy | ${{ needs.deploy-cloud-run.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Health Check | ${{ needs.health-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        if [ "${{ needs.build-and-push.result }}" = "success" ] && \
           [ "${{ needs.deploy-cloud-run.result }}" = "success" ] && \
           [ "${{ needs.health-check.result }}" = "success" ]; then
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Backend has been deployed successfully to ${{ env.TARGET_ENV }}." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **Service**: ${{ needs.deploy-cloud-run.outputs.service-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥ **Health**: ${{ needs.deploy-cloud-run.outputs.service-url }}/health" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“– **API Docs**: ${{ needs.deploy-cloud-run.outputs.service-url }}/api/docs" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the logs and consider rollback if necessary." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor application logs and metrics" >> $GITHUB_STEP_SUMMARY
        echo "- Verify API endpoints functionality" >> $GITHUB_STEP_SUMMARY
        echo "- Check error rates and latency" >> $GITHUB_STEP_SUMMARY
        echo "- Complete traffic rollout if gradual deployment" >> $GITHUB_STEP_SUMMARY
