name: Production Monitoring Setup

on:
  workflow_dispatch:  # Manual trigger for initial setup
  push:
    branches: [main]
    paths:
      - '.github/workflows/monitoring-setup.yml'

env:
  GCP_REGION: us-central1

jobs:
  setup-monitoring:
    name: Configure Cloud Monitoring
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID_PROD }}

      - name: Create Uptime Check - Backend Health
        run: |
          gcloud monitoring uptime-checks create \
            --display-name="CVPlus Backend Health Check" \
            --check-interval=60 \
            --timeout=10 \
            --content-type=URL_CONTENT_TYPE_UNSPECIFIED \
            --http-check-path="/health" \
            --http-check-port=443 \
            --http-check-request-method=GET \
            --resource-type=uptime-url \
            --use-ssl \
            --custom-content-type="" \
            --resource-labels="host=cvplus-backend-prod.run.app" \
            || echo "Uptime check may already exist"

      - name: Create Uptime Check - Frontend
        run: |
          gcloud monitoring uptime-checks create \
            --display-name="CVPlus Frontend Health Check" \
            --check-interval=60 \
            --timeout=10 \
            --content-type=URL_CONTENT_TYPE_UNSPECIFIED \
            --http-check-path="/" \
            --http-check-port=443 \
            --http-check-request-method=GET \
            --resource-type=uptime-url \
            --use-ssl \
            --custom-content-type="" \
            --resource-labels="host=cvplus.olorin.ai" \
            || echo "Uptime check may already exist"

      - name: Create Alert Policy - High Error Rate
        run: |
          gcloud alpha monitoring policies create \
            --notification-channels="${{ secrets.ALERT_CHANNEL_ID }}" \
            --display-name="CVPlus High Error Rate" \
            --condition-display-name="Error Rate > 5%" \
            --condition-threshold-value=0.05 \
            --condition-threshold-duration=300s \
            --condition-threshold-comparison=COMPARISON_GT \
            || echo "Alert policy may already exist"

      - name: Create Alert Policy - High Latency
        run: |
          gcloud alpha monitoring policies create \
            --notification-channels="${{ secrets.ALERT_CHANNEL_ID }}" \
            --display-name="CVPlus High API Latency" \
            --condition-display-name="95th Percentile Latency > 2s" \
            --condition-threshold-value=2000 \
            --condition-threshold-duration=300s \
            --condition-threshold-comparison=COMPARISON_GT \
            || echo "Alert policy may already exist"

      - name: Monitoring Setup Complete
        run: |
          echo "âœ… Production monitoring infrastructure configured"
          echo "- Uptime checks: Backend + Frontend"
          echo "- Alert policies: Error rate + Latency"
          echo "- Notification channels: Connected"
