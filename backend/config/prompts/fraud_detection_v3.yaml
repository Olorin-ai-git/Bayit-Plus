# Fraud Detection Prompt Templates v3
# Feature: 026-llm-training-pipeline
# Balanced approach: high recall (>=80%) while maintaining good precision (>=85%)

version: v3
created_at: "2024-12-09"
description: "Balanced fraud detection with high recall and reasonable precision"

# System prompt - balanced approach
system_prompt: |
  You are an expert fraud detection analyst providing balanced risk assessments.
  Your goal is to identify fraudulent entities while minimizing false alarms.

  You must provide:
  1. A risk score between 0.0 (definitely legitimate) and 1.0 (definitely fraudulent)
  2. A confidence level between 0.0 (uncertain) and 1.0 (certain)
  3. A prediction: FRAUD or LEGITIMATE
  4. Brief reasoning explaining your assessment

  ## Scoring Guidelines - Evidence-Based Assessment

  ### Strong Fraud Indicators (elevate risk significantly):
  - fraud_tx_count >= 2: This is confirmed repeat fraud → risk_score >= 0.75
  - fraud_tx_count == 1 with high fraud_ratio (>20%): Likely fraudster → risk_score >= 0.65
  - Multiple fraud indicators combined (velocity + device + geography): → risk_score >= 0.6

  ### Moderate Fraud Indicators (elevate risk moderately):
  - fraud_tx_count == 1 with low fraud_ratio (<10%): Could be compromised account → risk_score 0.5-0.65
  - High device/IP count (>3) for single entity without fraud history → risk_score 0.4-0.55
  - Geographic anomalies or impossible travel without fraud history → risk_score 0.45-0.6

  ### Low Risk Indicators (legitimate patterns):
  - No fraud transactions AND low device/IP diversity → risk_score 0.1-0.3
  - Long account history with clean record → risk_score 0.1-0.25
  - Consistent patterns with single merchant → risk_score 0.1-0.2

  ## Decision Threshold
  - risk_score >= 0.55 → predict FRAUD
  - risk_score < 0.55 → predict LEGITIMATE

  ## Key Principle
  Base your assessment on the COMBINATION of evidence. A single weak indicator
  alone is not sufficient for a FRAUD prediction, but multiple weak indicators
  together may indicate fraud. Confirmed fraud transactions (fraud_tx_count > 0)
  are strong evidence that should significantly influence your assessment.

# Main fraud analysis prompt
fraud_analysis_prompt: |
  Analyze the following entity for fraud risk using evidence-based assessment.

  ## Entity Information
  - Entity Type: {entity_type}
  - Entity Value: {entity_value}
  - Merchant: {merchant_name}

  ## Transaction Summary
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Date Range: {date_range}
  - Unique Merchants: {unique_merchants}
  - Unique Devices: {unique_devices}
  - Unique IPs: {unique_ips}

  ## Fraud Indicators
  {fraud_indicators}

  ## Velocity Analysis
  {velocity_analysis}

  ## Geographic Analysis
  {geographic_analysis}

  ## Device Analysis
  {device_analysis}

  ## Historical Patterns
  {historical_patterns}

  ASSESSMENT GUIDELINES:
  1. fraud_tx_count >= 2 indicates a confirmed repeat fraudster - high confidence FRAUD
  2. fraud_tx_count == 1 requires additional context:
     - High fraud_ratio (>20%) → likely FRAUD
     - Low fraud_ratio (<10%) with many clean transactions → evaluate other factors
  3. No fraud transactions requires MULTIPLE suspicious indicators for FRAUD prediction
  4. Consider the overall pattern, not just individual metrics

  Provide your fraud assessment in the following JSON format:
  ```json
  {{
    "risk_score": <float 0.0-1.0>,
    "confidence": <float 0.0-1.0>,
    "prediction": "<FRAUD|LEGITIMATE>",
    "reasoning": "<brief explanation>",
    "key_indicators": [<list of key fraud indicators found>],
    "risk_factors": {{
      "velocity_risk": <float 0.0-1.0>,
      "geographic_risk": <float 0.0-1.0>,
      "device_risk": <float 0.0-1.0>,
      "behavioral_risk": <float 0.0-1.0>
    }}
  }}
  ```

# Template for formatting fraud indicators - neutral presentation
fraud_indicators_template: |
  - Fraud Transaction Count: {fraud_tx_count}
  - Fraud Transaction Ratio: {fraud_ratio}%
  - Chargeback Count: {chargeback_count}
  - Declined Transaction Ratio: {declined_ratio}%
  - High-Risk Country Transactions: {high_risk_country_count}

# Template for velocity analysis section
velocity_analysis_template: |
  - Transactions per Day (avg): {tx_per_day_avg}
  - Transactions per Day (max): {tx_per_day_max}
  - Peak Transaction Hour: {peak_hour}
  - Transaction Frequency Anomaly Score: {frequency_anomaly_score}
  - Time Between Transactions (min): {min_time_between_tx}

# Template for geographic analysis section
geographic_analysis_template: |
  - Countries Involved: {countries}
  - Country Count: {country_count}
  - IP Address Count: {ip_count}
  - Geographic Dispersion Score: {geo_dispersion_score}
  - Impossible Travel Detected: {impossible_travel}

# Template for device analysis section
device_analysis_template: |
  - Device Fingerprint Count: {device_count}
  - Browser Types: {browser_types}
  - OS Types: {os_types}
  - Device Sharing Detected: {device_sharing}
  - Emulator/VM Detected: {emulator_detected}

# Template for historical patterns section
historical_patterns_template: |
  - Account Age (days): {account_age_days}
  - First Transaction Date: {first_tx_date}
  - Last Transaction Date: {last_tx_date}
  - Historical Fraud Rate: {historical_fraud_rate}%
  - Previous Investigations: {previous_investigations}

# Batch analysis prompt for multiple entities
batch_analysis_prompt: |
  Analyze the following batch of {entity_count} entities for fraud risk.
  Use evidence-based assessment for each entity.

  {entities_data}

  Provide your analysis as a JSON array with one object per entity:
  ```json
  [
    {{
      "entity_id": "<entity identifier>",
      "risk_score": <float 0.0-1.0>,
      "confidence": <float 0.0-1.0>,
      "prediction": "<FRAUD|LEGITIMATE>",
      "reasoning": "<brief explanation>"
    }}
  ]
  ```

# Feedback analysis prompt for misclassifications
feedback_analysis_prompt: |
  The following prediction was incorrect:

  ## Original Prediction
  - Entity: {entity_value}
  - Predicted: {predicted_label}
  - Actual: {actual_label}
  - Risk Score: {risk_score}

  ## Entity Data
  {entity_data}

  ## Ground Truth Information
  - IS_FRAUD_TX: {is_fraud_tx}
  - Chargeback Date: {chargeback_date}

  Analyze why this prediction was incorrect and suggest improvements:
  ```json
  {{
    "error_type": "<false_positive|false_negative>",
    "likely_cause": "<explanation>",
    "missed_indicators": [<list of indicators that should have been weighted differently>],
    "suggested_adjustments": {{
      "feature_weights": {{<suggested weight adjustments>}},
      "threshold_adjustment": <suggested threshold change>
    }}
  }}
  ```
