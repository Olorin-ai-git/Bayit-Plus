# =============================================================================
# Tox Configuration for Bayit+ Backend
# Runs all quality checks in isolated environments
# =============================================================================
#
# Usage:
#   tox                    # Run all environments
#   tox -e lint            # Run only linting
#   tox -e type            # Run only type checking
#   tox -e test            # Run only tests
#   tox -e format          # Check formatting
#   tox -e security        # Run security audit
#
# =============================================================================

[tox]
envlist = format,lint,type,test,security
isolated_build = true
skipsdist = true

[testenv]
allowlist_externals = poetry
commands_pre =
    poetry install --no-interaction --no-root

# =============================================================================
# Format Checking (Black + isort)
# =============================================================================
[testenv:format]
description = Check code formatting with Black and isort
commands =
    poetry run black --check --diff app tests
    poetry run isort --check-only --diff app tests

# =============================================================================
# Linting (Pylint)
# =============================================================================
[testenv:lint]
description = Run pylint code analysis
commands =
    poetry run pylint app --fail-under=8.0 --output-format=colorized

# =============================================================================
# Type Checking (mypy)
# =============================================================================
[testenv:type]
description = Run mypy type checking
commands =
    poetry run mypy app --ignore-missing-imports --no-error-summary

# =============================================================================
# Testing (pytest with coverage)
# =============================================================================
[testenv:test]
description = Run pytest with coverage
passenv =
    MONGODB_URL
    MONGODB_DB_NAME
    SECRET_KEY
    DEBUG
setenv =
    MONGODB_URL = {env:MONGODB_URL:mongodb://localhost:27017}
    MONGODB_DB_NAME = {env:MONGODB_DB_NAME:bayit_test}
    SECRET_KEY = {env:SECRET_KEY:test-secret-key-for-tox}
    DEBUG = true
commands =
    poetry run pytest tests/ \
        --cov=app \
        --cov-report=term-missing \
        --cov-report=html:coverage_html \
        --cov-fail-under=87 \
        -v \
        --tb=short

# =============================================================================
# Security Audit (pip-audit)
# =============================================================================
[testenv:security]
description = Run security vulnerability audit
commands =
    poetry run pip-audit --strict --progress-spinner off

# =============================================================================
# Combined Quality Gate (for CI)
# =============================================================================
[testenv:ci]
description = Full CI quality gate
passenv =
    MONGODB_URL
    MONGODB_DB_NAME
    SECRET_KEY
    DEBUG
setenv =
    MONGODB_URL = {env:MONGODB_URL:mongodb://localhost:27017}
    MONGODB_DB_NAME = {env:MONGODB_DB_NAME:bayit_test}
    SECRET_KEY = {env:SECRET_KEY:test-secret-key-for-tox}
    DEBUG = true
commands =
    poetry run black --check app tests
    poetry run isort --check-only app tests
    poetry run mypy app --ignore-missing-imports
    poetry run pytest tests/ --cov=app --cov-fail-under=87 -v --tb=short

# =============================================================================
# Development Helpers
# =============================================================================
[testenv:fix]
description = Auto-fix formatting issues
commands =
    poetry run black app tests
    poetry run isort app tests

[testenv:all]
description = Run all checks including security
passenv =
    MONGODB_URL
    MONGODB_DB_NAME
    SECRET_KEY
    DEBUG
setenv =
    MONGODB_URL = {env:MONGODB_URL:mongodb://localhost:27017}
    MONGODB_DB_NAME = {env:MONGODB_DB_NAME:bayit_test}
    SECRET_KEY = {env:SECRET_KEY:test-secret-key-for-tox}
    DEBUG = true
commands =
    poetry run black --check app tests
    poetry run isort --check-only app tests
    poetry run mypy app --ignore-missing-imports
    poetry run pylint app --fail-under=8.0
    poetry run pytest tests/ --cov=app --cov-fail-under=87 -v --tb=short
    poetry run pip-audit --strict --progress-spinner off
