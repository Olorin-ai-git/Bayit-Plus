name: Schema Validation

on:
  push:
    branches: [main, 001-snowflake-migration-plan]
    paths:
      - 'app/service/agent/tools/database_tool/**'
      - 'tests/**'
      - '.github/workflows/schema-validation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'app/service/agent/tools/database_tool/**'
      - 'tests/**'

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-root

      - name: Set up test database schema
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DATABASE: test_db
          POSTGRES_SCHEMA: public
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_POOL_SIZE: 5
          POSTGRES_POOL_MAX_OVERFLOW: 10
          POSTGRES_QUERY_TIMEOUT: 30
          POSTGRES_TRANSACTIONS_TABLE: transactions_enriched
        run: |
          # Create test schema in PostgreSQL
          PGPASSWORD=test_password psql -h localhost -U test_user -d test_db -c "
            CREATE TABLE IF NOT EXISTS transactions_enriched (
              TX_ID_KEY TEXT PRIMARY KEY,
              EMAIL TEXT,
              TX_DATETIME TIMESTAMP,
              MODEL_SCORE NUMERIC,
              IP_ADDRESS TEXT
            );
          "

      - name: Run schema validator tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DATABASE: test_db
          POSTGRES_SCHEMA: public
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_POOL_SIZE: 5
          POSTGRES_POOL_MAX_OVERFLOW: 10
          POSTGRES_QUERY_TIMEOUT: 30
          POSTGRES_TRANSACTIONS_TABLE: transactions_enriched
          DATABASE_PROVIDER: postgresql
          USE_FIREBASE_SECRETS: 'false'
          SECRET_MANAGER_LOG_LEVEL: INFO
        run: |
          poetry run pytest tests/unit/test_schema_*.py -v --tb=short

      - name: Run database provider tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DATABASE: test_db
          POSTGRES_SCHEMA: public
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_POOL_SIZE: 5
          POSTGRES_POOL_MAX_OVERFLOW: 10
          POSTGRES_QUERY_TIMEOUT: 30
          POSTGRES_TRANSACTIONS_TABLE: transactions_enriched
          DATABASE_PROVIDER: postgresql
          USE_FIREBASE_SECRETS: 'false'
          SECRET_MANAGER_LOG_LEVEL: INFO
        run: |
          poetry run pytest tests/unit/test_database_providers.py -v --tb=short

      - name: Validate configuration loader
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DATABASE: test_db
          POSTGRES_SCHEMA: public
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_POOL_SIZE: 5
          POSTGRES_POOL_MAX_OVERFLOW: 10
          POSTGRES_QUERY_TIMEOUT: 30
          DATABASE_PROVIDER: postgresql
          USE_FIREBASE_SECRETS: 'false'
          SECRET_MANAGER_LOG_LEVEL: INFO
        run: |
          poetry run python -c "
          from app.service.config_loader import get_config_loader
          from app.service.agent.tools.database_tool import get_database_provider

          # Validate config loads successfully
          config = get_config_loader().load_postgresql_config()
          print(f'✅ Config loaded: host={config[\"host\"]}, port={config[\"port\"]}')

          # Validate provider can be created
          provider = get_database_provider('postgresql')
          print(f'✅ Provider created successfully')

          print('✅ Schema validation CI check PASSED')
          "

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: schema-validation-results
          path: |
            pytest-results.xml
            .coverage

  check-file-sizes:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check file size compliance (<200 lines)
        run: |
          echo "Checking database tool files are under 200 lines..."

          # Find all Python files in database_tool directory
          FILES=$(find app/service/agent/tools/database_tool -name "*.py" -type f ! -name "__*")

          VIOLATIONS=0
          for file in $FILES; do
            LINES=$(wc -l < "$file")
            if [ "$LINES" -gt 200 ]; then
              echo "❌ VIOLATION: $file has $LINES lines (> 200)"
              VIOLATIONS=$((VIOLATIONS + 1))
            else
              echo "✅ OK: $file has $LINES lines"
            fi
          done

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "❌ Found $VIOLATIONS file(s) exceeding 200 lines"
            exit 1
          else
            echo ""
            echo "✅ All files comply with 200-line limit"
          fi

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for hardcoded credentials
        run: |
          echo "Scanning for hardcoded credentials..."

          # Scan for common patterns
          VIOLATIONS=0

          # Check for password patterns
          if grep -r "password\s*=\s*['\"]" app/service/agent/tools/database_tool --include="*.py"; then
            echo "❌ Found hardcoded password"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # Check for API key patterns
          if grep -r "api_key\s*=\s*['\"]" app/service/agent/tools/database_tool --include="*.py"; then
            echo "❌ Found hardcoded API key"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # Check for connection strings
          if grep -r "postgresql://.*:.*@" app/service/agent/tools/database_tool --include="*.py"; then
            echo "❌ Found hardcoded connection string"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "❌ Security scan failed: found $VIOLATIONS violations"
            exit 1
          else
            echo "✅ No hardcoded credentials found"
          fi

  forbidden-patterns:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for forbidden patterns (TODO, MOCK, etc.)
        run: |
          echo "Scanning for forbidden patterns in production code..."

          # Exclude test files and demo files
          FILES=$(find app/service/agent/tools/database_tool -name "*.py" -type f ! -name "__*" ! -path "*/tests/*" ! -path "*/demo/*")

          VIOLATIONS=0

          # Check for TODO
          if echo "$FILES" | xargs grep -n "\bTODO\b" 2>/dev/null; then
            echo "❌ Found TODO in production code"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # Check for FIXME
          if echo "$FILES" | xargs grep -n "\bFIXME\b" 2>/dev/null; then
            echo "❌ Found FIXME in production code"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # Check for MOCK
          if echo "$FILES" | xargs grep -n "\bMOCK\b" 2>/dev/null; then
            echo "❌ Found MOCK in production code"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # Check for STUB
          if echo "$FILES" | xargs grep -n "\bSTUB\b" 2>/dev/null; then
            echo "❌ Found STUB in production code"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "❌ Found $VIOLATIONS forbidden patterns"
            exit 1
          else
            echo "✅ No forbidden patterns found"
          fi
