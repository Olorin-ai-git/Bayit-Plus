# =============================================================================
# Olorin Backend - Continuous Integration Pipeline
# =============================================================================
# Runs on every push and pull request to ensure code quality
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/*']
    paths:
      - 'app/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'app/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'poetry.lock'

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.8.0'

jobs:
  # ===========================================================================
  # Lint and Format Check
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-

      - name: Install dependencies
        run: poetry install --no-root

      - name: Run Black (code formatting)
        run: poetry run black --check app/ tests/
        continue-on-error: true

      - name: Run isort (import sorting)
        run: poetry run isort --check-only app/ tests/
        continue-on-error: true

      - name: Run Flake8 (linting)
        run: poetry run flake8 app/ --max-line-length=120 --ignore=E501,W503
        continue-on-error: true

  # ===========================================================================
  # Type Checking
  # ===========================================================================
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-root

      - name: Run mypy
        run: poetry run mypy app/ --ignore-missing-imports
        continue-on-error: true

  # ===========================================================================
  # Security Scan
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for hardcoded secrets..."

          # Check for common secret patterns
          if grep -rE "(password|secret|api_key|apikey|token|credential)\s*=\s*['\"][^'\"]+['\"]" \
            --include="*.py" app/ \
            --exclude-dir=__pycache__ \
            --exclude="*test*" | grep -v "os.getenv\|os.environ\|config\.\|settings\." | head -20; then
            echo "::warning::Potential hardcoded secrets found"
          fi

      - name: Check for forbidden patterns
        run: |
          echo "Scanning for TODO/FIXME/MOCK patterns..."

          VIOLATIONS=$(grep -rE "(TODO|FIXME|MOCK|STUB|PLACEHOLDER)" \
            --include="*.py" app/ \
            --exclude-dir=__pycache__ \
            --exclude-dir=demo \
            --exclude="*test*" || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "::warning::Forbidden patterns found:"
            echo "$VIOLATIONS"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --no-root

      - name: Run Bandit (security linter)
        run: poetry run bandit -r app/ -ll --skip B101
        continue-on-error: true

  # ===========================================================================
  # Unit Tests
  # ===========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      APP_ENV: test
      MONGODB_URI: mongodb://localhost:27017/olorin_test
      MONGODB_DATABASE: olorin_test
      REDIS_URL: redis://localhost:6379/0
      JWT_SECRET_KEY: test-jwt-secret-for-ci
      OLORIN_B2B_ENABLED: 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install

      - name: Run tests with coverage
        run: |
          poetry run pytest \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=30 \
            -v \
            --tb=short

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # Build Docker Image (Validation)
  # ===========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.cloudrun
          push: false
          tags: olorin-backend:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # File Size Compliance
  # ===========================================================================
  file-compliance:
    name: File Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file sizes (max 200 lines)
        run: |
          echo "Checking for files exceeding 200 lines..."

          VIOLATIONS=""
          while IFS= read -r file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 200 ]; then
              VIOLATIONS="$VIOLATIONS\n$file: $lines lines"
            fi
          done < <(find app -name "*.py" -type f)

          if [ -n "$VIOLATIONS" ]; then
            echo "::warning::Files exceeding 200 lines:"
            echo -e "$VIOLATIONS"
          fi

  # ===========================================================================
  # Summary Job
  # ===========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, type-check, security, test, build, file-compliance]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Format | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Compliance | ${{ needs.file-compliance.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: needs.test.result == 'failure' || needs.build.result == 'failure'
        run: |
          echo "Critical CI jobs failed!"
          exit 1
