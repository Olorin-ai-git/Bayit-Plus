# =============================================================================
# Olorin Backend - Deploy to Staging
# =============================================================================
# Automatically deploys to staging when CI passes on main branch
# =============================================================================

name: Deploy to Staging

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'Dockerfile*'
      - 'pyproject.toml'
      - 'poetry.lock'
      - 'cloudrun-*.txt'
      - 'cloudbuild.yaml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        type: boolean
        default: false

env:
  PROJECT_ID: olorin-fraud-detection
  REGION: us-east1
  SERVICE_NAME: olorin-backend-staging
  ARTIFACT_REGISTRY: us-east1-docker.pkg.dev
  REPOSITORY: olorin
  IMAGE_NAME: backend

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Run CI Checks First
  # ===========================================================================
  ci:
    name: CI Checks
    if: ${{ !inputs.skip_tests }}
    uses: ./.github/workflows/ci.yml

  # ===========================================================================
  # Deploy to Staging via Cloud Build
  # ===========================================================================
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ci]
    if: always() && (needs.ci.result == 'success' || needs.ci.result == 'skipped')
    timeout-minutes: 30

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          # Or use service account key (less secure):
          # credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"

          docker build \
            -f Dockerfile.cloudrun \
            -t "${IMAGE_TAG}:${{ github.sha }}" \
            -t "${IMAGE_TAG}:staging-latest" \
            --build-arg APP_ENV=staging \
            --cache-from "${IMAGE_TAG}:staging-latest" \
            .

      - name: Push Docker image
        run: |
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"

          docker push "${IMAGE_TAG}:${{ github.sha }}"
          docker push "${IMAGE_TAG}:staging-latest"

      - name: Deploy to Cloud Run
        run: |
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Read configuration files
          ENV_VARS=$(cat cloudrun-env-vars.staging.txt | tr '\n' ',')
          SECRETS=$(cat cloudrun-secrets.txt | tr '\n' ',')

          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image="${IMAGE_TAG}" \
            --region=${{ env.REGION }} \
            --platform=managed \
            --port=8090 \
            --memory=2Gi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --concurrency=80 \
            --timeout=300s \
            --allow-unauthenticated \
            --execution-environment=gen2 \
            --set-env-vars="${ENV_VARS%,}" \
            --set-secrets="${SECRETS%,}" \
            --service-account=olorin-detection@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --quiet

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')

          echo "Service URL: $SERVICE_URL"

          # Health check with retries
          for i in {1..12}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed!"
              echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for service... Attempt $i/12 (HTTP $HTTP_CODE)"
            sleep 10
          done

          echo "Health check failed!"
          exit 1

      - name: Post deployment summary
        if: success()
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')

          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Service | ${{ env.SERVICE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | [${SERVICE_URL}](${SERVICE_URL}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | [${SERVICE_URL}/health](${SERVICE_URL}/health) |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | [${SERVICE_URL}/docs](${SERVICE_URL}/docs) |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notify on Failure
  # ===========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "::error::Staging deployment failed!"
          echo "Check the workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # Uncomment to enable Slack notifications:
      # - name: Slack Notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: failure
      #     fields: repo,message,commit,author,action,eventName,ref,workflow
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
