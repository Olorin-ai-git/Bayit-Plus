#!/bin/bash
#
# Olorin Workspace Management CLI Wrapper
#
# This script provides a global command-line interface for the Olorin
# workspace management system. It wraps the Python CLI tool (olor.py).
#
# Installation:
#   sudo ln -s $(pwd)/olorin /usr/local/bin/olorin
#   # OR add to PATH in ~/.bashrc or ~/.zshrc:
#   export PATH="$PATH:/path/to/olorin-server/cli"
#
# Usage:
#   olorin --help
#   olorin ls
#   olorin show <investigation_id>
#

set -euo pipefail

# Get the directory where this script is located
# Handle symlinks by resolving to the actual file location
SCRIPT_PATH="${BASH_SOURCE[0]}"
if [ -L "$SCRIPT_PATH" ]; then
    # If symlinked, resolve to actual file
    SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH" 2>/dev/null || readlink "$SCRIPT_PATH" 2>/dev/null || echo "$SCRIPT_PATH")"
    # If readlink didn't give absolute path, resolve relative to symlink location
    if [ "${SCRIPT_PATH#/}" = "$SCRIPT_PATH" ]; then
        SYMLINK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        SCRIPT_PATH="$SYMLINK_DIR/$SCRIPT_PATH"
    fi
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
SERVER_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Check if Poetry is available and pyproject.toml exists
if command -v poetry &> /dev/null && [ -f "$SERVER_DIR/pyproject.toml" ]; then
    USE_POETRY=true
else
    USE_POETRY=false
fi

# Python executable (try python3 first, fallback to python)
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    echo "Error: Python not found. Please install Python 3.11 or later." >&2
    exit 1
fi

# Check Python version (requires 3.11+)
PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
REQUIRED_VERSION="3.11"

if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$PYTHON_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
    echo "Error: Python 3.11 or later required. Found: $PYTHON_VERSION" >&2
    exit 1
fi

# Change to server directory to ensure relative paths work
cd "$SERVER_DIR"

# Check if olor.py exists
if [ ! -f "$SCRIPT_DIR/olor.py" ]; then
    echo "Error: olor.py not found at $SCRIPT_DIR/olor.py" >&2
    exit 1
fi

# Run the Python CLI with Poetry if available, otherwise use direct Python
if [ "$USE_POETRY" = true ]; then
    # Use Poetry to run the script (ensures dependencies are available)
    exec poetry run "$PYTHON_CMD" "$SCRIPT_DIR/olor.py" "$@"
else
    # Fallback to direct Python execution
    exec "$PYTHON_CMD" "$SCRIPT_DIR/olor.py" "$@"
fi

