<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigation Architecture - Visual Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #718096;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .metadata {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metadata-label {
            font-weight: 600;
            color: #4a5568;
        }

        .metadata-value {
            color: #718096;
        }

        .status-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #2d3748;
            font-size: 1.8rem;
            margin-bottom: 10px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .section-description {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .diagram-container {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .mermaid {
            text-align: center;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .feature-card p {
            font-size: 0.95rem;
            opacity: 0.95;
        }

        .code-block {
            background: #1a202c;
            color: #63b3ed;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 20px 0;
        }

        .implementation-phase {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .phase-title {
            font-weight: 600;
            color: #2d3748;
        }

        .phase-duration {
            color: #718096;
            font-size: 0.9rem;
        }

        .phase-tasks {
            color: #4a5568;
            line-height: 1.6;
        }

        .alert {
            background: #fed7d7;
            border: 2px solid #fc8181;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .alert-title {
            color: #742a2a;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-content {
            color: #9b2c2c;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .metadata {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#2d3748',
                primaryBorderColor: '#764ba2',
                lineColor: '#5a67d8',
                secondaryColor: '#f7fafc',
                tertiaryColor: '#fed7d7',
                background: '#ffffff',
                mainBkg: '#667eea',
                secondBkg: '#f7fafc',
                tertiaryBkg: '#fed7d7'
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Investigation Architecture Improvements</h1>
            <div class="subtitle">Comprehensive State Persistence & Lifecycle Management System</div>
            <div class="metadata">
                <div class="metadata-item">
                    <span class="metadata-label">Author:</span>
                    <span class="metadata-value">Gil Klainert</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Date:</span>
                    <span class="metadata-value">November 3, 2025</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Status:</span>
                    <span class="status-badge">PENDING APPROVAL</span>
                </div>
            </div>
        </header>

        <section class="section">
            <h2 class="section-title">System Architecture Overview</h2>
            <p class="section-description">
                High-level architecture showing the complete investigation system with state persistence,
                progress tracking, and real-time updates.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    graph TB
                        subgraph "Client Layer"
                            WEB[Web Client]
                            WS[WebSocket Client]
                        end

                        subgraph "API Gateway"
                            REST[REST API]
                            WSG[WebSocket Gateway]
                        end

                        subgraph "Service Layer"
                            IS[Investigation Service]
                            PS[Progress Service]
                            TS[Tool Service]
                            SM[State Machine]
                        end

                        subgraph "Agent Layer"
                            DA[Device Agent]
                            NA[Network Agent]
                            LA[Location Agent]
                            LGA[Logs Agent]
                        end

                        subgraph "Persistence Layer"
                            DB[(PostgreSQL)]
                            REDIS[(Redis Cache)]
                            ES[(Event Store)]
                        end

                        WEB --> REST
                        WS --> WSG
                        REST --> IS
                        WSG --> PS
                        IS --> SM
                        IS --> PS
                        IS --> TS
                        SM --> DB
                        PS --> REDIS
                        TS --> DA
                        TS --> NA
                        TS --> LA
                        TS --> LGA
                        DA --> ES
                        NA --> ES
                        LA --> ES
                        LGA --> ES
                        ES --> DB

                        style WEB fill:#e0e7ff
                        style WS fill:#e0e7ff
                        style IS fill:#667eea,color:#fff
                        style PS fill:#667eea,color:#fff
                        style TS fill:#667eea,color:#fff
                        style SM fill:#764ba2,color:#fff
                        style DB fill:#2d3748,color:#fff
                        style REDIS fill:#dc2626,color:#fff
                        style ES fill:#059669,color:#fff
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Investigation State Machine</h2>
            <p class="section-description">
                Complete lifecycle states and allowed transitions for investigation management,
                ensuring data integrity and proper state progression.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    stateDiagram-v2
                        [*] --> CREATED
                        CREATED --> QUEUED: Queue for execution
                        CREATED --> CANCELLED: User cancellation

                        QUEUED --> INITIALIZING: Start processing
                        QUEUED --> CANCELLED: Cancel before start

                        INITIALIZING --> RUNNING: Initialization complete
                        INITIALIZING --> FAILED: Initialization error

                        RUNNING --> PAUSED: User pause
                        RUNNING --> COMPLETING: All phases done
                        RUNNING --> FAILED: Execution error

                        PAUSED --> RUNNING: Resume
                        PAUSED --> CANCELLED: Cancel while paused

                        COMPLETING --> COMPLETED: Success
                        COMPLETING --> FAILED: Finalization error

                        FAILED --> RETRYING: Retry attempt
                        FAILED --> CANCELLED: Give up

                        RETRYING --> INITIALIZING: Retry init
                        RETRYING --> FAILED: Max retries

                        COMPLETED --> [*]
                        CANCELLED --> [*]
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Database Schema Design</h2>
            <p class="section-description">
                Enhanced entity relationship diagram showing all tables required for comprehensive
                investigation tracking and audit trail.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    erDiagram
                        INVESTIGATIONS ||--o{ INVESTIGATION_PHASES : contains
                        INVESTIGATIONS ||--o{ TOOL_EXECUTIONS : tracks
                        INVESTIGATIONS ||--o{ INVESTIGATION_EVENTS : logs
                        INVESTIGATIONS ||--o{ INVESTIGATION_SNAPSHOTS : saves
                        INVESTIGATION_PHASES ||--o{ TOOL_EXECUTIONS : executes

                        INVESTIGATIONS {
                            uuid id PK
                            varchar user_id
                            varchar subject
                            varchar investigation_type
                            varchar status
                            varchar current_phase
                            integer progress_percentage
                            timestamp created_at
                            timestamp started_at
                            timestamp completed_at
                            timestamp failed_at
                            integer retry_count
                            text error_message
                            uuid parent_investigation_id FK
                            jsonb result
                            jsonb metadata
                            jsonb configuration
                        }

                        INVESTIGATION_PHASES {
                            uuid id PK
                            uuid investigation_id FK
                            varchar phase_name
                            integer phase_order
                            varchar status
                            integer progress_percentage
                            timestamp started_at
                            timestamp completed_at
                            integer duration_ms
                            jsonb input_data
                            jsonb output_data
                            jsonb error_details
                        }

                        TOOL_EXECUTIONS {
                            uuid id PK
                            uuid investigation_id FK
                            uuid phase_id FK
                            varchar agent_name
                            varchar tool_name
                            varchar tool_version
                            timestamp started_at
                            timestamp completed_at
                            integer duration_ms
                            varchar status
                            jsonb input_parameters
                            jsonb output_result
                            text error_message
                            integer tokens_used
                            integer api_calls_made
                            decimal cost_estimate
                        }

                        INVESTIGATION_EVENTS {
                            uuid id PK
                            uuid investigation_id FK
                            varchar event_type
                            timestamp event_timestamp
                            varchar actor
                            varchar previous_state
                            varchar new_state
                            jsonb event_data
                            jsonb metadata
                        }

                        INVESTIGATION_SNAPSHOTS {
                            uuid id PK
                            uuid investigation_id FK
                            timestamp snapshot_timestamp
                            varchar snapshot_type
                            jsonb state_data
                            jsonb phase_states
                            jsonb tool_states
                        }
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Progress Tracking Flow</h2>
            <p class="section-description">
                Sequence diagram showing how progress is calculated and propagated through the system
                in real-time.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    sequenceDiagram
                        participant C as Client
                        participant API as Progress API
                        participant PS as Progress Service
                        participant DB as Database
                        participant R as Redis
                        participant WS as WebSocket

                        C->>API: GET /investigation/{id}/progress
                        API->>PS: getProgress(id)
                        PS->>R: checkCache(id)

                        alt Cache Hit
                            R-->>PS: cachedProgress
                        else Cache Miss
                            PS->>DB: fetchInvestigation(id)
                            DB-->>PS: investigation
                            PS->>DB: fetchPhases(id)
                            DB-->>PS: phases[]
                            PS->>DB: fetchToolExecutions(id)
                            DB-->>PS: tools[]
                            PS->>PS: calculateProgress()
                            PS->>R: cacheProgress(id, progress)
                        end

                        PS-->>API: progressData
                        API-->>C: progressResponse

                        Note over PS,WS: Real-time Updates
                        PS->>WS: broadcastUpdate(id, progress)
                        WS->>C: progressEvent
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Tool Execution Tracking</h2>
            <p class="section-description">
                Flow diagram showing how agent tool executions are tracked, persisted, and
                reported in real-time.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    flowchart LR
                        subgraph "Tool Execution"
                            A1[Agent Invoked] --> A2[Tool Selected]
                            A2 --> A3[Parameters Prepared]
                            A3 --> A4[Tool Executed]
                            A4 --> A5{Success?}
                            A5 -->|Yes| A6[Result Captured]
                            A5 -->|No| A7[Error Logged]
                        end

                        subgraph "Persistence"
                            B1[Create Record] --> B2[Update Phase]
                            B2 --> B3[Calculate Progress]
                            B3 --> B4[Store Metrics]
                            B4 --> B5[Update Cache]
                        end

                        subgraph "Broadcasting"
                            C1[Format Event] --> C2[Send WebSocket]
                            C2 --> C3[Update UI]
                            C3 --> C4[Log Event]
                        end

                        A4 --> B1
                        A6 --> B1
                        A7 --> B1
                        B3 --> C1

                        style A4 fill:#667eea,color:#fff
                        style B1 fill:#764ba2,color:#fff
                        style C1 fill:#059669,color:#fff
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Key Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>Complete State Persistence</h3>
                    <p>Every state change is persisted with full audit trail and event sourcing</p>
                </div>
                <div class="feature-card">
                    <h3>Real-time Progress</h3>
                    <p>Granular progress tracking with WebSocket updates for live monitoring</p>
                </div>
                <div class="feature-card">
                    <h3>Tool Usage Analytics</h3>
                    <p>Complete tracking of all agent tool executions with metrics and costs</p>
                </div>
                <div class="feature-card">
                    <h3>Failure Recovery</h3>
                    <p>Automatic retry mechanisms with snapshot-based recovery capabilities</p>
                </div>
                <div class="feature-card">
                    <h3>Compliance Ready</h3>
                    <p>Full audit trail with event sourcing for regulatory compliance</p>
                </div>
                <div class="feature-card">
                    <h3>Scalable Architecture</h3>
                    <p>Redis caching and async processing for high-performance at scale</p>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">WebSocket Event Flow</h2>
            <p class="section-description">
                Real-time event propagation system for investigation updates.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    graph LR
                        subgraph "Event Sources"
                            IS1[Investigation Started]
                            PS1[Phase Completed]
                            TS1[Tool Executed]
                            ST1[State Changed]
                        end

                        subgraph "Event Processing"
                            EP[Event Processor]
                            EF[Event Formatter]
                            ER[Event Router]
                        end

                        subgraph "Distribution"
                            WSM[WebSocket Manager]
                            RC[Redis Channel]
                            CL1[Client 1]
                            CL2[Client 2]
                            CLN[Client N]
                        end

                        IS1 --> EP
                        PS1 --> EP
                        TS1 --> EP
                        ST1 --> EP

                        EP --> EF
                        EF --> ER
                        ER --> WSM
                        ER --> RC

                        WSM --> CL1
                        WSM --> CL2
                        WSM --> CLN
                        RC --> WSM

                        style EP fill:#667eea,color:#fff
                        style WSM fill:#764ba2,color:#fff
                        style RC fill:#dc2626,color:#fff
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Implementation Phases</h2>
            <div class="implementation-phase">
                <div class="phase-header">
                    <span class="phase-title">Phase 1: Database Schema</span>
                    <span class="phase-duration">Week 1</span>
                </div>
                <div class="phase-tasks">
                    • Create migration scripts for new tables<br>
                    • Update SQLAlchemy models<br>
                    • Add performance indexes<br>
                    • Implement connection pooling
                </div>
            </div>
            <div class="implementation-phase">
                <div class="phase-header">
                    <span class="phase-title">Phase 2: State Management</span>
                    <span class="phase-duration">Week 1-2</span>
                </div>
                <div class="phase-tasks">
                    • Implement state machine<br>
                    • Add transition validation<br>
                    • Create event recording system<br>
                    • Build recovery mechanisms
                </div>
            </div>
            <div class="implementation-phase">
                <div class="phase-header">
                    <span class="phase-title">Phase 3: Progress Tracking</span>
                    <span class="phase-duration">Week 2</span>
                </div>
                <div class="phase-tasks">
                    • Implement progress calculation logic<br>
                    • Add phase tracking<br>
                    • Create tool execution monitoring<br>
                    • Build progress API endpoints
                </div>
            </div>
            <div class="implementation-phase">
                <div class="phase-header">
                    <span class="phase-title">Phase 4: WebSocket Enhancement</span>
                    <span class="phase-duration">Week 3</span>
                </div>
                <div class="phase-tasks">
                    • Implement structured event system<br>
                    • Add investigation-specific rooms<br>
                    • Create reconnection handling<br>
                    • Build event replay for missed updates
                </div>
            </div>
            <div class="implementation-phase">
                <div class="phase-header">
                    <span class="phase-title">Phase 5: Testing & Documentation</span>
                    <span class="phase-duration">Week 3-4</span>
                </div>
                <div class="phase-tasks">
                    • Comprehensive unit tests<br>
                    • Integration tests<br>
                    • Performance testing<br>
                    • API documentation
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Performance Architecture</h2>
            <p class="section-description">
                Caching strategy and performance optimization approach.
            </p>
            <div class="diagram-container">
                <div class="mermaid">
                    graph TB
                        subgraph "Request Flow"
                            REQ[API Request]
                            CACHE{Cache Check}
                            HIT[Cache Hit]
                            MISS[Cache Miss]
                        end

                        subgraph "Cache Layers"
                            L1[L1: Request Cache<br/>TTL: 5s]
                            L2[L2: Redis Cache<br/>TTL: 60s]
                            L3[L3: Database<br/>Persistent]
                        end

                        subgraph "Cache Invalidation"
                            UPD[State Update]
                            INV[Invalidate Cache]
                            PUB[Publish Event]
                        end

                        REQ --> CACHE
                        CACHE -->|Hit| HIT
                        CACHE -->|Miss| MISS

                        HIT --> L1
                        MISS --> L2
                        L2 -->|Miss| L3

                        UPD --> INV
                        INV --> L1
                        INV --> L2
                        INV --> PUB

                        style L1 fill:#fed7d7
                        style L2 fill:#dc2626,color:#fff
                        style L3 fill:#2d3748,color:#fff
                </div>
            </div>
        </section>

        <div class="alert">
            <div class="alert-title">Important Note</div>
            <div class="alert-content">
                This architecture requires approval before implementation. All code examples and
                schemas are production-ready and follow the SYSTEM MANDATE requirements.
            </div>
        </div>
    </div>
</body>
</html>