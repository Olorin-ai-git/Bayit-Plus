# Fraud Detection Prompt Templates v2
# Feature: 026-llm-training-pipeline
# Optimized for improved recall while maintaining reasonable precision

version: v2
created_at: "2024-12-09"
description: "Improved fraud detection prompts optimized for higher recall"

# System prompt for fraud detection analysis - optimized for recall
system_prompt: |
  You are an expert fraud detection analyst with a FRAUD-FIRST investigation mindset.
  Your primary mission is to PROTECT merchants from fraud losses.

  CRITICAL: Missing fraud (false negatives) is MORE COSTLY than false alarms.
  A single missed fraud case can cost thousands of dollars and enable fraud rings.

  You must provide:
  1. A risk score between 0.0 (definitely legitimate) and 1.0 (definitely fraudulent)
  2. A confidence level between 0.0 (uncertain) and 1.0 (certain)
  3. A prediction: FRAUD or LEGITIMATE
  4. Brief reasoning explaining your assessment

  ## Scoring Guidelines
  - ANY confirmed fraud transaction (fraud_tx_count > 0) → risk_score >= 0.7
  - Fraud ratio > 5% → risk_score >= 0.6
  - Multiple devices or IPs for single entity → elevate risk by 0.1-0.2
  - Geographic anomalies or impossible travel → elevate risk by 0.2-0.3
  - High velocity patterns → elevate risk by 0.1-0.2

  ## Decision Threshold
  - risk_score >= 0.5 → predict FRAUD
  - risk_score < 0.5 → predict LEGITIMATE

  When in doubt, err on the side of flagging as FRAUD. False positives can be reviewed;
  missed fraud cannot be recovered.

# Main fraud analysis prompt
fraud_analysis_prompt: |
  Analyze the following entity for fraud risk. Remember: PROTECT THE MERCHANT.

  ## Entity Information
  - Entity Type: {entity_type}
  - Entity Value: {entity_value}
  - Merchant: {merchant_name}

  ## Transaction Summary
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Date Range: {date_range}
  - Unique Merchants: {unique_merchants}
  - Unique Devices: {unique_devices}
  - Unique IPs: {unique_ips}

  ## Fraud Indicators (CRITICAL - Review Carefully)
  {fraud_indicators}

  ## Velocity Analysis
  {velocity_analysis}

  ## Geographic Analysis
  {geographic_analysis}

  ## Device Analysis
  {device_analysis}

  ## Historical Patterns
  {historical_patterns}

  IMPORTANT DECISION RULES:
  1. If fraud_tx_count > 0, this entity HAS committed fraud. Risk score should be >= 0.7
  2. If fraud_ratio > 0%, the entity has fraud history. Consider FRAUD prediction.
  3. Multiple devices/IPs for single email = suspicious behavior
  4. High velocity or geographic anomalies = elevated risk

  Provide your fraud assessment in the following JSON format:
  ```json
  {{
    "risk_score": <float 0.0-1.0>,
    "confidence": <float 0.0-1.0>,
    "prediction": "<FRAUD|LEGITIMATE>",
    "reasoning": "<brief explanation>",
    "key_indicators": [<list of key fraud indicators found>],
    "risk_factors": {{
      "velocity_risk": <float 0.0-1.0>,
      "geographic_risk": <float 0.0-1.0>,
      "device_risk": <float 0.0-1.0>,
      "behavioral_risk": <float 0.0-1.0>
    }}
  }}
  ```

# Template for formatting fraud indicators - enhanced clarity
fraud_indicators_template: |
  - Fraud Transaction Count: {fraud_tx_count} ⚠️ (IF > 0, THIS IS CONFIRMED FRAUD)
  - Fraud Transaction Ratio: {fraud_ratio}% ⚠️ (IF > 0%, HIGH RISK)
  - Chargeback Count: {chargeback_count}
  - Declined Transaction Ratio: {declined_ratio}%
  - High-Risk Country Transactions: {high_risk_country_count}

# Template for velocity analysis section
velocity_analysis_template: |
  - Transactions per Day (avg): {tx_per_day_avg}
  - Transactions per Day (max): {tx_per_day_max}
  - Peak Transaction Hour: {peak_hour}
  - Transaction Frequency Anomaly Score: {frequency_anomaly_score}
  - Time Between Transactions (min): {min_time_between_tx}

# Template for geographic analysis section
geographic_analysis_template: |
  - Countries Involved: {countries}
  - Country Count: {country_count}
  - IP Address Count: {ip_count}
  - Geographic Dispersion Score: {geo_dispersion_score}
  - Impossible Travel Detected: {impossible_travel}

# Template for device analysis section
device_analysis_template: |
  - Device Fingerprint Count: {device_count}
  - Browser Types: {browser_types}
  - OS Types: {os_types}
  - Device Sharing Detected: {device_sharing}
  - Emulator/VM Detected: {emulator_detected}

# Template for historical patterns section
historical_patterns_template: |
  - Account Age (days): {account_age_days}
  - First Transaction Date: {first_tx_date}
  - Last Transaction Date: {last_tx_date}
  - Historical Fraud Rate: {historical_fraud_rate}%
  - Previous Investigations: {previous_investigations}

# Batch analysis prompt for multiple entities
batch_analysis_prompt: |
  Analyze the following batch of {entity_count} entities for fraud risk.
  Remember: Missing fraud is more costly than false positives.
  For each entity, provide a fraud assessment.

  {entities_data}

  Provide your analysis as a JSON array with one object per entity:
  ```json
  [
    {{
      "entity_id": "<entity identifier>",
      "risk_score": <float 0.0-1.0>,
      "confidence": <float 0.0-1.0>,
      "prediction": "<FRAUD|LEGITIMATE>",
      "reasoning": "<brief explanation>"
    }}
  ]
  ```

# Feedback analysis prompt for misclassifications
feedback_analysis_prompt: |
  The following prediction was incorrect:

  ## Original Prediction
  - Entity: {entity_value}
  - Predicted: {predicted_label}
  - Actual: {actual_label}
  - Risk Score: {risk_score}

  ## Entity Data
  {entity_data}

  ## Ground Truth Information
  - IS_FRAUD_TX: {is_fraud_tx}
  - Chargeback Date: {chargeback_date}

  Analyze why this prediction was incorrect and suggest improvements:
  ```json
  {{
    "error_type": "<false_positive|false_negative>",
    "likely_cause": "<explanation>",
    "missed_indicators": [<list of indicators that should have been weighted differently>],
    "suggested_adjustments": {{
      "feature_weights": {{<suggested weight adjustments>}},
      "threshold_adjustment": <suggested threshold change>
    }}
  }}
  ```
