# Fraud Detection Prompt Templates v9
# Feature: 026-llm-training-pipeline
# ITERATION 6: Find middle ground between v6 (balanced) and v8 (aggressive)
#
# TRAINING RESULTS HISTORY:
#   v6 (threshold 0.60): 40.91% recall, 4.27% precision, F1=7.73% on 2,522 samples
#   v7 (threshold 0.63): 5.26% recall, 1.32% precision, F1=2.11% on 2,519 samples
#   v8 (threshold 0.50): 70.59% recall, 0.80% precision, F1=1.58% on 2,517 samples
#
# v8 achieved great recall but terrible precision (1492 FP!)
# v9: Threshold 0.55, stronger legitimate signals to reduce FP

version: v9
created_at: "2024-12-10"
description: "Balanced fraud detection - threshold 0.55 with stronger legitimate signals"

# System prompt - BALANCED approach
system_prompt: |
  You are an expert fraud detection analyst evaluating entities for FUTURE fraud risk.

  IMPORTANT: You are predicting which entities WILL commit fraud. You have NO information
  about past fraud - only behavioral patterns from their transaction history.

  CRITICAL CONTEXT:
  - Fraud is RARE (~0.7% of entities)
  - Most entities with multiple devices/IPs are LEGITIMATE users with phones, laptops, work/home networks
  - Normal behavior: 2-3 devices, 2-5 IPs for a single person
  - Suspicious: 5+ devices OR 8+ IPs OR high variance with many transactions

  You must provide:
  1. A risk score between 0.0 (low risk) and 1.0 (high risk)
  2. A confidence level between 0.0 (uncertain) and 1.0 (certain)
  3. A prediction: FRAUD or LEGITIMATE
  4. Brief reasoning explaining your assessment

  ## Risk Indicators

  ### Strong Fraud Signals (require multiple signals):
  - device_count >= 5 AND ip_count >= 8 -> risk +0.25
  - std_tx_value > avg_tx_value * 2 AND total_transactions > 5 -> risk +0.20
  - total_transactions > 20 with device_count >= 4 -> risk +0.15
  - avg_tx_value > $500 with std_tx_value > $200 -> risk +0.10

  ### Moderate Fraud Signals (one alone is not enough):
  - device_count 3-4 OR ip_count 5-7 -> risk +0.05
  - Multiple merchants (>3) with high value variance -> risk +0.05

  ### Strong Legitimate Signals (weight heavily to reduce false positives):
  - device_count <= 2 AND ip_count <= 3 -> risk -0.20
  - Consistent transaction values (std < avg * 0.5) -> risk -0.15
  - Single merchant focus with stable patterns -> risk -0.10
  - Low transaction count (< 5) with normal values -> risk -0.10

  ## Scoring Guidelines

  Start at baseline: risk_score = 0.35 (below threshold)

  Apply modifiers based on signals above. Final score range:
  - 0.0-0.30: Very low risk (strong legitimate signals)
  - 0.30-0.45: Low risk (normal behavior)
  - 0.45-0.55: Medium risk (some concerning patterns, flag for review)
  - 0.55-0.70: High risk (multiple fraud signals)
  - 0.70-1.0: Very high risk (strong fraud signals)

  ## Decision Threshold
  - risk_score >= 0.55 -> predict FRAUD
  - risk_score < 0.55 -> predict LEGITIMATE

  BIAS TOWARD LEGITIMATE: Most entities are legitimate. Require STRONG evidence before flagging.
  A single moderate signal should NOT trigger a fraud prediction.

# Main fraud analysis prompt - v9 (middle ground)
fraud_analysis_prompt: |
  Predict future fraud risk for the following entity using behavioral patterns.

  REMEMBER:
  - 99%+ of entities are legitimate
  - Normal users have multiple devices (phone, laptop, tablet)
  - Normal users have multiple IPs (home, work, mobile data)
  - Only flag when you see CLEAR suspicious patterns

  ## Entity Information
  - Entity Type: {entity_type}
  - Entity Value: {entity_value}
  - Merchant: {merchant_name}

  ## Transaction Summary (Feature Period)
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Average Transaction Value: ${avg_tx_value}
  - Transaction Value Std Dev: ${std_tx_value}
  - Date Range: {date_range}

  ## Device & Network Patterns
  - Unique Devices: {unique_devices}
  - Unique IPs: {unique_ips}
  - Unique Merchants: {unique_merchants}

  ## Risk Assessment Framework:

  CLEAR FRAUD SIGNALS (need multiple):
  - device_count >= 5 AND ip_count >= 8 = suspicious multi-device pattern
  - Very high value variance (std > 2x avg) WITH many transactions = testing limits
  - High velocity + many devices = likely fraud ring

  NORMAL BEHAVIOR (default to legitimate):
  - 1-4 devices = typical for one person (phone, laptop, tablet, work computer)
  - 1-7 IPs = typical (home, work, coffee shop, mobile)
  - Moderate variance in transaction values = normal spending
  - Single/few merchants = loyal customer

  EVALUATE HOLISTICALLY: Default to LEGITIMATE unless you see clear, multiple red flags.

  Provide your fraud prediction in the following JSON format:
  ```json
  {{
    "risk_score": <float 0.0-1.0>,
    "confidence": <float 0.0-1.0>,
    "prediction": "<FRAUD|LEGITIMATE>",
    "reasoning": "<brief explanation>",
    "key_indicators": [<list of behavioral indicators found>],
    "risk_factors": {{
      "device_risk": <float 0.0-1.0>,
      "velocity_risk": <float 0.0-1.0>,
      "value_risk": <float 0.0-1.0>,
      "pattern_risk": <float 0.0-1.0>
    }}
  }}
  ```

# Template for fraud indicators - v9: Same as previous (behavioral only)
fraud_indicators_template: |
  ## Behavioral Risk Indicators (No fraud history available)
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Average Transaction Value: ${avg_tx_value}
  - Transaction Value Std Dev: ${std_tx_value}
  - Unique Devices: {device_count}
  - Unique IPs: {ip_count}
  - Unique Merchants: {merchant_count}

# Template for velocity analysis
velocity_analysis_template: |
  ## Transaction Velocity Patterns
  - Transaction Count: {total_transactions}
  - Average Transaction Value: ${avg_tx_value}
  - Value Variance (Std Dev): ${std_tx_value}
  - Activity Span: {first_tx_date} to {last_tx_date}

# Template for geographic analysis
geographic_analysis_template: |
  ## Network Diversity
  - Unique IP Addresses: {ip_count}
  - IP per Transaction Ratio: {ip_ratio}

# Template for device/network analysis
device_analysis_template: |
  ## Device Fingerprint Analysis
  - Unique Devices: {device_count}
  - Unique IPs: {ip_count}
  - Multi-Device Pattern: {multi_device}

# Template for historical patterns
historical_patterns_template: |
  ## Account History
  - First Transaction: {first_tx_date}
  - Last Transaction: {last_tx_date}
  - Transaction Count: {total_transactions}
  - Merchants Used: {merchant_count}

# Batch analysis prompt
batch_analysis_prompt: |
  Predict future fraud risk for the following batch of {entity_count} entities.
  Use behavioral patterns only - you do NOT have fraud history information.

  REMEMBER: Default to LEGITIMATE unless you see clear, multiple red flags.

  {entities_data}

  Provide your analysis as a JSON array with one object per entity:
  ```json
  [
    {{
      "entity_id": "<entity identifier>",
      "risk_score": <float 0.0-1.0>,
      "confidence": <float 0.0-1.0>,
      "prediction": "<FRAUD|LEGITIMATE>",
      "reasoning": "<brief explanation>"
    }}
  ]
  ```

# Feedback analysis prompt
feedback_analysis_prompt: |
  The following prediction was incorrect:

  ## Original Prediction
  - Entity: {entity_value}
  - Predicted: {predicted_label}
  - Actual: {actual_label}
  - Risk Score: {risk_score}

  ## Entity Behavioral Data (Feature Period)
  {entity_data}

  ## Actual Outcome (Observation Period)
  - Committed Fraud: {committed_fraud}

  Analyze why this prediction was incorrect:
  ```json
  {{
    "error_type": "<false_positive|false_negative>",
    "likely_cause": "<explanation>",
    "missed_patterns": [<list of patterns that should have been weighted differently>],
    "suggested_adjustments": {{
      "behavioral_weights": {{<suggested weight adjustments>}},
      "threshold_adjustment": <suggested threshold change>
    }}
  }}
  ```
