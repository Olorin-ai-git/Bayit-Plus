# Fraud Detection Prompt Templates v5
# Feature: 026-llm-training-pipeline
# ITERATION 2: More conservative scoring to reduce false positives
# Previous: v4 had 100% recall but only 4.17% precision (23 FP)

version: v5
created_at: "2024-12-10"
description: "Conservative fraud detection - stricter thresholds to reduce false positives"

# System prompt - MORE CONSERVATIVE approach
system_prompt: |
  You are an expert fraud detection analyst evaluating entities for FUTURE fraud risk.

  CRITICAL: You are predicting which entities WILL commit fraud. You have NO information
  about past fraud - only behavioral patterns from their transaction history.

  IMPORTANT CONTEXT: Fraud is RARE (typically <5% of entities). Most entities are
  legitimate. You should be CONSERVATIVE in flagging fraud - only flag entities
  with STRONG multiple indicators.

  You must provide:
  1. A risk score between 0.0 (low risk) and 1.0 (high risk)
  2. A confidence level between 0.0 (uncertain) and 1.0 (certain)
  3. A prediction: FRAUD or LEGITIMATE
  4. Brief reasoning explaining your assessment

  ## Risk Indicators (STRICT Interpretation Required)

  ### HIGH-Risk Patterns (Need MULTIPLE to flag as fraud):
  - device_count >= 5 AND ip_count >= 8 -> strong fraud signal
  - std_tx_value > avg_tx_value * 2 -> high variance is suspicious
  - total_transactions > 20 with device_count > 3 -> velocity concern
  - avg_tx_value > $500 with high variance -> testing card limits

  ### NORMAL Patterns (Should NOT trigger fraud prediction):
  - device_count 1-3 -> normal for legitimate users
  - ip_count 1-5 -> normal (VPNs, mobile networks)
  - Consistent transaction values (low std_tx_value) -> legitimate
  - Single merchant activity -> normal customer behavior
  - transaction_count < 10 -> insufficient data, assume legitimate

  ## Scoring Guidelines (Conservative)

  Start at baseline risk_score = 0.25 (most entities are legitimate)

  Only ADD risk for strong signals:
  - device_count >= 5: +0.20
  - ip_count >= 8: +0.15
  - std_tx_value > avg_tx_value * 2: +0.15
  - avg_tx_value > $500 AND std_tx_value > $200: +0.15
  - total_transactions > 20 AND device_count > 3: +0.10

  SUBTRACT risk for positive signals:
  - device_count == 1 AND ip_count <= 2: -0.10
  - Consistent low variance: -0.05
  - Long history with stable patterns: -0.05

  ## Decision Threshold (HIGHER to reduce false positives)
  - risk_score >= 0.70 -> predict FRAUD
  - risk_score < 0.70 -> predict LEGITIMATE

  REMEMBER: When in doubt, predict LEGITIMATE. False positives hurt customer trust.

# Main fraud analysis prompt - v5 (conservative)
fraud_analysis_prompt: |
  Predict future fraud risk for the following entity using behavioral patterns.

  REMEMBER: Fraud is rare (<5%). Be conservative - only flag clear fraud signals.

  ## Entity Information
  - Entity Type: {entity_type}
  - Entity Value: {entity_value}
  - Merchant: {merchant_name}

  ## Transaction Summary (Feature Period)
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Average Transaction Value: ${avg_tx_value}
  - Transaction Value Std Dev: ${std_tx_value}
  - Date Range: {date_range}

  ## Device & Network Patterns
  - Unique Devices: {unique_devices}
  - Unique IPs: {unique_ips}
  - Unique Merchants: {unique_merchants}

  ## Conservative Risk Assessment:
  1. device_count >= 5 is concerning, 1-3 is NORMAL
  2. ip_count >= 8 is concerning, 1-5 is NORMAL
  3. High std_tx_value (> 2x avg) suggests testing behavior
  4. Single device + single IP = likely legitimate
  5. Low transaction count = insufficient evidence for fraud

  IMPORTANT: Start assuming the entity is LEGITIMATE. Only flag as FRAUD if
  you see MULTIPLE strong risk indicators combined.

  Provide your fraud prediction in the following JSON format:
  ```json
  {{
    "risk_score": <float 0.0-1.0>,
    "confidence": <float 0.0-1.0>,
    "prediction": "<FRAUD|LEGITIMATE>",
    "reasoning": "<brief explanation>",
    "key_indicators": [<list of behavioral indicators found>],
    "risk_factors": {{
      "device_risk": <float 0.0-1.0>,
      "velocity_risk": <float 0.0-1.0>,
      "value_risk": <float 0.0-1.0>,
      "pattern_risk": <float 0.0-1.0>
    }}
  }}
  ```

# Template for fraud indicators - v5: Same as v4 (behavioral only)
fraud_indicators_template: |
  ## Behavioral Risk Indicators (No fraud history available)
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Average Transaction Value: ${avg_tx_value}
  - Transaction Value Std Dev: ${std_tx_value}
  - Unique Devices: {device_count}
  - Unique IPs: {ip_count}
  - Unique Merchants: {merchant_count}

# Template for velocity analysis - v5: Transaction patterns only
velocity_analysis_template: |
  ## Transaction Velocity Patterns
  - Transaction Count: {total_transactions}
  - Average Transaction Value: ${avg_tx_value}
  - Value Variance (Std Dev): ${std_tx_value}
  - Activity Span: {first_tx_date} to {last_tx_date}

# Template for geographic analysis - v5: IP diversity only
geographic_analysis_template: |
  ## Network Diversity
  - Unique IP Addresses: {ip_count}
  - IP per Transaction Ratio: {ip_ratio}

# Template for device/network analysis
device_analysis_template: |
  ## Device Fingerprint Analysis
  - Unique Devices: {device_count}
  - Unique IPs: {ip_count}
  - Multi-Device Pattern: {multi_device}

# Template for historical patterns - v5: Account age only
historical_patterns_template: |
  ## Account History
  - First Transaction: {first_tx_date}
  - Last Transaction: {last_tx_date}
  - Transaction Count: {total_transactions}
  - Merchants Used: {merchant_count}

# Batch analysis prompt for multiple entities
batch_analysis_prompt: |
  Predict future fraud risk for the following batch of {entity_count} entities.
  Use behavioral patterns only - you do NOT have fraud history information.

  REMEMBER: Be conservative. Fraud is rare - most entities are legitimate.

  {entities_data}

  Provide your analysis as a JSON array with one object per entity:
  ```json
  [
    {{
      "entity_id": "<entity identifier>",
      "risk_score": <float 0.0-1.0>,
      "confidence": <float 0.0-1.0>,
      "prediction": "<FRAUD|LEGITIMATE>",
      "reasoning": "<brief explanation>"
    }}
  ]
  ```

# Feedback analysis prompt for misclassifications
feedback_analysis_prompt: |
  The following prediction was incorrect:

  ## Original Prediction
  - Entity: {entity_value}
  - Predicted: {predicted_label}
  - Actual: {actual_label}
  - Risk Score: {risk_score}

  ## Entity Behavioral Data (Feature Period)
  {entity_data}

  ## Actual Outcome (Observation Period)
  - Committed Fraud: {committed_fraud}

  Analyze why this prediction was incorrect:
  ```json
  {{
    "error_type": "<false_positive|false_negative>",
    "likely_cause": "<explanation>",
    "missed_patterns": [<list of patterns that should have been weighted differently>],
    "suggested_adjustments": {{
      "behavioral_weights": {{<suggested weight adjustments>}},
      "threshold_adjustment": <suggested threshold change>
    }}
  }}
  ```
