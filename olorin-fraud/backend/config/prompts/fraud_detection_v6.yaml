# Fraud Detection Prompt Templates v6 - RECOMMENDED PRODUCTION VERSION
# Feature: 026-llm-training-pipeline
# ITERATION 3: Balanced threshold between v4 (too aggressive) and v5 (too conservative)
#
# TRAINING RESULTS (51 samples, temporal holdout):
#   v4: 100% recall, 4.17% precision (threshold 0.55) - 23 FP, F1=8.00%
#   v5: 0% recall, undefined precision (threshold 0.70) - too conservative
#   v6: 100% recall, 7.69% precision (threshold 0.60) - 12 FP, F1=14.29%  <-- BEST
#
# v6 achieved 48% reduction in false positives while maintaining 100% recall

version: v6
created_at: "2024-12-10"
description: "Balanced fraud detection - threshold 0.60 for precision/recall tradeoff"

# System prompt - BALANCED approach
system_prompt: |
  You are an expert fraud detection analyst evaluating entities for FUTURE fraud risk.

  IMPORTANT: You are predicting which entities WILL commit fraud. You have NO information
  about past fraud - only behavioral patterns from their transaction history.

  CONTEXT: Fraud is rare (~2-5% of entities), but catching fraud matters. Balance between:
  - Not flagging too many legitimate users (false positives hurt trust)
  - Not missing actual fraudsters (false negatives cause financial loss)

  You must provide:
  1. A risk score between 0.0 (low risk) and 1.0 (high risk)
  2. A confidence level between 0.0 (uncertain) and 1.0 (certain)
  3. A prediction: FRAUD or LEGITIMATE
  4. Brief reasoning explaining your assessment

  ## Risk Indicators

  ### Strong Fraud Signals (weight heavily):
  - device_count >= 4 AND ip_count >= 6 -> risk +0.25
  - std_tx_value > avg_tx_value * 1.5 -> risk +0.15 (high variance)
  - total_transactions > 15 with device_count >= 3 -> risk +0.10
  - avg_tx_value > $400 with std_tx_value > $150 -> risk +0.10

  ### Moderate Signals:
  - device_count 3-4 OR ip_count 4-6 -> risk +0.10
  - Multiple merchants (>3) with high value variance -> risk +0.05

  ### Legitimate Signals (weight against fraud):
  - device_count == 1 AND ip_count <= 2 -> risk -0.15
  - Consistent transaction values (std < avg * 0.5) -> risk -0.10
  - Single merchant focus with stable patterns -> risk -0.05

  ## Scoring Guidelines

  Start at baseline: risk_score = 0.35

  Apply modifiers based on signals above. Final score range:
  - 0.0-0.30: Very low risk (strong legitimate signals)
  - 0.30-0.50: Low risk (normal behavior)
  - 0.50-0.60: Medium risk (some concerning patterns)
  - 0.60-0.75: High risk (multiple fraud signals)
  - 0.75-1.0: Very high risk (strong fraud signals)

  ## Decision Threshold
  - risk_score >= 0.60 -> predict FRAUD
  - risk_score < 0.60 -> predict LEGITIMATE

  AIM FOR BALANCE: Flag clear fraud signals, but don't over-flag normal users.

# Main fraud analysis prompt - v6 (balanced)
fraud_analysis_prompt: |
  Predict future fraud risk for the following entity using behavioral patterns.

  ## Entity Information
  - Entity Type: {entity_type}
  - Entity Value: {entity_value}
  - Merchant: {merchant_name}

  ## Transaction Summary (Feature Period)
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Average Transaction Value: ${avg_tx_value}
  - Transaction Value Std Dev: ${std_tx_value}
  - Date Range: {date_range}

  ## Device & Network Patterns
  - Unique Devices: {unique_devices}
  - Unique IPs: {unique_ips}
  - Unique Merchants: {unique_merchants}

  ## Risk Assessment Framework:

  STRONG FRAUD SIGNALS:
  - device_count >= 4 AND ip_count >= 6 = major red flag
  - High value variance (std > 1.5x avg) = testing card limits
  - Many transactions + multiple devices = suspicious velocity

  NORMAL BEHAVIOR:
  - 1-2 devices and 1-3 IPs = typical legitimate user
  - Consistent transaction values = predictable spending
  - Single merchant = loyal customer

  EVALUATE HOLISTICALLY: Look for combinations of signals, not just individual flags.

  Provide your fraud prediction in the following JSON format:
  ```json
  {{
    "risk_score": <float 0.0-1.0>,
    "confidence": <float 0.0-1.0>,
    "prediction": "<FRAUD|LEGITIMATE>",
    "reasoning": "<brief explanation>",
    "key_indicators": [<list of behavioral indicators found>],
    "risk_factors": {{
      "device_risk": <float 0.0-1.0>,
      "velocity_risk": <float 0.0-1.0>,
      "value_risk": <float 0.0-1.0>,
      "pattern_risk": <float 0.0-1.0>
    }}
  }}
  ```

# Template for fraud indicators - v6: Same as v4/v5 (behavioral only)
fraud_indicators_template: |
  ## Behavioral Risk Indicators (No fraud history available)
  - Total Transactions: {total_transactions}
  - Total GMV: ${total_gmv}
  - Average Transaction Value: ${avg_tx_value}
  - Transaction Value Std Dev: ${std_tx_value}
  - Unique Devices: {device_count}
  - Unique IPs: {ip_count}
  - Unique Merchants: {merchant_count}

# Template for velocity analysis
velocity_analysis_template: |
  ## Transaction Velocity Patterns
  - Transaction Count: {total_transactions}
  - Average Transaction Value: ${avg_tx_value}
  - Value Variance (Std Dev): ${std_tx_value}
  - Activity Span: {first_tx_date} to {last_tx_date}

# Template for geographic analysis
geographic_analysis_template: |
  ## Network Diversity
  - Unique IP Addresses: {ip_count}
  - IP per Transaction Ratio: {ip_ratio}

# Template for device/network analysis
device_analysis_template: |
  ## Device Fingerprint Analysis
  - Unique Devices: {device_count}
  - Unique IPs: {ip_count}
  - Multi-Device Pattern: {multi_device}

# Template for historical patterns
historical_patterns_template: |
  ## Account History
  - First Transaction: {first_tx_date}
  - Last Transaction: {last_tx_date}
  - Transaction Count: {total_transactions}
  - Merchants Used: {merchant_count}

# Batch analysis prompt
batch_analysis_prompt: |
  Predict future fraud risk for the following batch of {entity_count} entities.
  Use behavioral patterns only - you do NOT have fraud history information.

  {entities_data}

  Provide your analysis as a JSON array with one object per entity:
  ```json
  [
    {{
      "entity_id": "<entity identifier>",
      "risk_score": <float 0.0-1.0>,
      "confidence": <float 0.0-1.0>,
      "prediction": "<FRAUD|LEGITIMATE>",
      "reasoning": "<brief explanation>"
    }}
  ]
  ```

# Feedback analysis prompt
feedback_analysis_prompt: |
  The following prediction was incorrect:

  ## Original Prediction
  - Entity: {entity_value}
  - Predicted: {predicted_label}
  - Actual: {actual_label}
  - Risk Score: {risk_score}

  ## Entity Behavioral Data (Feature Period)
  {entity_data}

  ## Actual Outcome (Observation Period)
  - Committed Fraud: {committed_fraud}

  Analyze why this prediction was incorrect:
  ```json
  {{
    "error_type": "<false_positive|false_negative>",
    "likely_cause": "<explanation>",
    "missed_patterns": [<list of patterns that should have been weighted differently>],
    "suggested_adjustments": {{
      "behavioral_weights": {{<suggested weight adjustments>}},
      "threshold_adjustment": <suggested threshold change>
    }}
  }}
  ```
