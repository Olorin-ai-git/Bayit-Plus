<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Fraud Detection Strategy - v11 Balanced Scoring</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header {
            background: linear-gradient(135deg, var(--primary), #1d4ed8);
            color: white;
            padding: 3rem 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        header p { opacity: 0.9; font-size: 1.1rem; }
        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-top: 1rem;
            margin-right: 0.5rem;
        }
        .badge.new {
            background: rgba(255,255,255,0.9);
            color: var(--primary);
            font-weight: bold;
        }
        .section {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            font-size: 1.5rem;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--gray-200);
        }
        .section h3 {
            font-size: 1.1rem;
            color: var(--gray-800);
            margin: 1.5rem 0 1rem 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .stat-card {
            background: var(--gray-50);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .stat-card h4 { font-size: 0.75rem; color: var(--gray-700); text-transform: uppercase; margin-bottom: 0.25rem; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); }
        .stat-card .sub { font-size: 0.75rem; color: var(--gray-700); }
        .stat-card.fraud { border-left: 4px solid var(--danger); }
        .stat-card.secure { border-left: 4px solid var(--success); }
        .stat-card.neutral { border-left: 4px solid var(--primary); }
        .stat-card.warning { border-left: 4px solid var(--warning); }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }
        .code-block {
            background: var(--gray-900);
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 1rem 0;
            white-space: pre-wrap;
        }
        .signal-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .signal-table th, .signal-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .signal-table th { background: var(--gray-50); font-weight: 600; }
        .signal-table tr.fraud-signal { background: #fef2f2; }
        .signal-table tr.legit-signal { background: #f0fdf4; }
        .signal-table .weight { font-family: monospace; font-weight: 600; }
        .signal-table .weight.positive { color: var(--danger); }
        .signal-table .weight.negative { color: var(--success); }
        .alert-box {
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .alert-box.success { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .alert-box.info { background: #eff6ff; border: 1px solid #93c5fd; }
        .alert-box.warning { background: #fef3c7; border: 1px solid #fcd34d; }
        .alert-box h4 { margin-bottom: 0.75rem; }
        .alert-box.success h4 { color: var(--success); }
        .alert-box.info h4 { color: var(--primary); }
        .alert-box.warning h4 { color: var(--warning); }
        .data-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border: 1px solid var(--gray-200); }
        .data-table th { background: var(--gray-100); font-weight: 600; }
        .data-table tr:nth-child(even) { background: var(--gray-50); }
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--gray-700);
            font-size: 0.875rem;
        }
        .version-history {
            background: var(--gray-50);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        .version-history h4 { margin-bottom: 0.5rem; color: var(--gray-700); }
        .version-history ul { margin-left: 1.5rem; }
        .version-history li { margin: 0.25rem 0; }
        .feature-box {
            background: linear-gradient(135deg, #dbeafe, #ede9fe);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .feature-box code {
            background: rgba(0,0,0,0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>LLM Fraud Detection Strategy</h1>
            <p>v11 - Balanced Scoring with Neutral Baseline</p>
            <span class="badge new">NEW: v11</span>
            <span class="badge">Feature: 026-llm-training-pipeline</span>
            <span class="badge">December 2025</span>
        </header>

        <!-- SECTION 0: KEY INSIGHT -->
        <div class="section">
            <h2>Key Insight: Why Previous Versions Failed</h2>

            <div class="alert-box warning">
                <h4>The Core Problem</h4>
                <p>
                    Previous prompt versions used <strong>raw feature counts</strong> (device_count, ip_count) which have
                    too much overlap between fraud and legitimate users. Normal users commonly have 2-4 devices
                    and 3-8 IPs. Using these raw counts led to either:
                </p>
                <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                    <li><strong>v1-v5:</strong> Too conservative → 0% recall (all fraud missed)</li>
                    <li><strong>v8:</strong> Too aggressive → 70% recall but 0.8% precision (1492 false positives!)</li>
                    <li><strong>v6:</strong> Balanced but still 4.27% precision with 40.91% recall</li>
                </ul>
            </div>

            <div class="version-history">
                <h4>Training Results History</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Version</th>
                            <th>Threshold</th>
                            <th>Recall</th>
                            <th>Precision</th>
                            <th>F1 Score</th>
                            <th>Issue</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>v1</td>
                            <td>0.50</td>
                            <td style="color: var(--danger);">0%</td>
                            <td>-</td>
                            <td>0%</td>
                            <td>All FN - too conservative</td>
                        </tr>
                        <tr>
                            <td>v6</td>
                            <td>0.60</td>
                            <td style="color: var(--warning);">40.91%</td>
                            <td style="color: var(--warning);">4.27%</td>
                            <td>7.73%</td>
                            <td>Best balance so far</td>
                        </tr>
                        <tr>
                            <td>v7</td>
                            <td>0.63</td>
                            <td style="color: var(--danger);">5.26%</td>
                            <td style="color: var(--danger);">1.32%</td>
                            <td>2.11%</td>
                            <td>Threshold too high</td>
                        </tr>
                        <tr>
                            <td>v8</td>
                            <td>0.50</td>
                            <td style="color: var(--success);">70.59%</td>
                            <td style="color: var(--danger);">0.80%</td>
                            <td>1.58%</td>
                            <td>1492 FP - too aggressive</td>
                        </tr>
                        <tr>
                            <td>v10</td>
                            <td>0.65</td>
                            <td style="color: var(--danger);">0%</td>
                            <td>-</td>
                            <td>0%</td>
                            <td>Baseline too low, all scores below threshold</td>
                        </tr>
                        <tr style="background: #dbeafe; font-weight: bold;">
                            <td>v11</td>
                            <td>0.55</td>
                            <td>Target: 50%+</td>
                            <td>Target: 10%+</td>
                            <td>Target: 15%+</td>
                            <td>Neutral baseline (0.50), balanced adjustments</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION 1: v11 STRATEGY -->
        <div class="section">
            <h2>1. v11 Strategy: Balanced Scoring with Neutral Baseline</h2>

            <div class="alert-box info">
                <h4>The v11 Approach</h4>
                <p>
                    v10 failed because its baseline (0.30) combined with heavy legitimate deductions pushed all scores
                    below 0.30. v11 fixes this with a <strong>neutral baseline of 0.50</strong>, allowing scores to go
                    both up (fraud) and down (legitimate) from the middle. The threshold is set at <strong>0.55</strong>
                    so that any entity with even ONE clear fraud signal gets flagged.
                </p>
            </div>

            <h3>Derived Features (More Discriminative)</h3>
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="feature-box">
                    <strong>device_per_tx</strong> = device_count / total_transactions<br>
                    <code>Normal: 0.1-0.5</code> | <code>Suspicious: >0.8</code><br>
                    <em style="font-size: 0.875rem; color: var(--gray-700);">High ratio = new device almost every transaction</em>
                </div>
                <div class="feature-box">
                    <strong>ip_per_tx</strong> = ip_count / total_transactions<br>
                    <code>Normal: 0.2-0.6</code> | <code>Suspicious: >1.0</code><br>
                    <em style="font-size: 0.875rem; color: var(--gray-700);">High ratio = multiple IPs per transaction</em>
                </div>
                <div class="feature-box">
                    <strong>cv_tx_value</strong> = std_tx_value / avg_tx_value<br>
                    <code>Normal: 0.3-1.5</code> | <code>Suspicious: >2.0</code><br>
                    <em style="font-size: 0.875rem; color: var(--gray-700);">High CV = extreme value variability (testing limits)</em>
                </div>
                <div class="feature-box">
                    <strong>gmv_per_tx</strong> = total_gmv / total_transactions<br>
                    <code>Cross-check with avg_tx_value</code><br>
                    <em style="font-size: 0.875rem; color: var(--gray-700);">Consistency check for value patterns</em>
                </div>
            </div>

            <h3>Scoring Algorithm (v11)</h3>
            <div class="code-block">
# Start at NEUTRAL baseline (middle of range)
risk_score = 0.50

# Add risk for FRAUD signals
if device_count >= 5 and ip_count >= 8:
    risk_score += 0.25      # Fraud ring pattern
if std_tx_value > avg_tx_value * 2:
    risk_score += 0.20      # Testing card limits
if device_count >= 4 and total_transactions < 10:
    risk_score += 0.15      # Suspicious new account
if ip_count >= 6 and total_transactions < 10:
    risk_score += 0.15      # IP hopping
if avg_tx_value > 500 and std_tx_value > avg_tx_value:
    risk_score += 0.10      # High-value fraud attempt

# Subtract risk for LEGITIMATE signals (smaller deductions)
if device_count == 1 and ip_count <= 2:
    risk_score -= 0.10      # Stable user
if total_transactions > 20 and device_count <= 2:
    risk_score -= 0.10      # Loyal customer
if std_tx_value < avg_tx_value * 0.3:
    risk_score -= 0.05      # Very consistent spending
if merchant_count == 1:
    risk_score -= 0.05      # Single merchant focus

# Final decision (threshold at 0.55)
if risk_score >= 0.55:
    prediction = "FRAUD"
else:
    prediction = "LEGITIMATE"</div>
        </div>

        <!-- SECTION 2: SIGNAL WEIGHTS -->
        <div class="section">
            <h2>2. Signal Weights</h2>

            <h3>Fraud Signals (Anomalies Required)</h3>
            <table class="signal-table">
                <thead>
                    <tr>
                        <th>Signal</th>
                        <th>Condition</th>
                        <th>Weight</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="fraud-signal">
                        <td><strong>Multi-Identity Abuse</strong></td>
                        <td>device_per_tx > 0.8 AND ip_per_tx > 1.0</td>
                        <td class="weight positive">+0.25</td>
                        <td>New device/IP almost every transaction = fraud ring</td>
                    </tr>
                    <tr class="fraud-signal">
                        <td><strong>Card Limit Testing</strong></td>
                        <td>cv_tx_value > 2.0 AND tx_count > 10</td>
                        <td class="weight positive">+0.20</td>
                        <td>Extreme value variance with many transactions</td>
                    </tr>
                    <tr class="fraud-signal">
                        <td><strong>Absolute Device Threshold</strong></td>
                        <td>device_count >= 6 AND ip_count >= 12</td>
                        <td class="weight positive">+0.20</td>
                        <td>Clear fraud ring signal regardless of tx count</td>
                    </tr>
                    <tr class="fraud-signal">
                        <td><strong>ATO Risk</strong></td>
                        <td>High GMV + single device + cv > 2</td>
                        <td class="weight positive">+0.15</td>
                        <td>Account takeover pattern</td>
                    </tr>
                </tbody>
            </table>

            <h3>Legitimate Signals (Risk Reduction)</h3>
            <table class="signal-table">
                <thead>
                    <tr>
                        <th>Signal</th>
                        <th>Condition</th>
                        <th>Weight</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="legit-signal">
                        <td><strong>Consistent User</strong></td>
                        <td>device_per_tx < 0.3 AND ip_per_tx < 0.5</td>
                        <td class="weight negative">-0.15</td>
                        <td>Few devices/IPs relative to transactions</td>
                    </tr>
                    <tr class="legit-signal">
                        <td><strong>Stable Spending</strong></td>
                        <td>cv_tx_value < 0.5</td>
                        <td class="weight negative">-0.10</td>
                        <td>Predictable transaction values</td>
                    </tr>
                    <tr class="legit-signal">
                        <td><strong>Loyal Customer</strong></td>
                        <td>tx_count > 20 AND device_count <= 2</td>
                        <td class="weight negative">-0.10</td>
                        <td>Long history with minimal device change</td>
                    </tr>
                    <tr class="legit-signal">
                        <td><strong>Single Merchant Focus</strong></td>
                        <td>merchant_count = 1</td>
                        <td class="weight negative">-0.05</td>
                        <td>Established relationship</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- SECTION 3: WHY THIS WORKS -->
        <div class="section">
            <h2>3. Why v10 Should Improve Precision</h2>

            <div class="two-col">
                <div class="alert-box info" style="margin: 0;">
                    <h4>Problem: Raw Counts Overlap</h4>
                    <ul style="margin-left: 1rem;">
                        <li>Normal user: 2-4 devices, 3-8 IPs</li>
                        <li>Fraudster: 3-6 devices, 5-15 IPs</li>
                        <li>Overlap makes discrimination hard</li>
                        <li>v8 flagged anyone with 3+ devices = massive FP</li>
                    </ul>
                </div>
                <div class="alert-box success" style="margin: 0;">
                    <h4>Solution: Ratios Discriminate Better</h4>
                    <ul style="margin-left: 1rem;">
                        <li>Normal: 3 devices / 20 tx = 0.15 ratio</li>
                        <li>Fraud: 5 devices / 6 tx = 0.83 ratio</li>
                        <li>Clear separation in ratio space</li>
                        <li>Requires MULTIPLE anomalies = fewer FP</li>
                    </ul>
                </div>
            </div>

            <h3>Statistical Foundation</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Derived Feature</th>
                        <th>Normal Range (95%)</th>
                        <th>Anomaly Threshold (Top 2%)</th>
                        <th>Why It Works</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>device_per_tx</td>
                        <td>0.05 - 0.70</td>
                        <td>> 0.80</td>
                        <td>Fraudsters switch devices frequently to evade detection</td>
                    </tr>
                    <tr>
                        <td>ip_per_tx</td>
                        <td>0.10 - 0.80</td>
                        <td>> 1.00</td>
                        <td>VPN hopping / proxy rotation indicates fraud</td>
                    </tr>
                    <tr>
                        <td>cv_tx_value</td>
                        <td>0.0 - 1.5</td>
                        <td>> 2.00</td>
                        <td>Extreme variance = testing card limits</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- SECTION 4: PRODUCTION CONFIGURATION -->
        <div class="section">
            <h2>4. Production Configuration (v11)</h2>

            <div class="code-block">
# Environment Variables for v11 Production

# Enable LLM reasoning with v11 prompt
LLM_REASONING_ENABLED=true
LLM_PROMPT_ACTIVE_VERSION=v11

# Balanced threshold (neutral baseline + 0.05)
LLM_FRAUD_THRESHOLD=0.55

# Temporal Holdout Settings (unchanged)
LLM_TEMPORAL_HOLDOUT_ENABLED=true
LLM_FEATURE_PERIOD_MONTHS=6
LLM_OBSERVATION_PERIOD_MONTHS=6
LLM_MIN_TX_IN_FEATURE_PERIOD=2

# LLM Provider
LLM_TRAINING_PRIMARY_PROVIDER=claude
LLM_TRAINING_MODEL_ID=claude-3-5-sonnet-20241022

# Batch Processing
LLM_TRAINING_BATCH_SIZE=100
LLM_TRAINING_MAX_CONCURRENT=5</div>

            <h3>Key Configuration Files</h3>
            <table class="signal-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>config/llm_training_config.yaml</code></td>
                        <td>Main configuration - threshold 0.55, active version v11</td>
                    </tr>
                    <tr>
                        <td><code>config/prompts/fraud_detection_v11.yaml</code></td>
                        <td>Balanced scoring with neutral baseline (0.50)</td>
                    </tr>
                    <tr>
                        <td><code>app/service/training/llm_reasoning_engine.py</code></td>
                        <td>Core LLM scoring engine</td>
                    </tr>
                    <tr>
                        <td><code>scripts/run_llm_training.py</code></td>
                        <td>CLI script to run training evaluation</td>
                    </tr>
                </tbody>
            </table>

            <h3>Run Training with v11</h3>
            <div class="code-block">
# Run training with v11 prompt and balanced threshold
LLM_REASONING_ENABLED=true \
LLM_PROMPT_ACTIVE_VERSION=v11 \
LLM_FRAUD_THRESHOLD=0.55 \
poetry run python scripts/run_llm_training.py</div>
        </div>

        <!-- SECTION 5: EXPECTED OUTCOMES -->
        <div class="section">
            <h2>5. Expected Outcomes</h2>

            <div class="stats-grid">
                <div class="stat-card neutral">
                    <h4>Target Recall</h4>
                    <div class="value">50%+</div>
                    <div class="sub">Catch half of fraud</div>
                </div>
                <div class="stat-card secure">
                    <h4>Target Precision</h4>
                    <div class="value">10%+</div>
                    <div class="sub">2x improvement over v6</div>
                </div>
                <div class="stat-card neutral">
                    <h4>Target F1</h4>
                    <div class="value">15%+</div>
                    <div class="sub">Better balance</div>
                </div>
                <div class="stat-card warning">
                    <h4>Expected FP Reduction</h4>
                    <div class="value">50%+</div>
                    <div class="sub">Fewer false alarms</div>
                </div>
            </div>

            <div class="alert-box info">
                <h4>Next Steps</h4>
                <ul style="margin-left: 1rem;">
                    <li>Run v10 training evaluation and compare metrics</li>
                    <li>If precision improves but recall drops, adjust anomaly thresholds</li>
                    <li>Consider adding more derived features (velocity ratios, time-based patterns)</li>
                    <li>Implement classical model (logistic regression) as hybrid scorer fallback</li>
                </ul>
            </div>
        </div>

        <footer>
            <p>Generated: December 10, 2025 | Olorin Fraud Detection Platform | Feature: 026-llm-training-pipeline</p>
            <p style="margin-top: 0.5rem; font-style: italic;">
                LLM-based fraud detection using Claude 3.5 Sonnet with statistical anomaly approach
            </p>
        </footer>
    </div>
</body>
</html>
